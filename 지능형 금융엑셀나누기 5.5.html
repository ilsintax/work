<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>지능형 금융 데이터 변환기 v5.5 (미리보기 확장)</title>
  <h1 class="text-xs text-right">made by 세무법인일신 (가급적 사이트 배포하지 마시길 부탁드립니다)</h1>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .preview-table { border-collapse: collapse; width: 100%; font-size: .8rem; }
    .preview-table th, .preview-table td {
      border: 1px solid #e2e8f0; padding: .375rem .5rem; text-align: left;
      white-space: nowrap; min-width: 20px;
    }
    .preview-table th { background-color: #f8fafc; font-weight: 600; }
    .selectable:hover { background-color: #f0f9ff; cursor: pointer; }
    .highlighted { background-color: #bae6fd !important; }
    /* 단계별 하이라이트 색상 */
    .highlight-p3-tradeTypeCol { background-color: #a7f3d0 !important; }
    .highlight-p3-stockNameCol { background-color: #fde68a !important; }
    .highlight-p3-stockQtyCol { background-color: #fecaca !important; }
    .highlight-p3-unitPriceCol { background-color: #d8b4fe !important; }
    .highlight-p3-stockBalanceCol { background-color: #bfdbfe !important; }
    .highlight-p3-additionalCol1, .highlight-p3-additionalCol2 { background-color: #d1d5db !important; }
    
    .drop-zone { min-height: 80px; border: 2px dashed #cbd5e1; background-color: #f8fafc; transition: all 0.2s; }
    .drop-zone.drag-over { background-color: #e0f2fe; border-color: #3b82f6; }
    .draggable-item { cursor: grab; }
    .draggable-item:active { cursor: grabbing; }
    .sidebar-btn { transition: all 0.2s; }
    .sidebar-btn.active { background-color: #eef2ff; color: #4338ca; font-weight: 600; border-right: 3px solid #4f46e5;}
    .sidebar-btn.completed::after { content: '✔'; margin-left: auto; color: #16a34a; font-weight: bold; }
    .sidebar-btn:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f9fafb; }
    .path-nav-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
    .path-nav-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; font-weight: 600; }
    .path-nav-btn.completed { color: #16a34a; }
    .selection-box { cursor: pointer; transition: all 0.2s; }
    .selection-box.selecting { border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
    .modal {
        transition: opacity 0.25s ease;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div id="app" class="flex h-screen">
    <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 p-4 space-y-2 hidden">
        <!-- JS 렌더링 영역 -->
    </aside>
    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div id="main-content" class="max-w-6xl mx-auto">
            <!-- JS 렌더링 영역 -->
        </div>
    </main>
  </div>

  <!-- 재분류 확인 모달 -->
  <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
      <h2 id="modal-title" class="text-xl font-bold mb-4 text-slate-800"></h2>
      <p id="modal-message" class="text-slate-600 mb-6"></p>
      <div id="modal-buttons" class="flex justify-end space-x-3">
        <!-- 버튼 동적 생성 -->
      </div>
    </div>
  </div>

  <script>
    /******************************************************************************
     * 지능형 금융 데이터 변환기 v5.5 (미리보기 확장)
     ******************************************************************************/
    
    // --- 1. 상태 관리 (State Management) ---
    const AppState = {
        _state: {}, _listeners: [],
        init() {
            this._state = {
                currentPhase: 'upload', fileName: null, history: [],
                phases: {
                    upload: { isComplete: false, rawData: [] },
                    phase1: { isComplete: false, config: { headerRows: [] }, output: null },
                    phase2: { isComplete: false, config: { splitCol: null, groups: [{name: '그룹 1', values: []}] }, output: [] },
                    phase3: { isComplete: false, config: {}, output: [], activePath: 0, selectingKey: null },
                    phase4: { isComplete: false, config: {}, output: [], removed: [], activePath: 0 },
                    phase5: { isComplete: false, config: {}, output: [], activePath: 0, selectingKey: null },
                    download: { isComplete: false }
                }
            };
            const { history, ...initialState } = this._state;
            this._state.history = [initialState];
        },
        getState() { return this._state; },
        setState(updater) {
            const oldState = JSON.parse(JSON.stringify(this._state));
            const newState = typeof updater === 'function' ? updater(oldState) : updater;
            const oldHistory = oldState.history || [];
            const { history: _removed, ...stateToSave } = oldState;
            const newHistory = [...oldHistory, stateToSave];
            if (newHistory.length > 20) newHistory.shift();
            this._state = { ...newState, history: newHistory };
            console.log("State Updated:", this._state);
            this.notify();
        },
        subscribe(listener) { this._listeners.push(listener); },
        notify() { this._listeners.forEach(listener => listener()); },
        undo() {
            const history = this._state.history || [];
            if (history.length < 2) { 
                UIRenderer.showModal('알림', '더 이상 되돌릴 작업이 없습니다.', [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                return;
            }
            const newHistory = history.slice(0, history.length - 1);
            const previousState = newHistory[newHistory.length - 1];
            this._state = { ...previousState, history: newHistory };
            this.notify();
        }
    };

    // --- 2. UI 렌더링 (UI Rendering) ---
    const UIRenderer = {
        init() {
            this.sidebarEl = document.getElementById('sidebar');
            this.mainContentEl = document.getElementById('main-content');
            this.modalEl = document.getElementById('modal');
            this.modalTitleEl = document.getElementById('modal-title');
            this.modalMessageEl = document.getElementById('modal-message');
            this.modalButtonsEl = document.getElementById('modal-buttons');
            AppState.subscribe(() => this.render());
        },
        render() {
            const state = AppState.getState();
            if (state.currentPhase === 'upload') {
                this.sidebarEl.classList.add('hidden');
                this.mainContentEl.innerHTML = this.renderUploadView();
            } else {
                this.sidebarEl.classList.remove('hidden');
                this.sidebarEl.innerHTML = this.renderSidebar(state);
                this.mainContentEl.innerHTML = this.renderPhaseView(state);
            }
            this.attachEventListeners();
        },
        showModal(title, message, buttons) {
            this.modalTitleEl.textContent = title;
            this.modalMessageEl.innerHTML = message;
            this.modalButtonsEl.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `px-4 py-2 rounded-md font-semibold ${btnInfo.className}`;
                button.onclick = btnInfo.onClick;
                this.modalButtonsEl.appendChild(button);
            });
            this.modalEl.classList.remove('hidden');
        },
        hideModal() {
            this.modalEl.classList.add('hidden');
        },
        renderUploadView() {
            return `<header class="text-center mb-8"><h1 class="text-4xl font-bold text-slate-900">지능형 금융 데이터 변환기</h1><p class="text-slate-600 mt-2">복잡한 엑셀 작업을 몇 번의 클릭으로 자동화하세요.</p></header><label for="file-input" class="flex flex-col items-center justify-center h-64 border-2 border-dashed rounded-lg bg-white cursor-pointer hover:bg-slate-100 transition"><svg class="w-12 h-12 mb-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><span class="text-slate-600 font-medium text-lg">클릭하여 XLSX/XLS 파일 업로드</span><input id="file-input" type="file" accept=".xlsx,.xls" class="hidden"/></label>`;
        },
        renderSidebar(state) {
            const phases = [ { id: 'phase1', name: '1. 행 병합' }, { id: 'phase2', name: '2. 통화별 분리' }, { id: 'phase3', name: '3. 적요 생성' }, { id: 'phase4', name: '4. 항목 제거' }, { id: 'phase5', name: '5. 최종 변환' }, { id: 'download', name: '결과 리포트' }, ];
            let buttonsHTML = phases.map(phase => {
                const phaseState = state.phases[phase.id];
                const isEnabled = phase.id === 'phase1' || state.phases[this.getPrevPhase(phase.id)]?.isComplete;
                return `<button data-phase="${phase.id}" class="sidebar-btn w-full flex items-center text-left px-3 py-2 rounded-md text-slate-700 hover:bg-slate-100 ${state.currentPhase === phase.id ? 'active' : ''} ${phaseState?.isComplete ? 'completed' : ''}" ${!isEnabled ? 'disabled' : ''}>${phase.name}</button>`;
            }).join('');
            return `<div class="flex-1"><h2 class="text-lg font-bold text-slate-800 px-2 mb-4">변환 단계</h2><div class="space-y-1">${buttonsHTML}</div></div><div class="pt-4 border-t"><button id="undo-btn" class="w-full text-sm px-3 py-2 bg-slate-200 rounded-md hover:bg-slate-300">실행 취소 (Undo)</button><button id="reset-btn" class="w-full text-sm px-3 py-2 mt-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200">처음부터 다시하기</button></div>`;
        },
        renderPhaseView(state) {
            switch(state.currentPhase) {
                case 'phase1': return this.renderPhase1View(state);
                case 'phase2': return this.renderPhase2View(state);
                case 'phase3': return this.renderPhase3View(state);
                case 'phase4': return this.renderPhase4View(state);
                case 'phase5': return this.renderPhase5View(state);
                case 'download': return this.renderDownloadView(state);
                default: return `<div class="text-center py-10"><h1 class="text-2xl font-bold">작업을 시작해주세요.</h1><p class="text-slate-600 mt-2">왼쪽 사이드바에서 단계를 선택하여 변환을 시작하세요.</p></div>`;
            }
        },
        renderPhase1View(state) { const { rawData } = state.phases.upload; const { headerRows } = state.phases.phase1.config; let tableHTML = this.generateTableHTML(rawData.slice(0, 20), { selectable: 'row', selectedRows: headerRows }); return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">1단계: 행 병합</h1><p class="text-slate-600 mt-2">반복되는 제목 행을 모두 클릭하세요.</p></header><div class="flex items-center space-x-3"><button id="process-phase1-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-300" ${headerRows.length === 0 ? 'disabled' : ''}>실행 & 다음 단계로</button><button id="reset-phase1-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">선택 초기화</button></div><div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div></div>`; },
        renderPhase2View(state) {
            const data = state.phases.phase1.output; if (!data) return `<p>1단계 작업을 먼저 완료해주세요.</p>`;
            const { splitCol, groups } = state.phases.phase2.config;
            let tableHTML = this.generateTableHTML(data.slice(0, 10), { selectable: 'col', selectedCols: splitCol !== null ? [splitCol] : [] });
            let contentHTML = `<p class="text-slate-600 mt-2">데이터를 통화(KRW, USD 등)에 따라 분리할 기준 열을 선택하세요.<br>모든 거래가 단일 통화인 경우, 아무것도 선택하지 않고 다음 단계로 진행하세요.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div>`;
            if (splitCol !== null) {
                const uniqueValues = [...new Set(data.slice(1).map(row => row[splitCol]).filter(Boolean))];
                const groupedValues = groups.flatMap(g => g.values);
                const sourceItems = uniqueValues.filter(v => !groupedValues.includes(v));
                const groupsHTML = groups.map((group, index) => `<div class="p-4 rounded-lg bg-white border"><input type="text" value="${group.name}" data-group-index="${index}" class="group-name-input font-semibold mb-2 border-b-2 w-full p-1" placeholder="그룹 이름 입력"><div id="drop-zone-${index}" class="drop-zone p-2 rounded flex flex-wrap gap-2" data-zone-id="${index}">${group.values.map(val => `<div class="draggable-item bg-blue-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div>`).join('');
                contentHTML += `<p class="text-slate-600 mt-4 font-semibold">선택한 열의 고유값을 그룹으로 묶어주세요.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">고유값 (드래그)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="space-y-4">${groupsHTML}<button id="add-group-btn" class="w-full px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">+ 그룹 추가</button></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">2단계: 통화별 분리</h1></header>${contentHTML}<div class="flex items-center space-x-3 mt-4"><button id="process-phase2-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">실행 & 다음 단계로</button></div></div>`;
        },
        renderPhase3View(state) {
            const dataSets = state.phases.phase2.output; if (!dataSets || dataSets.length === 0) return `<p>2단계 작업을 먼저 완료해주세요.</p>`;
            const { activePath, selectingKey } = state.phases.phase3;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>데이터를 불러오는 중 오류가 발생했습니다. 2단계로 돌아가 다시 시도해주세요.</p>`;
            const config = state.phases.phase3.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${state.phases.phase3.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            const prompts = [ { key: 'tradeTypeCol', text: '거래종류' }, { key: 'stockNameCol', text: '종목' }, { key: 'stockQtyCol', text: '거래주식수' }, { key: 'unitPriceCol', text: '단가' }, { key: 'stockBalanceCol', text: '주식잔고' }, { key: 'additionalCol1', text: '추가적요 1' }, { key: 'additionalCol2', text: '추가적요 2' } ];
            let selectionUI = prompts.map(p => { const isSelecting = selectingKey === p.key; const valueText = config[p.key] !== undefined && currentData[0][config[p.key]] ? `[${config[p.key] + 1}열] ${currentData[0][config[p.key]]}` : '미선택'; return `<div data-key="${p.key}" class="selection-box p-2 border rounded-md ${isSelecting ? 'selecting' : ''}"><label class="font-medium text-sm pointer-events-none">${p.text}: </label><span class="font-bold text-indigo-600 pointer-events-none">${valueText}</span></div>`; }).join('');
            let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col', highlightMapping: { 'highlight-p3-tradeTypeCol': config.tradeTypeCol, 'highlight-p3-stockNameCol': config.stockNameCol, 'highlight-p3-stockQtyCol': config.stockQtyCol, 'highlight-p3-unitPriceCol': config.unitPriceCol, 'highlight-p3-stockBalanceCol': config.stockBalanceCol, 'highlight-p3-additionalCol1': config.additionalCol1, 'highlight-p3-additionalCol2': config.additionalCol2, } });
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">3단계: 주식 적요 생성</h1></header><div class="flex border-b">${pathNav}</div><p class="text-slate-600 mt-2">아래 항목을 클릭한 뒤, 해당하는 열을 테이블에서 선택해주세요.</p><div class="grid grid-cols-2 md:grid-cols-4 gap-2">${selectionUI}</div><div class="flex items-center space-x-3 mt-4"><button id="process-phase3-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">현재 통화 적용 & 다음으로</button><button id="reset-phase3-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">선택 초기화</button></div><div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div></div>`;
        },
        renderPhase4View(state) {
            const dataSets = state.phases.phase3.output; if (!dataSets || dataSets.length === 0) return `<p>3단계 작업을 먼저 완료해주세요.</p>`;
            const { activePath } = state.phases.phase4;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>데이터를 불러오는 중 오류가 발생했습니다. 3단계로 돌아가 다시 시도해주세요.</p>`;
            const config = state.phases.phase4.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${state.phases.phase4.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            let contentHTML;
            if (config.tradeTypeCol === undefined) {
                let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col' });
                contentHTML = `<p class="text-slate-600 mt-2">제거할 항목의 기준이 될 '거래종류' 열을 선택해주세요.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div>`;
            } else {
                const uniqueValues = [...new Set(currentData.slice(1).map(row => row[config.tradeTypeCol]).filter(Boolean))];
                const itemsInZone = config.valuesToRemove || [];
                const sourceItems = uniqueValues.filter(v => !itemsInZone.includes(v));
                contentHTML = `<p class="text-slate-600 mt-2">입출금과 관련 없는 거래 종류를 아래 '제거할 항목' 영역으로 드래그 앤 드롭하세요.</p>
                <div class="text-sm text-red-500 mt-2 p-3 bg-slate-100 rounded-md">
                <p class="font-semibold">설명:</p>
                <p>*미래에셋의 경우 '주식매도 입금'은 제거할 항목으로 분류해야 합니다.</p>
                <p>*미래에셋의 경우 '주식매도 출고'는 제거할 항목으로 분류하지 말아주세요.</p>
                <p>*'외화주식매도 입금'도 동일합니다..</p>
                <br><br><br><br></div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">전체 거래 종류 (드래그)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-red-600">제거할 항목 (드롭)</h3><div id="drop-zone-0" class="drop-zone p-2 rounded flex flex-wrap gap-2">${itemsInZone.map(val => `<div class="draggable-item bg-red-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">4단계: 불필요 항목 제거</h1></header><div class="flex border-b">${pathNav}</div>${contentHTML}<div class="flex items-center space-x-3 mt-4"><button id="process-phase4-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">현재 통화 적용 & 다음으로</button><button id="reset-phase4-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">선택 초기화</button></div></div>`;
        },
        renderPhase5View(state) {
            const dataSets = state.phases.phase4.output; if (!dataSets || dataSets.length === 0) return `<p>4단계 작업을 먼저 완료해주세요.</p>`;
            const { activePath, selectingKey } = state.phases.phase5;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>데이터를 불러오는 중 오류가 발생했습니다. 4단계로 돌아가 다시 시도해주세요.</p>`;
            const config = state.phases.phase5.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${state.phases.phase5.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            const prompts = [ { key: 'dateCol', text: '일자' }, { key: 'amountCol', text: '거래금액' }, { key: 'balanceCol', text: '예수금잔액' }, { key: 'tradeTypeCol', text: '거래종류' }, { key: 'jukyoCol', text: '적요(3단계 결과)' }, { key: 'feeCol', text: '수수료' }, { key: 'taxCol', text: '제세금' } ];
            let selectionUI = prompts.map(p => { const isSelecting = selectingKey === p.key; const valueText = config[p.key] !== undefined && currentData.length > 0 && currentData[0][config[p.key]] ? `[${config[p.key] + 1}열] ${currentData[0][config[p.key]]}` : '미선택'; return `<div data-key="${p.key}" class="selection-box p-2 border rounded-md ${isSelecting ? 'selecting' : ''}"><label class="font-medium text-sm pointer-events-none">${p.text}: </label><span class="font-bold text-indigo-600 pointer-events-none">${valueText}</span></div>`; }).join('');
            let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col' });
            let dragDropUI = '';
            if (config.tradeTypeCol !== undefined) {
                const uniqueValues = [...new Set(currentData.slice(1).map(row => row[config.tradeTypeCol]).filter(Boolean))];
                const deposits = config.depositTypes || [];
                const withdrawals = config.withdrawalTypes || [];
                const sourceItems = uniqueValues.filter(v => !deposits.includes(v) && !withdrawals.includes(v));
                dragDropUI = `<div class="flex items-center space-x-4"><p class="text-slate-600 font-semibold">거래 종류를 '입금'과 '출금'으로 분류해주세요.</p><button id="auto-classify-btn" class="px-3 py-1 bg-yellow-400 text-yellow-900 rounded-md hover:bg-yellow-500 text-sm font-bold">✨ 잔액 기준으로 자동 분류</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">거래 종류 (드래그)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-blue-600">입금 항목</h3><div id="drop-zone-deposit" class="drop-zone p-2 rounded flex flex-wrap gap-2">${deposits.map(val => `<div class="draggable-item bg-blue-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-red-600">출금 항목</h3><div id="drop-zone-withdrawal" class="drop-zone p-2 rounded flex flex-wrap gap-2">${withdrawals.map(val => `<div class="draggable-item bg-red-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">5단계: 최종 변환</h1></header><div class="flex border-b">${pathNav}</div><p class="text-slate-600 mt-2">최종 변환에 필요한 열들을 클릭하여 선택해주세요.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2">${selectionUI}</div><div><label class="font-medium text-sm">기초가액: </label><input id="base-amount-input" type="number" value="${config.baseAmount || 0}" class="p-2 border rounded-md"></div><div class="mt-4 space-y-4">${dragDropUI}</div><div class="flex items-center space-x-3 mt-4"><button id="process-phase5-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">현재 통화 최종 변환 & 다음으로</button><button id="reset-phase5-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">선택 초기화</button></div></div>`;
        },
        renderDownloadView(state) {
            const configs = state.phases.phase5.config;
            const dataSets = state.phases.phase2.output;
            const hasAnyWarning = Object.values(configs).some(c => c && c.status === 'WARNING');
            const allPathsProcessed = dataSets.every((_, index) => configs[index]?.isComplete);

            if (!allPathsProcessed) {
                return `<div class="text-center py-10"><h1 class="text-2xl font-bold">아직 처리되지 않은 통화가 있습니다.</h1><p class="text-slate-600 mt-2">5단계 변환을 모두 완료해주세요.</p></div>`;
            }

            if (!hasAnyWarning) {
                return `<div class="text-center py-10"><h1 class="text-4xl font-bold text-green-600">🎉 변환 완료!</h1><p class="text-slate-600 mt-4">모든 작업이 성공적으로 완료되었습니다. 아래 버튼을 클릭하여 최종 엑셀 파일을 다운로드하세요.</p><div class="mt-8"><button id="download-all-btn" class="px-8 py-4 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 text-lg">전체 엑셀 파일 다운로드</button></div></div>`;
            }

            let reportHtml = `
                <div class="space-y-6">
                    <header>
                        <h1 class="text-3xl font-bold text-slate-900">최종 리포트</h1>
                        <div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-r-lg">
                            <h2 class="font-bold">⚠️ 일부 통화에서 잔액 불일치가 발견되었습니다.</h2>
                            <p>잔액이 일치하는 것으로 확인된 시트만 개별적으로 다운로드하거나, 문제가 있는 통화를 수정하기 위해 4단계로 돌아갈 수 있습니다.</p>
                        </div>
                    </header>
                    <div class="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-3 font-semibold">통화명</th>
                                    <th class="p-3 font-semibold">상태</th>
                                    <th class="p-3 font-semibold text-right">액션</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            dataSets.forEach((set, index) => {
                const config = configs[index] || {};
                const status = config.status || 'PENDING';
                let statusBadge = '';
                let actionButtons = '';

                if (status === 'VALIDATED') {
                    statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-green-100 text-green-800">✔ 잔액 일치</span>`;
                    actionButtons = `<button data-download-single-index="${index}" class="download-single-btn px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600">시트 다운로드</button>`;
                } else if (status === 'WARNING') {
                    statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-red-100 text-red-800">❗ 잔액 불일치</span>`;
                    actionButtons = `
                        <button data-download-single-index="${index}" class="download-single-btn px-3 py-1 bg-slate-500 text-white text-sm rounded-md hover:bg-slate-600 mr-2">시트 다운로드</button>
                        <button data-fix-index="${index}" class="fix-btn px-3 py-1 bg-yellow-500 text-white text-sm rounded-md hover:bg-yellow-600">수정하기</button>
                    `;
                } else {
                     statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800">... 작업 필요</span>`;
                }

                reportHtml += `
                    <tr class="border-b">
                        <td class="p-3 font-medium">${set.name}</td>
                        <td class="p-3">${statusBadge}</td>
                        <td class="p-3 text-right">${actionButtons}</td>
                    </tr>
                `;
            });
            
            reportHtml += `
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end space-x-4">
                       <button id="download-validated-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">검증된 시트만 전체 다운로드</button>
                       <button id="download-all-anyway-btn" class="px-6 py-3 bg-slate-500 text-white font-bold rounded-lg hover:bg-slate-600">경고 무시하고 전체 다운로드</button>
                    </div>
                </div>
            `;
            return reportHtml;
        },
        generateTableHTML(data, options = {}) {
            let html = '<table class="preview-table">';
            data.forEach((row, rowIndex) => {
                const rowClass = options.selectable === 'row' ? `selectable ${options.selectedRows?.includes(rowIndex) ? 'highlighted' : ''}` : '';
                html += `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                (row || []).forEach((cell, colIndex) => {
                    let colClass = options.selectable === 'col' ? 'selectable' : '';
                    if (options.selectedCols?.includes(colIndex)) colClass += ' highlighted';
                    if (options.highlightMapping) {
                        for (const [className, col] of Object.entries(options.highlightMapping)) {
                            if (col === colIndex) colClass += ` ${className}`;
                        }
                    }
                    html += `<td data-col-index="${colIndex}" class="${colClass}">${cell ?? ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            return html;
        },
        getPrevPhase(phaseId) {
            const order = ['upload', 'phase1', 'phase2', 'phase3', 'phase4', 'phase5', 'download'];
            const index = order.indexOf(phaseId);
            return index > 0 ? order[index - 1] : 'upload';
        },
        attachEventListeners() {
            const fileInput = document.getElementById('file-input');
            if (fileInput) fileInput.addEventListener('change', AppController.handleFile);
            document.querySelectorAll('.sidebar-btn').forEach(btn => btn.addEventListener('click', (e) => AppController.navigate(e.currentTarget.dataset.phase)));
            const undoBtn = document.getElementById('undo-btn');
            if(undoBtn) undoBtn.addEventListener('click', () => AppState.undo());
            
            const resetBtn = document.getElementById('reset-btn');
            if(resetBtn) {
                resetBtn.addEventListener('click', () => {
                    UIRenderer.showModal(
                        '작업 초기화',
                        '정말로 모든 진행 상황을 초기화하고 처음부터 다시 시작하시겠습니까?',
                        [
                            { text: '아니오', className: 'bg-slate-200 hover:bg-slate-300 text-slate-800', onClick: () => UIRenderer.hideModal() },
                            { text: '예 (초기화)', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: () => { AppController.resetAll(); UIRenderer.hideModal(); } }
                        ]
                    );
                });
            }

            const state = AppState.getState();
            switch(state.currentPhase) {
                case 'phase1':
                    document.querySelectorAll('#main-content .selectable').forEach(row => row.addEventListener('click', e => AppController.handlePhase1RowSelect(parseInt(e.currentTarget.dataset.rowIndex, 10))));
                    document.getElementById('process-phase1-btn').addEventListener('click', AppController.processPhase1);
                    document.getElementById('reset-phase1-btn').addEventListener('click', AppController.resetPhase1);
                    break;
                case 'phase2':
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase2ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.getElementById('add-group-btn')?.addEventListener('click', AppController.handlePhase2AddGroup);
                    document.querySelectorAll('.group-name-input').forEach(input => input.addEventListener('change', e => AppController.handlePhase2GroupNameChange(parseInt(e.currentTarget.dataset.groupIndex, 10), e.currentTarget.value)));
                    document.getElementById('process-phase2-btn').addEventListener('click', AppController.processPhase2);
                    this.attachDragAndDropListeners('phase2');
                    break;
                case 'phase3':
                    document.querySelectorAll('#main-content .selection-box').forEach(box => box.addEventListener('click', e => AppController.handlePhase3KeySelect(e.currentTarget.dataset.key)));
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase3ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase3PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('process-phase3-btn').addEventListener('click', AppController.processPhase3);
                    document.getElementById('reset-phase3-btn').addEventListener('click', AppController.resetPhase3);
                    break;
                case 'phase4':
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase4ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase4PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('process-phase4-btn').addEventListener('click', AppController.processPhase4);
                    document.getElementById('reset-phase4-btn').addEventListener('click', AppController.resetPhase4);
                    this.attachDragAndDropListeners('phase4');
                    break;
                case 'phase5':
                    document.querySelectorAll('#main-content .selection-box').forEach(box => box.addEventListener('click', e => AppController.handlePhase5KeySelect(e.currentTarget.dataset.key)));
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase5ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase5PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('base-amount-input').addEventListener('change', e => AppController.handlePhase5BaseAmountChange(e.target.value));
                    document.getElementById('auto-classify-btn')?.addEventListener('click', AppController.handlePhase5AutoClassify);
                    document.getElementById('process-phase5-btn').addEventListener('click', () => AppController.processPhase5(false));
                    document.getElementById('reset-phase5-btn').addEventListener('click', AppController.resetPhase5);
                    this.attachDragAndDropListeners('phase5');
                    break;
                case 'download':
                    document.getElementById('download-all-btn')?.addEventListener('click', AppController.handleDownloadAll);
                    document.getElementById('download-validated-btn')?.addEventListener('click', AppController.handleDownloadValidated);
                    document.getElementById('download-all-anyway-btn')?.addEventListener('click', AppController.handleDownloadAll);
                    document.querySelectorAll('.download-single-btn').forEach(btn => btn.addEventListener('click', e => AppController.handleDownloadSingle(parseInt(e.currentTarget.dataset.downloadSingleIndex, 10))));
                    document.querySelectorAll('.fix-btn').forEach(btn => btn.addEventListener('click', e => AppController.handleGoToFix(parseInt(e.currentTarget.dataset.fixIndex, 10))));
                    break;
            }
        },
        attachDragAndDropListeners(phase) {
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.target.dataset.value));
            });
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', e => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault(); zone.classList.remove('drag-over');
                    const value = e.dataTransfer.getData('text/plain');
                    const toZoneId = zone.id;
                    if (phase === 'phase2') AppController.handlePhase2Drop(value, toZoneId);
                    if (phase === 'phase4') AppController.handlePhase4Drop(value, toZoneId);
                    if (phase === 'phase5') AppController.handlePhase5Drop(value, toZoneId);
                });
            });
        }
    };

    // --- 3. 컨트롤러 (Controller / Actions) ---
    const AppController = {
        handleFile(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, { type: 'array' }); const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: null }); AppState.setState(state => ({ ...state, fileName: file.name, currentPhase: 'phase1', phases: { ...state.phases, upload: { isComplete: true, rawData: rawData } } })); } catch (error) { UIRenderer.showModal('오류', "엑셀 파일을 읽는 중 오류가 발생했습니다: " + error.message, [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]); } }; reader.readAsArrayBuffer(file); },
        navigate(phase) { AppState.setState(state => ({ ...state, currentPhase: phase })); },
        resetAll() { AppState.init(); AppState.notify(); },
        
        handlePhase1RowSelect(rowIndex) { AppState.setState(state => { const currentSelection = state.phases.phase1.config.headerRows; const newSelection = currentSelection.includes(rowIndex) ? currentSelection.filter(r => r !== rowIndex) : [...currentSelection, rowIndex].sort((a, b) => a - b); return { ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, config: { ...state.phases.phase1.config, headerRows: newSelection } } } }; }); },
        resetPhase1() { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, config: { ...state.phases.phase1.config, headerRows: [] } } } })); },
        processPhase1() { const state = AppState.getState(); const { rawData } = state.phases.upload; const { headerRows } = state.phases.phase1.config; if (headerRows.length === 0) return UIRenderer.showModal('알림', '최소 1개 이상의 행을 선택해야 합니다.', [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]); let result = DataTransformer.transformPhase1(rawData, headerRows); result = DataTransformer.autoSortByDate(result); AppState.setState(state => ({ ...state, currentPhase: 'phase2', phases: { ...state.phases, phase1: { ...state.phases.phase1, isComplete: true, output: result }, phase2: { ...state.phases.phase2, isComplete: false, config: { splitCol: null, groups: [{name: '그룹 1', values: []}] } } } })); },
        
        handlePhase2ColSelect(colIndex) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, splitCol: colIndex } } } })); },
        handlePhase2AddGroup() { AppState.setState(state => { const newGroups = [...state.phases.phase2.config.groups, {name: `그룹 ${state.phases.phase2.config.groups.length + 1}`, values: []}]; return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, groups: newGroups } } } }; }); },
        handlePhase2GroupNameChange(index, newName) { AppState.setState(state => { const newGroups = [...state.phases.phase2.config.groups]; newGroups[index].name = newName; return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, groups: newGroups } } } }; }); },
        handlePhase2Drop(value, toZoneId) { AppState.setState(state => { const newGroups = state.phases.phase2.config.groups.map(g => ({...g, values: g.values.filter(v => v !== value) })); const zoneIndex = parseInt(toZoneId.replace('drop-zone-', ''), 10); if (!isNaN(zoneIndex) && !newGroups[zoneIndex].values.includes(value)) { newGroups[zoneIndex].values.push(value); } return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, groups: newGroups } } } }; }); },
        processPhase2() {
            const state = AppState.getState();
            const data = state.phases.phase1.output;
            const { splitCol, groups } = state.phases.phase2.config;
            const result = DataTransformer.transformPhase2(data, splitCol, groups);

            if (splitCol !== null && result.length === 0) {
                UIRenderer.showModal('알림', '선택된 기준으로 데이터를 분리할 수 없습니다. 그룹에 포함된 값이 실제 데이터와 일치하는지 확인해주세요.', [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                return;
            }

            AppState.setState(state => ({
                ...state,
                currentPhase: 'phase3',
                phases: {
                    ...state.phases,
                    phase2: { ...state.phases.phase2, isComplete: true, output: result },
                    phase3: { ...state.phases.phase3, isComplete: false, config: {}, activePath: 0 }
                }
            }));
        },

        handlePhase3PathChange(pathIndex) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, activePath: pathIndex, selectingKey: null } } })); },
        handlePhase3KeySelect(key) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, selectingKey: key } } })); },
        handlePhase3ColSelect(colIndex) { AppState.setState(state => { const { activePath, selectingKey } = state.phases.phase3; if (!selectingKey) return state; const currentConfig = state.phases.phase3.config[activePath] || {}; currentConfig[selectingKey] = colIndex; return { ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, selectingKey: null, config: { ...state.phases.phase3.config, [activePath]: currentConfig } } } }; }); },
        resetPhase3() { AppState.setState(state => { const { activePath } = state.phases.phase3; const newConfig = { ...state.phases.phase3.config }; delete newConfig[activePath]; return { ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, config: newConfig } } }; }); },
        processPhase3() {
            AppState.setState(state => {
                const { activePath } = state.phases.phase3;
                const dataSets = state.phases.phase2.output;
                const currentConfig = state.phases.phase3.config[activePath];
                if (!currentConfig) {
                    UIRenderer.showModal('알림', '현재 통화의 열을 먼저 선택해주세요.', [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    return state;
                }
                currentConfig.isComplete = true;

                const newConfigs = { ...state.phases.phase3.config, [activePath]: currentConfig };
                const allPathsCompleted = dataSets.every((_, index) => newConfigs[index]?.isComplete);

                if (allPathsCompleted) {
                    const results = dataSets.map((dataSet, index) => ({ ...dataSet, data: DataTransformer.transformPhase3(dataSet.data, newConfigs[index]) }));
                    return { ...state, currentPhase: 'phase4', phases: { ...state.phases, phase3: { ...state.phases.phase3, isComplete: true, output: results, config: newConfigs }, phase4: { ...state.phases.phase4, isComplete: false, config: {}, activePath: 0 } } };
                } else {
                    const nextPath = dataSets.findIndex((_, index) => !newConfigs[index]?.isComplete);
                    return { ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, activePath: nextPath, config: newConfigs } } };
                }
            });
        },

        handlePhase4PathChange(pathIndex) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, activePath: pathIndex } } })); },
        handlePhase4ColSelect(colIndex) { AppState.setState(state => { const { activePath } = state.phases.phase4; const currentConfig = state.phases.phase4.config[activePath] || {}; currentConfig.tradeTypeCol = colIndex; return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, config: { ...state.phases.phase4.config, [activePath]: currentConfig } } } }; }); },
        resetPhase4() { AppState.setState(state => { const { activePath } = state.phases.phase4; const newConfig = { ...state.phases.phase4.config }; delete newConfig[activePath]; return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, config: newConfig } } }; }); },
        handlePhase4Drop(value, toZoneId) { AppState.setState(state => { const { activePath } = state.phases.phase4; const config = state.phases.phase4.config[activePath] || {}; config.valuesToRemove = config.valuesToRemove || []; if (toZoneId === 'drop-zone-0' && !config.valuesToRemove.includes(value)) { config.valuesToRemove.push(value); } else if (toZoneId === 'source-items') { config.valuesToRemove = config.valuesToRemove.filter(v => v !== value); } return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, config: { ...state.phases.phase4.config, [activePath]: config } } } }; }); },
        processPhase4() {
            AppState.setState(state => {
                const { activePath } = state.phases.phase4;
                const dataSets = state.phases.phase3.output;
                const currentConfig = state.phases.phase4.config[activePath];
                if (!currentConfig?.tradeTypeCol) {
                    UIRenderer.showModal('알림', '기준열을 먼저 선택해주세요.', [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    return state;
                }
                currentConfig.isComplete = true;

                const configs = { ...state.phases.phase4.config, [activePath]: currentConfig };
                const allPathsCompleted = dataSets.every((_, index) => configs[index]?.isComplete);

                if (allPathsCompleted) {
                    const outputs = [];
                    const removeds = [];
                    dataSets.forEach((dataSet, index) => {
                        const { kept, removed } = DataTransformer.transformPhase4(dataSet.data, configs[index]);
                        outputs.push({ ...dataSet, data: kept });
                        removeds.push({ ...dataSet, data: removed });
                    });
                    return { ...state, currentPhase: 'phase5', phases: { ...state.phases, phase4: { ...state.phases.phase4, isComplete: true, output: outputs, removed: removeds, config: configs }, phase5: { ...state.phases.phase5, isComplete: false, activePath: 0 } } };
                } else {
                    const nextPath = dataSets.findIndex((_, index) => !configs[index]?.isComplete);
                    return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, activePath: nextPath, config: configs } } };
                }
            });
        },
        
        handlePhase5PathChange(pathIndex) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, activePath: pathIndex, selectingKey: null } } })); },
        handlePhase5KeySelect(key) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, selectingKey: key } } })); },
        handlePhase5ColSelect(colIndex) { AppState.setState(state => { const { activePath, selectingKey } = state.phases.phase5; if (!selectingKey) return state; const config = state.phases.phase5.config[activePath] || {}; config[selectingKey] = colIndex; return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, selectingKey: null, config: { ...state.phases.phase5.config, [activePath]: config } } } }; }); },
        handlePhase5BaseAmountChange(value) { AppState.setState(state => { const { activePath } = state.phases.phase5; const config = state.phases.phase5.config[activePath] || {}; config.baseAmount = parseFloat(value) || 0; return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, config: { ...state.phases.phase5.config, [activePath]: config } } } }; }); },
        handlePhase5Drop(value, toZoneId) { AppState.setState(state => { const { activePath } = state.phases.phase5; const config = state.phases.phase5.config[activePath] || {}; config.depositTypes = config.depositTypes || []; config.withdrawalTypes = config.withdrawalTypes || []; config.depositTypes = config.depositTypes.filter(v => v !== value); config.withdrawalTypes = config.withdrawalTypes.filter(v => v !== value); if (toZoneId === 'drop-zone-deposit') config.depositTypes.push(value); if (toZoneId === 'drop-zone-withdrawal') config.withdrawalTypes.push(value); return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, config: { ...state.phases.phase5.config, [activePath]: config } } } }; }); },
        resetPhase5() { AppState.setState(state => { const { activePath } = state.phases.phase5; const newConfig = { ...state.phases.phase5.config }; delete newConfig[activePath]; return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, config: newConfig } } }; }); },
        handlePhase5AutoClassify() {
            const state = AppState.getState();
            const { activePath } = state.phases.phase5;
            const data = state.phases.phase4.output[activePath].data;
            const config = state.phases.phase5.config[activePath] || {};
            
            const { result, error } = DataTransformer.classifyByBalance(data, config);
            if (error) {
                UIRenderer.showModal('오류: 필수 열 미선택', error, [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                return;
            }

            const { depositTypes, withdrawalTypes } = result;
            config.depositTypes = depositTypes;
            config.withdrawalTypes = withdrawalTypes;

            AppState.setState({ ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, config: { ...state.phases.phase5.config, [activePath]: config } } } });
        },
        
        processPhase5(ignoreWarning = false) {
            AppState.setState(state => {
                const { activePath } = state.phases.phase5;
                const dataSet = state.phases.phase4.output[activePath];
                const currentConfig = state.phases.phase5.config[activePath];

                if (!currentConfig) {
                    UIRenderer.showModal('알림', '현재 통화의 설정을 완료해주세요.', [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    return state;
                }

                if (!ignoreWarning) {
                    const verification = DataTransformer.verifyPhase5(dataSet.data, currentConfig);
                    if (!verification.isCorrect) {
                        UIRenderer.showModal( '잔액 흐름 불일치', `계산된 최종 잔액(<b class='text-blue-600'>${verification.calculated.toLocaleString()}</b>)이 원본의 최종 잔액(<b class='text-red-600'>${verification.original.toLocaleString()}</b>)과 일치하지 않습니다.<br>거래 종류를 재분류하시겠습니까?`,
                            [
                                { text: '예 (4단계로 이동)', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: () => this.handleBalanceMismatchRestart() },
                                { text: '아니오 (무시하고 변환)', className: 'bg-slate-200 hover:bg-slate-300 text-slate-800', onClick: () => { UIRenderer.hideModal(); this.processPhase5(true); } }
                            ]
                        );
                        return state; 
                    }
                }
                
                currentConfig.isComplete = true;
                currentConfig.status = ignoreWarning ? 'WARNING' : 'VALIDATED';
                
                const dataSets = state.phases.phase4.output;
                const configs = { ...state.phases.phase5.config, [activePath]: currentConfig };
                const allPathsCompleted = dataSets.every((_, index) => configs[index]?.isComplete);
                
                if (allPathsCompleted) {
                    const results = dataSets.map((dataSet, index) => ({
                        ...dataSet,
                        data: DataTransformer.transformPhase5(dataSet.data, configs[index])
                    }));
                    const hasAnyWarning = Object.values(configs).some(c => c && c.status === 'WARNING');
                    
                    return { ...state, currentPhase: 'download', phases: { ...state.phases, 
                        phase5: { ...state.phases.phase5, isComplete: !hasAnyWarning, output: results, config: configs },
                        download: { ...state.phases.download, isComplete: true }
                    }};
                } else {
                    const nextPath = dataSets.findIndex((_, index) => !configs[index]?.isComplete);
                    return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, activePath: nextPath, config: configs } } };
                }
            });
        },
        handleBalanceMismatchRestart() {
            UIRenderer.hideModal();
            AppState.setState(state => {
                const { activePath } = state.phases.phase5;
                const oldPhase5Config = state.phases.phase5.config[activePath] || {};
                
                const newPhase5Config = {
                    dateCol: oldPhase5Config.dateCol, amountCol: oldPhase5Config.amountCol,
                    balanceCol: oldPhase5Config.balanceCol, tradeTypeCol: oldPhase5Config.tradeTypeCol,
                    jukyoCol: oldPhase5Config.jukyoCol, feeCol: oldPhase5Config.feeCol,
                    taxCol: oldPhase5Config.taxCol, baseAmount: oldPhase5Config.baseAmount,
                    depositTypes: [], withdrawalTypes: [],
                    isComplete: false, status: 'NEEDS_REVIEW'
                };

                const phase4Config = state.phases.phase4.config[activePath] || {};
                phase4Config.isComplete = false;
                
                return { ...state, currentPhase: 'phase4', phases: { ...state.phases,
                        phase4: { ...state.phases.phase4, activePath: activePath, config: { ...state.phases.phase4.config, [activePath]: phase4Config }, isComplete: false },
                        phase5: { ...state.phases.phase5, config: { ...state.phases.phase5.config, [activePath]: newPhase5Config } },
                        download: { ...state.phases.download, isComplete: false }
                    }
                };
            });
        },
        handleDownloadAll() {
            const state = AppState.getState();
            const finalSheets = [];
            state.phases.phase5.output.forEach((set, index) => {
                const dataSetName = state.phases.phase2.output[index].name;
                finalSheets.push({ name: `${dataSetName}_3단계결과`, data: state.phases.phase3.output[index].data });
                finalSheets.push({ name: `${dataSetName}_4단계제거`, data: state.phases.phase4.removed[index].data });
                finalSheets.push({ name: `${dataSetName}_5단계최종`, data: set.data });
            });
            DataTransformer.generateMultiSheetDownloadLink(finalSheets, `${state.fileName}_최종변환_전체.xlsx`);
        },
        handleDownloadValidated() {
            const state = AppState.getState();
            const finalSheets = [];
            state.phases.phase5.output.forEach((set, index) => {
                const config = state.phases.phase5.config[index];
                if (config && config.status === 'VALIDATED') {
                    const dataSetName = state.phases.phase2.output[index].name;
                    finalSheets.push({ name: `${dataSetName}_3단계결과`, data: state.phases.phase3.output[index].data });
                    finalSheets.push({ name: `${dataSetName}_4단계제거`, data: state.phases.phase4.removed[index].data });
                    finalSheets.push({ name: `${dataSetName}_5단계최종`, data: set.data });
                }
            });
            if (finalSheets.length === 0) {
                alert('다운로드할 검증된 시트가 없습니다.');
                return;
            }
            DataTransformer.generateMultiSheetDownloadLink(finalSheets, `${state.fileName}_최종변환_검증완료.xlsx`);
        },
        handleDownloadSingle(pathIndex) {
            const state = AppState.getState();
            const finalSheets = [];
            const dataSetName = state.phases.phase2.output[pathIndex].name;
            finalSheets.push({ name: `${dataSetName}_3단계결과`, data: state.phases.phase3.output[pathIndex].data });
            finalSheets.push({ name: `${dataSetName}_4단계제거`, data: state.phases.phase4.removed[pathIndex].data });
            finalSheets.push({ name: `${dataSetName}_5단계최종`, data: state.phases.phase5.output[pathIndex].data });
            DataTransformer.generateMultiSheetDownloadLink(finalSheets, `${state.fileName}_최종변환_${dataSetName}.xlsx`);
        },
        handleGoToFix(pathIndex) {
            AppState.setState(state => {
                const phase4Config = state.phases.phase4.config[pathIndex] || {};
                phase4Config.isComplete = false;

                const oldPhase5Config = state.phases.phase5.config[pathIndex] || {};
                const newPhase5Config = {
                    dateCol: oldPhase5Config.dateCol, amountCol: oldPhase5Config.amountCol,
                    balanceCol: oldPhase5Config.balanceCol, tradeTypeCol: oldPhase5Config.tradeTypeCol,
                    jukyoCol: oldPhase5Config.jukyoCol, feeCol: oldPhase5Config.feeCol,
                    taxCol: oldPhase5Config.taxCol, baseAmount: oldPhase5Config.baseAmount,
                    depositTypes: [], withdrawalTypes: [],
                    isComplete: false, status: 'NEEDS_REVIEW'
                };

                return {
                    ...state,
                    currentPhase: 'phase4',
                    phases: {
                        ...state.phases,
                        phase4: { ...state.phases.phase4, activePath: pathIndex, isComplete: false, config: { ...state.phases.phase4.config, [pathIndex]: phase4Config } },
                        phase5: { ...state.phases.phase5, isComplete: false, config: { ...state.phases.phase5.config, [pathIndex]: newPhase5Config } },
                        download: { ...state.phases.download, isComplete: false }
                    }
                };
            });
        }
    };

    // --- 4. 데이터 변환 로직 (Data Transformer) ---
    const DataTransformer = {
        autoSortByDate(data) {
            if (data.length < 2) return data;
            const header = data[0]; const body = data.slice(1);
            const dateKeywords = ['일자', '거래일', 'date'];
            let dateColIndex = header.findIndex(h => dateKeywords.some(k => String(h).toLowerCase().includes(k)));
            if (dateColIndex === -1) { console.log("날짜 열을 찾을 수 없어 정렬을 건너뜁니다."); return data; }
            const parseDate = (value) => { if (!value) return null; if (typeof value === 'number') { return new Date(Math.round((value - 25569) * 86400 * 1000)); } const s = String(value).replace(/\./g, '-').trim(); const d = new Date(s); return isNaN(d) ? null : d; };
            let firstDate, lastDate;
            for(let i=0; i<body.length; i++) { if(body[i][dateColIndex]) { firstDate = parseDate(body[i][dateColIndex]); break; } }
            for(let i=body.length-1; i>=0; i--) { if(body[i][dateColIndex]) { lastDate = parseDate(body[i][dateColIndex]); break; } }
            let sortedBody = body;
            if (firstDate && lastDate && firstDate > lastDate) { console.log("날짜가 역순으로 확인되어 전체 데이터를 뒤집습니다."); sortedBody = [...body].reverse(); }
            console.log("날짜 자동 정렬이 완료되었습니다."); return [header, ...sortedBody];
        },
        transformPhase1(data, headerRows) { const numRowsPerGroup = headerRows.length; const repeatingHeadersData = headerRows.map(rowIndex => data[rowIndex] || []); const newHeaders = repeatingHeadersData.flat().map(cell => cell || ''); const outputData = [newHeaders]; const dataStartIndex = Math.max(...headerRows) + 1; for (let i = dataStartIndex; i < data.length; i += numRowsPerGroup) { const group = data.slice(i, i + numRowsPerGroup); if (group.every(row => !row || row.every(cell => cell === null || String(cell).trim() === ''))) continue; const newRow = group.flat(); const finalRow = newHeaders.map((_, j) => newRow[j] ?? null); outputData.push(finalRow); } return outputData; },
        transformPhase2(data, splitCol, groups) {
            if (splitCol === null) return [{ name: '단일계좌', data: data }];
            const header = data[0]; const body = data.slice(1);
            const groupedData = groups.map(group => ({ name: group.name, data: [header, ...body.filter(row => group.values.includes(String(row[splitCol])))] }));
            const allGroupedValues = groups.flatMap(g => g.values);
            const ungroupedRows = body.filter(row => !allGroupedValues.includes(String(row[splitCol])));
            if(ungroupedRows.length > 0) { groupedData.push({ name: '기타', data: [header, ...ungroupedRows] }); }
            return groupedData.filter(g => g.data.length > 1);
        },
        transformPhase3(data, config) {
            const header = data[0]; const body = data.slice(1);
            const newHeader = [...header, "결과 생성"];
            const newBody = body.map(row => {
                const getValue = (key, isNumeric = false) => {
                    const colIndex = config[key];
                    if (colIndex === undefined || row[colIndex] === null || row[colIndex] === undefined) return "";
                    const value = String(row[colIndex]).trim().replace(/\u00A0/g, "");
                    if (isNumeric && (value === "" || parseFloat(value.replace(/,/g, '')) === 0)) return "";
                    return value;
                };
                const jukyoParts = [ getValue('tradeTypeCol'), getValue('stockNameCol'), getValue('stockQtyCol', true) ? `${getValue('stockQtyCol', true)}주` : '', getValue('unitPriceCol', true) ? `@${getValue('unitPriceCol', true)}` : '', getValue('stockBalanceCol', true) ? `잔고${getValue('stockBalanceCol', true)}주` : '', getValue('additionalCol1'), getValue('additionalCol2') ];
                return [...row, jukyoParts.filter(Boolean).join(' / ')];
            });
            return [newHeader, ...newBody];
        },
        transformPhase4(data, config) { const header = data[0]; const body = data.slice(1); if (!config || config.tradeTypeCol === undefined) return { kept: data, removed: [header] }; const valuesToRemove = config.valuesToRemove || []; const keptRows = body.filter(row => !valuesToRemove.includes(String(row[config.tradeTypeCol]))); const removedRows = body.filter(row => valuesToRemove.includes(String(row[config.tradeTypeCol]))); return { kept: [header, ...keptRows], removed: [header, ...removedRows] }; },
        classifyByBalance(data, config) {
            const { amountCol, balanceCol, tradeTypeCol } = config;
            if (amountCol === undefined || balanceCol === undefined || tradeTypeCol === undefined) {
                return { result: null, error: '자동 분류를 실행하려면 <b>거래금액, 예수금잔액, 거래종류</b> 열을 모두 선택해야 합니다.' };
            }
            const { feeCol, taxCol } = config;
            const body = data.slice(1); const classifications = {};
            const getNumeric = (val) => { if(val === null || val === undefined || String(val).trim() === '') return null; const num = parseFloat(String(val).replace(/,/g, '')); return isNaN(num) ? null : num; };
            const anchors = [{ index: -1, balance: config.baseAmount || 0 }];
            body.forEach((row, index) => { const balance = getNumeric(row[balanceCol]); if (balance !== null && balance !== 0) { anchors.push({ index, balance }); } });
            let newRuleLearned = true;
            while(newRuleLearned) {
                newRuleLearned = false;
                for (let i = 0; i < anchors.length - 1; i++) {
                    const startAnchor = anchors[i]; const endAnchor = anchors[i + 1];
                    const segmentRows = body.slice(startAnchor.index + 1, endAnchor.index + 1);
                    const totalBalanceChange = endAnchor.balance - startAnchor.balance;
                    let knownCashFlow = 0; const unclassified = {};
                    segmentRows.forEach(row => {
                        const tradeType = row[tradeTypeCol]; if (!tradeType) return;
                        const amount = getNumeric(row[amountCol]) || 0;
                        const fee = feeCol !== undefined ? getNumeric(row[feeCol]) : 0;
                        const tax = taxCol !== undefined ? getNumeric(row[taxCol]) : 0;
                        if (classifications[tradeType] === 'deposit') { knownCashFlow += amount - fee - tax; }
                        else if (classifications[tradeType] === 'withdrawal') { knownCashFlow -= (amount + fee + tax); }
                        else { if (!unclassified[tradeType]) unclassified[tradeType] = []; unclassified[tradeType].push({ amount, fee, tax }); }
                    });
                    const unclassifiedTypes = Object.keys(unclassified);
                    if (unclassifiedTypes.length === 1) {
                        const theUnknownType = unclassifiedTypes[0];
                        const requiredNetEffect = totalBalanceChange - knownCashFlow;
                        const depositHypothesis = unclassified[theUnknownType].reduce((sum, t) => sum + (t.amount - t.fee - t.tax), 0);
                        const withdrawalHypothesis = -unclassified[theUnknownType].reduce((sum, t) => sum + (t.amount + t.fee + t.tax), 0);
                        if (Math.abs(requiredNetEffect - depositHypothesis) < 1) { classifications[theUnknownType] = 'deposit'; newRuleLearned = true; }
                        else if (Math.abs(requiredNetEffect - withdrawalHypothesis) < 1) { classifications[theUnknownType] = 'withdrawal'; newRuleLearned = true; }
                    }
                }
            }
            const depositTypes = Object.keys(classifications).filter(k => classifications[k] === 'deposit');
            const withdrawalTypes = Object.keys(classifications).filter(k => classifications[k] === 'withdrawal');
            if(depositTypes.length === 0 && withdrawalTypes.length === 0) {
                UIRenderer.showModal('알림', '잔액 정보를 바탕으로 입출금을 자동으로 분류할 수 없었습니다. 데이터 확인 후 수동으로 분류해주세요.', [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            } else {
                UIRenderer.showModal('알림', `${depositTypes.length}개의 입금 종류와 ${withdrawalTypes.length}개의 출금 종류가 자동으로 분류되었습니다.`, [{ text: '확인', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            }
            return { result: { depositTypes, withdrawalTypes }, error: null };
        },
        verifyPhase5(data, config) {
            const body = data.slice(1); if (body.length === 0) return { isCorrect: true };
            const finalTransformedData = this.transformPhase5(data, config); if (finalTransformedData.length <= 1) return { isCorrect: true };
            const lastTransformedRow = finalTransformedData[finalTransformedData.length - 1]; const finalCalculatedBalance = lastTransformedRow[3];
            const lastOriginalRow = body[body.length - 1];
            const getOriginalValue = (key) => (config[key] === undefined || lastOriginalRow[config[key]] === null) ? "" : lastOriginalRow[config[key]];
            const getOriginalNumeric = (key) => parseFloat(String(getOriginalValue(key)).replace(/,/g, '')) || 0;
            const finalOriginalBalance = getOriginalNumeric('balanceCol');
            if (finalOriginalBalance !== 0 && Math.abs(finalCalculatedBalance - finalOriginalBalance) > 1) { return { isCorrect: false, calculated: finalCalculatedBalance, original: finalOriginalBalance }; }
            return { isCorrect: true };
        },
        transformPhase5(data, config) {
            const body = data.slice(1); const newSheet = [['일자', '입금', '출금', '잔액', '(참고용)잔액', '적요']];
            let runningBalance = config.baseAmount || 0;
            body.forEach(row => {
                const getValue = (key) => (config[key] === undefined || row[config[key]] === null) ? "" : row[config[key]];
                const getNumeric = (key) => parseFloat(String(getValue(key)).replace(/,/g, '')) || 0;
                const tradeType = getValue('tradeTypeCol'); const date = getValue('dateCol'); const jukyo = getValue('jukyoCol'); const originalBalance = getValue('balanceCol');
                const amount = getNumeric('amountCol'); const fee = getNumeric('feeCol'); const tax = getNumeric('taxCol');
                let deposit = 0, withdrawal = 0;
                if (config.depositTypes?.includes(tradeType)) { deposit = amount; } else if (config.withdrawalTypes?.includes(tradeType)) { withdrawal = amount; }
                if (deposit > 0) { runningBalance += deposit; newSheet.push([date, deposit, 0, runningBalance, originalBalance, jukyo]); }
                else if (withdrawal > 0) { runningBalance -= withdrawal; newSheet.push([date, 0, withdrawal, runningBalance, originalBalance, jukyo]); }
                if (fee > 0) { runningBalance -= fee; newSheet.push([date, 0, fee, runningBalance, originalBalance, `(수수료)${jukyo}`]); }
                if (tax > 0) { runningBalance -= tax; newSheet.push([date, 0, tax, runningBalance, originalBalance, `(제세금)${jukyo}`]); }
            });
            return newSheet;
        },
        generateMultiSheetDownloadLink(sheetDataArray, filename) {
            const workbook = XLSX.utils.book_new();
            sheetDataArray.forEach(sheetInfo => {
                if(sheetInfo.data.length <= 1 && sheetInfo.name.includes('_4단계제거')) return;
                const worksheet = XLSX.utils.aoa_to_sheet(sheetInfo.data);
                const safeSheetName = sheetInfo.name.replace(/[/\\?*:[\]]/g, '').substring(0, 31);
                XLSX.utils.book_append_sheet(workbook, worksheet, safeSheetName);
            });
            XLSX.writeFile(workbook, filename);
        }
    };

    // --- 앱 초기화 ---
    document.addEventListener('DOMContentLoaded', () => {
        AppState.init();
        UIRenderer.init();
        UIRenderer.render();
    });
  </script>
</body>
</html>


