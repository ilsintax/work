<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì§€ëŠ¥í˜• ê¸ˆìœµ ë°ì´í„° ë³€í™˜ê¸° v5.5 (ë¯¸ë¦¬ë³´ê¸° í™•ì¥)</title>
  <h1 class="text-xs text-right">made by ì„¸ë¬´ë²•ì¸ì¼ì‹  (ê°€ê¸‰ì  ì‚¬ì´íŠ¸ ë°°í¬í•˜ì§€ ë§ˆì‹œê¸¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤)</h1>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .preview-table { border-collapse: collapse; width: 100%; font-size: .8rem; }
    .preview-table th, .preview-table td {
      border: 1px solid #e2e8f0; padding: .375rem .5rem; text-align: left;
      white-space: nowrap; min-width: 20px;
    }
    .preview-table th { background-color: #f8fafc; font-weight: 600; }
    .selectable:hover { background-color: #f0f9ff; cursor: pointer; }
    .highlighted { background-color: #bae6fd !important; }
    /* ë‹¨ê³„ë³„ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ */
    .highlight-p3-tradeTypeCol { background-color: #a7f3d0 !important; }
    .highlight-p3-stockNameCol { background-color: #fde68a !important; }
    .highlight-p3-stockQtyCol { background-color: #fecaca !important; }
    .highlight-p3-unitPriceCol { background-color: #d8b4fe !important; }
    .highlight-p3-stockBalanceCol { background-color: #bfdbfe !important; }
    .highlight-p3-additionalCol1, .highlight-p3-additionalCol2 { background-color: #d1d5db !important; }
    
    .drop-zone { min-height: 80px; border: 2px dashed #cbd5e1; background-color: #f8fafc; transition: all 0.2s; }
    .drop-zone.drag-over { background-color: #e0f2fe; border-color: #3b82f6; }
    .draggable-item { cursor: grab; }
    .draggable-item:active { cursor: grabbing; }
    .sidebar-btn { transition: all 0.2s; }
    .sidebar-btn.active { background-color: #eef2ff; color: #4338ca; font-weight: 600; border-right: 3px solid #4f46e5;}
    .sidebar-btn.completed::after { content: 'âœ”'; margin-left: auto; color: #16a34a; font-weight: bold; }
    .sidebar-btn:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f9fafb; }
    .path-nav-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
    .path-nav-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; font-weight: 600; }
    .path-nav-btn.completed { color: #16a34a; }
    .selection-box { cursor: pointer; transition: all 0.2s; }
    .selection-box.selecting { border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
    .modal {
        transition: opacity 0.25s ease;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div id="app" class="flex h-screen">
    <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 p-4 space-y-2 hidden">
        <!-- JS ë Œë”ë§ ì˜ì—­ -->
    </aside>
    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div id="main-content" class="max-w-6xl mx-auto">
            <!-- JS ë Œë”ë§ ì˜ì—­ -->
        </div>
    </main>
  </div>

  <!-- ì¬ë¶„ë¥˜ í™•ì¸ ëª¨ë‹¬ -->
  <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
      <h2 id="modal-title" class="text-xl font-bold mb-4 text-slate-800"></h2>
      <p id="modal-message" class="text-slate-600 mb-6"></p>
      <div id="modal-buttons" class="flex justify-end space-x-3">
        <!-- ë²„íŠ¼ ë™ì  ìƒì„± -->
      </div>
    </div>
  </div>

  <script>
    /******************************************************************************
     * ì§€ëŠ¥í˜• ê¸ˆìœµ ë°ì´í„° ë³€í™˜ê¸° v5.5 (ë¯¸ë¦¬ë³´ê¸° í™•ì¥)
     ******************************************************************************/
    
    // --- 1. ìƒíƒœ ê´€ë¦¬ (State Management) ---
    const AppState = {
        _state: {}, _listeners: [],
        init() {
            this._state = {
                currentPhase: 'upload', fileName: null, history: [],
                phases: {
                    upload: { isComplete: false, rawData: [] },
                    phase1: { isComplete: false, config: { headerRows: [] }, output: null },
                    phase2: { isComplete: false, config: { splitCol: null, groups: [{name: 'ê·¸ë£¹ 1', values: []}] }, output: [] },
                    phase3: { isComplete: false, config: {}, output: [], activePath: 0, selectingKey: null },
                    phase4: { isComplete: false, config: {}, output: [], removed: [], activePath: 0 },
                    phase5: { isComplete: false, config: {}, output: [], activePath: 0, selectingKey: null },
                    download: { isComplete: false }
                }
            };
            const { history, ...initialState } = this._state;
            this._state.history = [initialState];
        },
        getState() { return this._state; },
        setState(updater) {
            const oldState = JSON.parse(JSON.stringify(this._state));
            const newState = typeof updater === 'function' ? updater(oldState) : updater;
            const oldHistory = oldState.history || [];
            const { history: _removed, ...stateToSave } = oldState;
            const newHistory = [...oldHistory, stateToSave];
            if (newHistory.length > 20) newHistory.shift();
            this._state = { ...newState, history: newHistory };
            console.log("State Updated:", this._state);
            this.notify();
        },
        subscribe(listener) { this._listeners.push(listener); },
        notify() { this._listeners.forEach(listener => listener()); },
        undo() {
            const history = this._state.history || [];
            if (history.length < 2) { 
                UIRenderer.showModal('ì•Œë¦¼', 'ë” ì´ìƒ ë˜ëŒë¦´ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                return;
            }
            const newHistory = history.slice(0, history.length - 1);
            const previousState = newHistory[newHistory.length - 1];
            this._state = { ...previousState, history: newHistory };
            this.notify();
        }
    };

    // --- 2. UI ë Œë”ë§ (UI Rendering) ---
    const UIRenderer = {
        init() {
            this.sidebarEl = document.getElementById('sidebar');
            this.mainContentEl = document.getElementById('main-content');
            this.modalEl = document.getElementById('modal');
            this.modalTitleEl = document.getElementById('modal-title');
            this.modalMessageEl = document.getElementById('modal-message');
            this.modalButtonsEl = document.getElementById('modal-buttons');
            AppState.subscribe(() => this.render());
        },
        render() {
            const state = AppState.getState();
            if (state.currentPhase === 'upload') {
                this.sidebarEl.classList.add('hidden');
                this.mainContentEl.innerHTML = this.renderUploadView();
            } else {
                this.sidebarEl.classList.remove('hidden');
                this.sidebarEl.innerHTML = this.renderSidebar(state);
                this.mainContentEl.innerHTML = this.renderPhaseView(state);
            }
            this.attachEventListeners();
        },
        showModal(title, message, buttons) {
            this.modalTitleEl.textContent = title;
            this.modalMessageEl.innerHTML = message;
            this.modalButtonsEl.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `px-4 py-2 rounded-md font-semibold ${btnInfo.className}`;
                button.onclick = btnInfo.onClick;
                this.modalButtonsEl.appendChild(button);
            });
            this.modalEl.classList.remove('hidden');
        },
        hideModal() {
            this.modalEl.classList.add('hidden');
        },
        renderUploadView() {
            return `<header class="text-center mb-8"><h1 class="text-4xl font-bold text-slate-900">ì§€ëŠ¥í˜• ê¸ˆìœµ ë°ì´í„° ë³€í™˜ê¸°</h1><p class="text-slate-600 mt-2">ë³µì¡í•œ ì—‘ì…€ ì‘ì—…ì„ ëª‡ ë²ˆì˜ í´ë¦­ìœ¼ë¡œ ìë™í™”í•˜ì„¸ìš”.</p></header><label for="file-input" class="flex flex-col items-center justify-center h-64 border-2 border-dashed rounded-lg bg-white cursor-pointer hover:bg-slate-100 transition"><svg class="w-12 h-12 mb-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><span class="text-slate-600 font-medium text-lg">í´ë¦­í•˜ì—¬ XLSX/XLS íŒŒì¼ ì—…ë¡œë“œ</span><input id="file-input" type="file" accept=".xlsx,.xls" class="hidden"/></label>`;
        },
        renderSidebar(state) {
            const phases = [ { id: 'phase1', name: '1. í–‰ ë³‘í•©' }, { id: 'phase2', name: '2. í†µí™”ë³„ ë¶„ë¦¬' }, { id: 'phase3', name: '3. ì ìš” ìƒì„±' }, { id: 'phase4', name: '4. í•­ëª© ì œê±°' }, { id: 'phase5', name: '5. ìµœì¢… ë³€í™˜' }, { id: 'download', name: 'ê²°ê³¼ ë¦¬í¬íŠ¸' }, ];
            let buttonsHTML = phases.map(phase => {
                const phaseState = state.phases[phase.id];
                const isEnabled = phase.id === 'phase1' || state.phases[this.getPrevPhase(phase.id)]?.isComplete;
                return `<button data-phase="${phase.id}" class="sidebar-btn w-full flex items-center text-left px-3 py-2 rounded-md text-slate-700 hover:bg-slate-100 ${state.currentPhase === phase.id ? 'active' : ''} ${phaseState?.isComplete ? 'completed' : ''}" ${!isEnabled ? 'disabled' : ''}>${phase.name}</button>`;
            }).join('');
            return `<div class="flex-1"><h2 class="text-lg font-bold text-slate-800 px-2 mb-4">ë³€í™˜ ë‹¨ê³„</h2><div class="space-y-1">${buttonsHTML}</div></div><div class="pt-4 border-t"><button id="undo-btn" class="w-full text-sm px-3 py-2 bg-slate-200 rounded-md hover:bg-slate-300">ì‹¤í–‰ ì·¨ì†Œ (Undo)</button><button id="reset-btn" class="w-full text-sm px-3 py-2 mt-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200">ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°</button></div>`;
        },
        renderPhaseView(state) {
            switch(state.currentPhase) {
                case 'phase1': return this.renderPhase1View(state);
                case 'phase2': return this.renderPhase2View(state);
                case 'phase3': return this.renderPhase3View(state);
                case 'phase4': return this.renderPhase4View(state);
                case 'phase5': return this.renderPhase5View(state);
                case 'download': return this.renderDownloadView(state);
                default: return `<div class="text-center py-10"><h1 class="text-2xl font-bold">ì‘ì—…ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.</h1><p class="text-slate-600 mt-2">ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ë‹¨ê³„ë¥¼ ì„ íƒí•˜ì—¬ ë³€í™˜ì„ ì‹œì‘í•˜ì„¸ìš”.</p></div>`;
            }
        },
        renderPhase1View(state) { const { rawData } = state.phases.upload; const { headerRows } = state.phases.phase1.config; let tableHTML = this.generateTableHTML(rawData.slice(0, 20), { selectable: 'row', selectedRows: headerRows }); return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">1ë‹¨ê³„: í–‰ ë³‘í•©</h1><p class="text-slate-600 mt-2">ë°˜ë³µë˜ëŠ” ì œëª© í–‰ì„ ëª¨ë‘ í´ë¦­í•˜ì„¸ìš”.</p></header><div class="flex items-center space-x-3"><button id="process-phase1-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-300" ${headerRows.length === 0 ? 'disabled' : ''}>ì‹¤í–‰ & ë‹¤ìŒ ë‹¨ê³„ë¡œ</button><button id="reset-phase1-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ì„ íƒ ì´ˆê¸°í™”</button></div><div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div></div>`; },
        renderPhase2View(state) {
            const data = state.phases.phase1.output; if (!data) return `<p>1ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            const { splitCol, groups } = state.phases.phase2.config;
            let tableHTML = this.generateTableHTML(data.slice(0, 10), { selectable: 'col', selectedCols: splitCol !== null ? [splitCol] : [] });
            let contentHTML = `<p class="text-slate-600 mt-2">ë°ì´í„°ë¥¼ í†µí™”(KRW, USD ë“±)ì— ë”°ë¼ ë¶„ë¦¬í•  ê¸°ì¤€ ì—´ì„ ì„ íƒí•˜ì„¸ìš”.<br>ëª¨ë“  ê±°ë˜ê°€ ë‹¨ì¼ í†µí™”ì¸ ê²½ìš°, ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div>`;
            if (splitCol !== null) {
                const uniqueValues = [...new Set(data.slice(1).map(row => row[splitCol]).filter(Boolean))];
                const groupedValues = groups.flatMap(g => g.values);
                const sourceItems = uniqueValues.filter(v => !groupedValues.includes(v));
                const groupsHTML = groups.map((group, index) => `<div class="p-4 rounded-lg bg-white border"><input type="text" value="${group.name}" data-group-index="${index}" class="group-name-input font-semibold mb-2 border-b-2 w-full p-1" placeholder="ê·¸ë£¹ ì´ë¦„ ì…ë ¥"><div id="drop-zone-${index}" class="drop-zone p-2 rounded flex flex-wrap gap-2" data-zone-id="${index}">${group.values.map(val => `<div class="draggable-item bg-blue-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div>`).join('');
                contentHTML += `<p class="text-slate-600 mt-4 font-semibold">ì„ íƒí•œ ì—´ì˜ ê³ ìœ ê°’ì„ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ì–´ì£¼ì„¸ìš”.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">ê³ ìœ ê°’ (ë“œë˜ê·¸)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="space-y-4">${groupsHTML}<button id="add-group-btn" class="w-full px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">+ ê·¸ë£¹ ì¶”ê°€</button></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">2ë‹¨ê³„: í†µí™”ë³„ ë¶„ë¦¬</h1></header>${contentHTML}<div class="flex items-center space-x-3 mt-4"><button id="process-phase2-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">ì‹¤í–‰ & ë‹¤ìŒ ë‹¨ê³„ë¡œ</button></div></div>`;
        },
        renderPhase3View(state) {
            const dataSets = state.phases.phase2.output; if (!dataSets || dataSets.length === 0) return `<p>2ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            const { activePath, selectingKey } = state.phases.phase3;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 2ë‹¨ê³„ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            const config = state.phases.phase3.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${state.phases.phase3.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            const prompts = [ { key: 'tradeTypeCol', text: 'ê±°ë˜ì¢…ë¥˜' }, { key: 'stockNameCol', text: 'ì¢…ëª©' }, { key: 'stockQtyCol', text: 'ê±°ë˜ì£¼ì‹ìˆ˜' }, { key: 'unitPriceCol', text: 'ë‹¨ê°€' }, { key: 'stockBalanceCol', text: 'ì£¼ì‹ì”ê³ ' }, { key: 'additionalCol1', text: 'ì¶”ê°€ì ìš” 1' }, { key: 'additionalCol2', text: 'ì¶”ê°€ì ìš” 2' } ];
            let selectionUI = prompts.map(p => { const isSelecting = selectingKey === p.key; const valueText = config[p.key] !== undefined && currentData[0][config[p.key]] ? `[${config[p.key] + 1}ì—´] ${currentData[0][config[p.key]]}` : 'ë¯¸ì„ íƒ'; return `<div data-key="${p.key}" class="selection-box p-2 border rounded-md ${isSelecting ? 'selecting' : ''}"><label class="font-medium text-sm pointer-events-none">${p.text}: </label><span class="font-bold text-indigo-600 pointer-events-none">${valueText}</span></div>`; }).join('');
            let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col', highlightMapping: { 'highlight-p3-tradeTypeCol': config.tradeTypeCol, 'highlight-p3-stockNameCol': config.stockNameCol, 'highlight-p3-stockQtyCol': config.stockQtyCol, 'highlight-p3-unitPriceCol': config.unitPriceCol, 'highlight-p3-stockBalanceCol': config.stockBalanceCol, 'highlight-p3-additionalCol1': config.additionalCol1, 'highlight-p3-additionalCol2': config.additionalCol2, } });
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">3ë‹¨ê³„: ì£¼ì‹ ì ìš” ìƒì„±</h1></header><div class="flex border-b">${pathNav}</div><p class="text-slate-600 mt-2">ì•„ë˜ í•­ëª©ì„ í´ë¦­í•œ ë’¤, í•´ë‹¹í•˜ëŠ” ì—´ì„ í…Œì´ë¸”ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.</p><div class="grid grid-cols-2 md:grid-cols-4 gap-2">${selectionUI}</div><div class="flex items-center space-x-3 mt-4"><button id="process-phase3-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">í˜„ì¬ í†µí™” ì ìš© & ë‹¤ìŒìœ¼ë¡œ</button><button id="reset-phase3-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ì„ íƒ ì´ˆê¸°í™”</button></div><div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div></div>`;
        },
        renderPhase4View(state) {
            const dataSets = state.phases.phase3.output; if (!dataSets || dataSets.length === 0) return `<p>3ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            const { activePath } = state.phases.phase4;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 3ë‹¨ê³„ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            const config = state.phases.phase4.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${state.phases.phase4.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            let contentHTML;
            if (config.tradeTypeCol === undefined) {
                let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col' });
                contentHTML = `<p class="text-slate-600 mt-2">ì œê±°í•  í•­ëª©ì˜ ê¸°ì¤€ì´ ë  'ê±°ë˜ì¢…ë¥˜' ì—´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div>`;
            } else {
                const uniqueValues = [...new Set(currentData.slice(1).map(row => row[config.tradeTypeCol]).filter(Boolean))];
                const itemsInZone = config.valuesToRemove || [];
                const sourceItems = uniqueValues.filter(v => !itemsInZone.includes(v));
                contentHTML = `<p class="text-slate-600 mt-2">ì…ì¶œê¸ˆê³¼ ê´€ë ¨ ì—†ëŠ” ê±°ë˜ ì¢…ë¥˜ë¥¼ ì•„ë˜ 'ì œê±°í•  í•­ëª©' ì˜ì—­ìœ¼ë¡œ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”.</p>
                <div class="text-sm text-red-500 mt-2 p-3 bg-slate-100 rounded-md">
                <p class="font-semibold">ì„¤ëª…:</p>
                <p>*ë¯¸ë˜ì—ì…‹ì˜ ê²½ìš° 'ì£¼ì‹ë§¤ë„ ì…ê¸ˆ'ì€ ì œê±°í•  í•­ëª©ìœ¼ë¡œ ë¶„ë¥˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                <p>*ë¯¸ë˜ì—ì…‹ì˜ ê²½ìš° 'ì£¼ì‹ë§¤ë„ ì¶œê³ 'ëŠ” ì œê±°í•  í•­ëª©ìœ¼ë¡œ ë¶„ë¥˜í•˜ì§€ ë§ì•„ì£¼ì„¸ìš”.</p>
                <p>*'ì™¸í™”ì£¼ì‹ë§¤ë„ ì…ê¸ˆ'ë„ ë™ì¼í•©ë‹ˆë‹¤..</p>
                <br><br><br><br></div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">ì „ì²´ ê±°ë˜ ì¢…ë¥˜ (ë“œë˜ê·¸)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-red-600">ì œê±°í•  í•­ëª© (ë“œë¡­)</h3><div id="drop-zone-0" class="drop-zone p-2 rounded flex flex-wrap gap-2">${itemsInZone.map(val => `<div class="draggable-item bg-red-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">4ë‹¨ê³„: ë¶ˆí•„ìš” í•­ëª© ì œê±°</h1></header><div class="flex border-b">${pathNav}</div>${contentHTML}<div class="flex items-center space-x-3 mt-4"><button id="process-phase4-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">í˜„ì¬ í†µí™” ì ìš© & ë‹¤ìŒìœ¼ë¡œ</button><button id="reset-phase4-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ì„ íƒ ì´ˆê¸°í™”</button></div></div>`;
        },
        renderPhase5View(state) {
            const dataSets = state.phases.phase4.output; if (!dataSets || dataSets.length === 0) return `<p>4ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            const { activePath, selectingKey } = state.phases.phase5;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 4ë‹¨ê³„ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            const config = state.phases.phase5.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${state.phases.phase5.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            const prompts = [ { key: 'dateCol', text: 'ì¼ì' }, { key: 'amountCol', text: 'ê±°ë˜ê¸ˆì•¡' }, { key: 'balanceCol', text: 'ì˜ˆìˆ˜ê¸ˆì”ì•¡' }, { key: 'tradeTypeCol', text: 'ê±°ë˜ì¢…ë¥˜' }, { key: 'jukyoCol', text: 'ì ìš”(3ë‹¨ê³„ ê²°ê³¼)' }, { key: 'feeCol', text: 'ìˆ˜ìˆ˜ë£Œ' }, { key: 'taxCol', text: 'ì œì„¸ê¸ˆ' } ];
            let selectionUI = prompts.map(p => { const isSelecting = selectingKey === p.key; const valueText = config[p.key] !== undefined && currentData.length > 0 && currentData[0][config[p.key]] ? `[${config[p.key] + 1}ì—´] ${currentData[0][config[p.key]]}` : 'ë¯¸ì„ íƒ'; return `<div data-key="${p.key}" class="selection-box p-2 border rounded-md ${isSelecting ? 'selecting' : ''}"><label class="font-medium text-sm pointer-events-none">${p.text}: </label><span class="font-bold text-indigo-600 pointer-events-none">${valueText}</span></div>`; }).join('');
            let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col' });
            let dragDropUI = '';
            if (config.tradeTypeCol !== undefined) {
                const uniqueValues = [...new Set(currentData.slice(1).map(row => row[config.tradeTypeCol]).filter(Boolean))];
                const deposits = config.depositTypes || [];
                const withdrawals = config.withdrawalTypes || [];
                const sourceItems = uniqueValues.filter(v => !deposits.includes(v) && !withdrawals.includes(v));
                dragDropUI = `<div class="flex items-center space-x-4"><p class="text-slate-600 font-semibold">ê±°ë˜ ì¢…ë¥˜ë¥¼ 'ì…ê¸ˆ'ê³¼ 'ì¶œê¸ˆ'ìœ¼ë¡œ ë¶„ë¥˜í•´ì£¼ì„¸ìš”.</p><button id="auto-classify-btn" class="px-3 py-1 bg-yellow-400 text-yellow-900 rounded-md hover:bg-yellow-500 text-sm font-bold">âœ¨ ì”ì•¡ ê¸°ì¤€ìœ¼ë¡œ ìë™ ë¶„ë¥˜</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">ê±°ë˜ ì¢…ë¥˜ (ë“œë˜ê·¸)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-blue-600">ì…ê¸ˆ í•­ëª©</h3><div id="drop-zone-deposit" class="drop-zone p-2 rounded flex flex-wrap gap-2">${deposits.map(val => `<div class="draggable-item bg-blue-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-red-600">ì¶œê¸ˆ í•­ëª©</h3><div id="drop-zone-withdrawal" class="drop-zone p-2 rounded flex flex-wrap gap-2">${withdrawals.map(val => `<div class="draggable-item bg-red-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">5ë‹¨ê³„: ìµœì¢… ë³€í™˜</h1></header><div class="flex border-b">${pathNav}</div><p class="text-slate-600 mt-2">ìµœì¢… ë³€í™˜ì— í•„ìš”í•œ ì—´ë“¤ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2">${selectionUI}</div><div><label class="font-medium text-sm">ê¸°ì´ˆê°€ì•¡: </label><input id="base-amount-input" type="number" value="${config.baseAmount || 0}" class="p-2 border rounded-md"></div><div class="mt-4 space-y-4">${dragDropUI}</div><div class="flex items-center space-x-3 mt-4"><button id="process-phase5-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">í˜„ì¬ í†µí™” ìµœì¢… ë³€í™˜ & ë‹¤ìŒìœ¼ë¡œ</button><button id="reset-phase5-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ì„ íƒ ì´ˆê¸°í™”</button></div></div>`;
        },
        renderDownloadView(state) {
            const configs = state.phases.phase5.config;
            const dataSets = state.phases.phase2.output;
            const hasAnyWarning = Object.values(configs).some(c => c && c.status === 'WARNING');
            const allPathsProcessed = dataSets.every((_, index) => configs[index]?.isComplete);

            if (!allPathsProcessed) {
                return `<div class="text-center py-10"><h1 class="text-2xl font-bold">ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì€ í†µí™”ê°€ ìˆìŠµë‹ˆë‹¤.</h1><p class="text-slate-600 mt-2">5ë‹¨ê³„ ë³€í™˜ì„ ëª¨ë‘ ì™„ë£Œí•´ì£¼ì„¸ìš”.</p></div>`;
            }

            if (!hasAnyWarning) {
                return `<div class="text-center py-10"><h1 class="text-4xl font-bold text-green-600">ğŸ‰ ë³€í™˜ ì™„ë£Œ!</h1><p class="text-slate-600 mt-4">ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìµœì¢… ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</p><div class="mt-8"><button id="download-all-btn" class="px-8 py-4 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 text-lg">ì „ì²´ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button></div></div>`;
            }

            let reportHtml = `
                <div class="space-y-6">
                    <header>
                        <h1 class="text-3xl font-bold text-slate-900">ìµœì¢… ë¦¬í¬íŠ¸</h1>
                        <div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-r-lg">
                            <h2 class="font-bold">âš ï¸ ì¼ë¶€ í†µí™”ì—ì„œ ì”ì•¡ ë¶ˆì¼ì¹˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</h2>
                            <p>ì”ì•¡ì´ ì¼ì¹˜í•˜ëŠ” ê²ƒìœ¼ë¡œ í™•ì¸ëœ ì‹œíŠ¸ë§Œ ê°œë³„ì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜, ë¬¸ì œê°€ ìˆëŠ” í†µí™”ë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•´ 4ë‹¨ê³„ë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </header>
                    <div class="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-3 font-semibold">í†µí™”ëª…</th>
                                    <th class="p-3 font-semibold">ìƒíƒœ</th>
                                    <th class="p-3 font-semibold text-right">ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            dataSets.forEach((set, index) => {
                const config = configs[index] || {};
                const status = config.status || 'PENDING';
                let statusBadge = '';
                let actionButtons = '';

                if (status === 'VALIDATED') {
                    statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-green-100 text-green-800">âœ” ì”ì•¡ ì¼ì¹˜</span>`;
                    actionButtons = `<button data-download-single-index="${index}" class="download-single-btn px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600">ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ</button>`;
                } else if (status === 'WARNING') {
                    statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-red-100 text-red-800">â— ì”ì•¡ ë¶ˆì¼ì¹˜</span>`;
                    actionButtons = `
                        <button data-download-single-index="${index}" class="download-single-btn px-3 py-1 bg-slate-500 text-white text-sm rounded-md hover:bg-slate-600 mr-2">ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ</button>
                        <button data-fix-index="${index}" class="fix-btn px-3 py-1 bg-yellow-500 text-white text-sm rounded-md hover:bg-yellow-600">ìˆ˜ì •í•˜ê¸°</button>
                    `;
                } else {
                     statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800">... ì‘ì—… í•„ìš”</span>`;
                }

                reportHtml += `
                    <tr class="border-b">
                        <td class="p-3 font-medium">${set.name}</td>
                        <td class="p-3">${statusBadge}</td>
                        <td class="p-3 text-right">${actionButtons}</td>
                    </tr>
                `;
            });
            
            reportHtml += `
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end space-x-4">
                       <button id="download-validated-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">ê²€ì¦ëœ ì‹œíŠ¸ë§Œ ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
                       <button id="download-all-anyway-btn" class="px-6 py-3 bg-slate-500 text-white font-bold rounded-lg hover:bg-slate-600">ê²½ê³  ë¬´ì‹œí•˜ê³  ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            `;
            return reportHtml;
        },
        generateTableHTML(data, options = {}) {
            let html = '<table class="preview-table">';
            data.forEach((row, rowIndex) => {
                const rowClass = options.selectable === 'row' ? `selectable ${options.selectedRows?.includes(rowIndex) ? 'highlighted' : ''}` : '';
                html += `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                (row || []).forEach((cell, colIndex) => {
                    let colClass = options.selectable === 'col' ? 'selectable' : '';
                    if (options.selectedCols?.includes(colIndex)) colClass += ' highlighted';
                    if (options.highlightMapping) {
                        for (const [className, col] of Object.entries(options.highlightMapping)) {
                            if (col === colIndex) colClass += ` ${className}`;
                        }
                    }
                    html += `<td data-col-index="${colIndex}" class="${colClass}">${cell ?? ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            return html;
        },
        getPrevPhase(phaseId) {
            const order = ['upload', 'phase1', 'phase2', 'phase3', 'phase4', 'phase5', 'download'];
            const index = order.indexOf(phaseId);
            return index > 0 ? order[index - 1] : 'upload';
        },
        attachEventListeners() {
            const fileInput = document.getElementById('file-input');
            if (fileInput) fileInput.addEventListener('change', AppController.handleFile);
            document.querySelectorAll('.sidebar-btn').forEach(btn => btn.addEventListener('click', (e) => AppController.navigate(e.currentTarget.dataset.phase)));
            const undoBtn = document.getElementById('undo-btn');
            if(undoBtn) undoBtn.addEventListener('click', () => AppState.undo());
            
            const resetBtn = document.getElementById('reset-btn');
            if(resetBtn) {
                resetBtn.addEventListener('click', () => {
                    UIRenderer.showModal(
                        'ì‘ì—… ì´ˆê¸°í™”',
                        'ì •ë§ë¡œ ëª¨ë“  ì§„í–‰ ìƒí™©ì„ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                        [
                            { text: 'ì•„ë‹ˆì˜¤', className: 'bg-slate-200 hover:bg-slate-300 text-slate-800', onClick: () => UIRenderer.hideModal() },
                            { text: 'ì˜ˆ (ì´ˆê¸°í™”)', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: () => { AppController.resetAll(); UIRenderer.hideModal(); } }
                        ]
                    );
                });
            }

            const state = AppState.getState();
            switch(state.currentPhase) {
                case 'phase1':
                    document.querySelectorAll('#main-content .selectable').forEach(row => row.addEventListener('click', e => AppController.handlePhase1RowSelect(parseInt(e.currentTarget.dataset.rowIndex, 10))));
                    document.getElementById('process-phase1-btn').addEventListener('click', AppController.processPhase1);
                    document.getElementById('reset-phase1-btn').addEventListener('click', AppController.resetPhase1);
                    break;
                case 'phase2':
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase2ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.getElementById('add-group-btn')?.addEventListener('click', AppController.handlePhase2AddGroup);
                    document.querySelectorAll('.group-name-input').forEach(input => input.addEventListener('change', e => AppController.handlePhase2GroupNameChange(parseInt(e.currentTarget.dataset.groupIndex, 10), e.currentTarget.value)));
                    document.getElementById('process-phase2-btn').addEventListener('click', AppController.processPhase2);
                    this.attachDragAndDropListeners('phase2');
                    break;
                case 'phase3':
                    document.querySelectorAll('#main-content .selection-box').forEach(box => box.addEventListener('click', e => AppController.handlePhase3KeySelect(e.currentTarget.dataset.key)));
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase3ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase3PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('process-phase3-btn').addEventListener('click', AppController.processPhase3);
                    document.getElementById('reset-phase3-btn').addEventListener('click', AppController.resetPhase3);
                    break;
                case 'phase4':
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase4ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase4PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('process-phase4-btn').addEventListener('click', AppController.processPhase4);
                    document.getElementById('reset-phase4-btn').addEventListener('click', AppController.resetPhase4);
                    this.attachDragAndDropListeners('phase4');
                    break;
                case 'phase5':
                    document.querySelectorAll('#main-content .selection-box').forEach(box => box.addEventListener('click', e => AppController.handlePhase5KeySelect(e.currentTarget.dataset.key)));
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase5ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase5PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('base-amount-input').addEventListener('change', e => AppController.handlePhase5BaseAmountChange(e.target.value));
                    document.getElementById('auto-classify-btn')?.addEventListener('click', AppController.handlePhase5AutoClassify);
                    document.getElementById('process-phase5-btn').addEventListener('click', () => AppController.processPhase5(false));
                    document.getElementById('reset-phase5-btn').addEventListener('click', AppController.resetPhase5);
                    this.attachDragAndDropListeners('phase5');
                    break;
                case 'download':
                    document.getElementById('download-all-btn')?.addEventListener('click', AppController.handleDownloadAll);
                    document.getElementById('download-validated-btn')?.addEventListener('click', AppController.handleDownloadValidated);
                    document.getElementById('download-all-anyway-btn')?.addEventListener('click', AppController.handleDownloadAll);
                    document.querySelectorAll('.download-single-btn').forEach(btn => btn.addEventListener('click', e => AppController.handleDownloadSingle(parseInt(e.currentTarget.dataset.downloadSingleIndex, 10))));
                    document.querySelectorAll('.fix-btn').forEach(btn => btn.addEventListener('click', e => AppController.handleGoToFix(parseInt(e.currentTarget.dataset.fixIndex, 10))));
                    break;
            }
        },
        attachDragAndDropListeners(phase) {
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.target.dataset.value));
            });
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', e => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault(); zone.classList.remove('drag-over');
                    const value = e.dataTransfer.getData('text/plain');
                    const toZoneId = zone.id;
                    if (phase === 'phase2') AppController.handlePhase2Drop(value, toZoneId);
                    if (phase === 'phase4') AppController.handlePhase4Drop(value, toZoneId);
                    if (phase === 'phase5') AppController.handlePhase5Drop(value, toZoneId);
                });
            });
        }
    };

    // --- 3. ì»¨íŠ¸ë¡¤ëŸ¬ (Controller / Actions) ---
    const AppController = {
        handleFile(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, { type: 'array' }); const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: null }); AppState.setState(state => ({ ...state, fileName: file.name, currentPhase: 'phase1', phases: { ...state.phases, upload: { isComplete: true, rawData: rawData } } })); } catch (error) { UIRenderer.showModal('ì˜¤ë¥˜', "ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]); } }; reader.readAsArrayBuffer(file); },
        navigate(phase) { AppState.setState(state => ({ ...state, currentPhase: phase })); },
        resetAll() { AppState.init(); AppState.notify(); },
        
        handlePhase1RowSelect(rowIndex) { AppState.setState(state => { const currentSelection = state.phases.phase1.config.headerRows; const newSelection = currentSelection.includes(rowIndex) ? currentSelection.filter(r => r !== rowIndex) : [...currentSelection, rowIndex].sort((a, b) => a - b); return { ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, config: { ...state.phases.phase1.config, headerRows: newSelection } } } }; }); },
        resetPhase1() { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, config: { ...state.phases.phase1.config, headerRows: [] } } } })); },
        processPhase1() { const state = AppState.getState(); const { rawData } = state.phases.upload; const { headerRows } = state.phases.phase1.config; if (headerRows.length === 0) return UIRenderer.showModal('ì•Œë¦¼', 'ìµœì†Œ 1ê°œ ì´ìƒì˜ í–‰ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]); let result = DataTransformer.transformPhase1(rawData, headerRows); result = DataTransformer.autoSortByDate(result); AppState.setState(state => ({ ...state, currentPhase: 'phase2', phases: { ...state.phases, phase1: { ...state.phases.phase1, isComplete: true, output: result }, phase2: { ...state.phases.phase2, isComplete: false, config: { splitCol: null, groups: [{name: 'ê·¸ë£¹ 1', values: []}] } } } })); },
        
        handlePhase2ColSelect(colIndex) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, splitCol: colIndex } } } })); },
        handlePhase2AddGroup() { AppState.setState(state => { const newGroups = [...state.phases.phase2.config.groups, {name: `ê·¸ë£¹ ${state.phases.phase2.config.groups.length + 1}`, values: []}]; return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, groups: newGroups } } } }; }); },
        handlePhase2GroupNameChange(index, newName) { AppState.setState(state => { const newGroups = [...state.phases.phase2.config.groups]; newGroups[index].name = newName; return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, groups: newGroups } } } }; }); },
        handlePhase2Drop(value, toZoneId) { AppState.setState(state => { const newGroups = state.phases.phase2.config.groups.map(g => ({...g, values: g.values.filter(v => v !== value) })); const zoneIndex = parseInt(toZoneId.replace('drop-zone-', ''), 10); if (!isNaN(zoneIndex) && !newGroups[zoneIndex].values.includes(value)) { newGroups[zoneIndex].values.push(value); } return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, groups: newGroups } } } }; }); },
        processPhase2() {
            const state = AppState.getState();
            const data = state.phases.phase1.output;
            const { splitCol, groups } = state.phases.phase2.config;
            const result = DataTransformer.transformPhase2(data, splitCol, groups);

            if (splitCol !== null && result.length === 0) {
                UIRenderer.showModal('ì•Œë¦¼', 'ì„ íƒëœ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶„ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ë£¹ì— í¬í•¨ëœ ê°’ì´ ì‹¤ì œ ë°ì´í„°ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                return;
            }

            AppState.setState(state => ({
                ...state,
                currentPhase: 'phase3',
                phases: {
                    ...state.phases,
                    phase2: { ...state.phases.phase2, isComplete: true, output: result },
                    phase3: { ...state.phases.phase3, isComplete: false, config: {}, activePath: 0 }
                }
            }));
        },

        handlePhase3PathChange(pathIndex) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, activePath: pathIndex, selectingKey: null } } })); },
        handlePhase3KeySelect(key) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, selectingKey: key } } })); },
        handlePhase3ColSelect(colIndex) { AppState.setState(state => { const { activePath, selectingKey } = state.phases.phase3; if (!selectingKey) return state; const currentConfig = state.phases.phase3.config[activePath] || {}; currentConfig[selectingKey] = colIndex; return { ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, selectingKey: null, config: { ...state.phases.phase3.config, [activePath]: currentConfig } } } }; }); },
        resetPhase3() { AppState.setState(state => { const { activePath } = state.phases.phase3; const newConfig = { ...state.phases.phase3.config }; delete newConfig[activePath]; return { ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, config: newConfig } } }; }); },
        processPhase3() {
            AppState.setState(state => {
                const { activePath } = state.phases.phase3;
                const dataSets = state.phases.phase2.output;
                const currentConfig = state.phases.phase3.config[activePath];
                if (!currentConfig) {
                    UIRenderer.showModal('ì•Œë¦¼', 'í˜„ì¬ í†µí™”ì˜ ì—´ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    return state;
                }
                currentConfig.isComplete = true;

                const newConfigs = { ...state.phases.phase3.config, [activePath]: currentConfig };
                const allPathsCompleted = dataSets.every((_, index) => newConfigs[index]?.isComplete);

                if (allPathsCompleted) {
                    const results = dataSets.map((dataSet, index) => ({ ...dataSet, data: DataTransformer.transformPhase3(dataSet.data, newConfigs[index]) }));
                    return { ...state, currentPhase: 'phase4', phases: { ...state.phases, phase3: { ...state.phases.phase3, isComplete: true, output: results, config: newConfigs }, phase4: { ...state.phases.phase4, isComplete: false, config: {}, activePath: 0 } } };
                } else {
                    const nextPath = dataSets.findIndex((_, index) => !newConfigs[index]?.isComplete);
                    return { ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, activePath: nextPath, config: newConfigs } } };
                }
            });
        },

        handlePhase4PathChange(pathIndex) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, activePath: pathIndex } } })); },
        handlePhase4ColSelect(colIndex) { AppState.setState(state => { const { activePath } = state.phases.phase4; const currentConfig = state.phases.phase4.config[activePath] || {}; currentConfig.tradeTypeCol = colIndex; return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, config: { ...state.phases.phase4.config, [activePath]: currentConfig } } } }; }); },
        resetPhase4() { AppState.setState(state => { const { activePath } = state.phases.phase4; const newConfig = { ...state.phases.phase4.config }; delete newConfig[activePath]; return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, config: newConfig } } }; }); },
        handlePhase4Drop(value, toZoneId) { AppState.setState(state => { const { activePath } = state.phases.phase4; const config = state.phases.phase4.config[activePath] || {}; config.valuesToRemove = config.valuesToRemove || []; if (toZoneId === 'drop-zone-0' && !config.valuesToRemove.includes(value)) { config.valuesToRemove.push(value); } else if (toZoneId === 'source-items') { config.valuesToRemove = config.valuesToRemove.filter(v => v !== value); } return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, config: { ...state.phases.phase4.config, [activePath]: config } } } }; }); },
        processPhase4() {
            AppState.setState(state => {
                const { activePath } = state.phases.phase4;
                const dataSets = state.phases.phase3.output;
                const currentConfig = state.phases.phase4.config[activePath];
                if (!currentConfig?.tradeTypeCol) {
                    UIRenderer.showModal('ì•Œë¦¼', 'ê¸°ì¤€ì—´ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    return state;
                }
                currentConfig.isComplete = true;

                const configs = { ...state.phases.phase4.config, [activePath]: currentConfig };
                const allPathsCompleted = dataSets.every((_, index) => configs[index]?.isComplete);

                if (allPathsCompleted) {
                    const outputs = [];
                    const removeds = [];
                    dataSets.forEach((dataSet, index) => {
                        const { kept, removed } = DataTransformer.transformPhase4(dataSet.data, configs[index]);
                        outputs.push({ ...dataSet, data: kept });
                        removeds.push({ ...dataSet, data: removed });
                    });
                    return { ...state, currentPhase: 'phase5', phases: { ...state.phases, phase4: { ...state.phases.phase4, isComplete: true, output: outputs, removed: removeds, config: configs }, phase5: { ...state.phases.phase5, isComplete: false, activePath: 0 } } };
                } else {
                    const nextPath = dataSets.findIndex((_, index) => !configs[index]?.isComplete);
                    return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, activePath: nextPath, config: configs } } };
                }
            });
        },
        
        handlePhase5PathChange(pathIndex) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, activePath: pathIndex, selectingKey: null } } })); },
        handlePhase5KeySelect(key) { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, selectingKey: key } } })); },
        handlePhase5ColSelect(colIndex) { AppState.setState(state => { const { activePath, selectingKey } = state.phases.phase5; if (!selectingKey) return state; const config = state.phases.phase5.config[activePath] || {}; config[selectingKey] = colIndex; return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, selectingKey: null, config: { ...state.phases.phase5.config, [activePath]: config } } } }; }); },
        handlePhase5BaseAmountChange(value) { AppState.setState(state => { const { activePath } = state.phases.phase5; const config = state.phases.phase5.config[activePath] || {}; config.baseAmount = parseFloat(value) || 0; return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, config: { ...state.phases.phase5.config, [activePath]: config } } } }; }); },
        handlePhase5Drop(value, toZoneId) { AppState.setState(state => { const { activePath } = state.phases.phase5; const config = state.phases.phase5.config[activePath] || {}; config.depositTypes = config.depositTypes || []; config.withdrawalTypes = config.withdrawalTypes || []; config.depositTypes = config.depositTypes.filter(v => v !== value); config.withdrawalTypes = config.withdrawalTypes.filter(v => v !== value); if (toZoneId === 'drop-zone-deposit') config.depositTypes.push(value); if (toZoneId === 'drop-zone-withdrawal') config.withdrawalTypes.push(value); return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, config: { ...state.phases.phase5.config, [activePath]: config } } } }; }); },
        resetPhase5() { AppState.setState(state => { const { activePath } = state.phases.phase5; const newConfig = { ...state.phases.phase5.config }; delete newConfig[activePath]; return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, config: newConfig } } }; }); },
        handlePhase5AutoClassify() {
            const state = AppState.getState();
            const { activePath } = state.phases.phase5;
            const data = state.phases.phase4.output[activePath].data;
            const config = state.phases.phase5.config[activePath] || {};
            
            const { result, error } = DataTransformer.classifyByBalance(data, config);
            if (error) {
                UIRenderer.showModal('ì˜¤ë¥˜: í•„ìˆ˜ ì—´ ë¯¸ì„ íƒ', error, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                return;
            }

            const { depositTypes, withdrawalTypes } = result;
            config.depositTypes = depositTypes;
            config.withdrawalTypes = withdrawalTypes;

            AppState.setState({ ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, config: { ...state.phases.phase5.config, [activePath]: config } } } });
        },
        
        processPhase5(ignoreWarning = false) {
            AppState.setState(state => {
                const { activePath } = state.phases.phase5;
                const dataSet = state.phases.phase4.output[activePath];
                const currentConfig = state.phases.phase5.config[activePath];

                if (!currentConfig) {
                    UIRenderer.showModal('ì•Œë¦¼', 'í˜„ì¬ í†µí™”ì˜ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    return state;
                }

                if (!ignoreWarning) {
                    const verification = DataTransformer.verifyPhase5(dataSet.data, currentConfig);
                    if (!verification.isCorrect) {
                        UIRenderer.showModal( 'ì”ì•¡ íë¦„ ë¶ˆì¼ì¹˜', `ê³„ì‚°ëœ ìµœì¢… ì”ì•¡(<b class='text-blue-600'>${verification.calculated.toLocaleString()}</b>)ì´ ì›ë³¸ì˜ ìµœì¢… ì”ì•¡(<b class='text-red-600'>${verification.original.toLocaleString()}</b>)ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ê±°ë˜ ì¢…ë¥˜ë¥¼ ì¬ë¶„ë¥˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                            [
                                { text: 'ì˜ˆ (4ë‹¨ê³„ë¡œ ì´ë™)', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: () => this.handleBalanceMismatchRestart() },
                                { text: 'ì•„ë‹ˆì˜¤ (ë¬´ì‹œí•˜ê³  ë³€í™˜)', className: 'bg-slate-200 hover:bg-slate-300 text-slate-800', onClick: () => { UIRenderer.hideModal(); this.processPhase5(true); } }
                            ]
                        );
                        return state; 
                    }
                }
                
                currentConfig.isComplete = true;
                currentConfig.status = ignoreWarning ? 'WARNING' : 'VALIDATED';
                
                const dataSets = state.phases.phase4.output;
                const configs = { ...state.phases.phase5.config, [activePath]: currentConfig };
                const allPathsCompleted = dataSets.every((_, index) => configs[index]?.isComplete);
                
                if (allPathsCompleted) {
                    const results = dataSets.map((dataSet, index) => ({
                        ...dataSet,
                        data: DataTransformer.transformPhase5(dataSet.data, configs[index])
                    }));
                    const hasAnyWarning = Object.values(configs).some(c => c && c.status === 'WARNING');
                    
                    return { ...state, currentPhase: 'download', phases: { ...state.phases, 
                        phase5: { ...state.phases.phase5, isComplete: !hasAnyWarning, output: results, config: configs },
                        download: { ...state.phases.download, isComplete: true }
                    }};
                } else {
                    const nextPath = dataSets.findIndex((_, index) => !configs[index]?.isComplete);
                    return { ...state, phases: { ...state.phases, phase5: { ...state.phases.phase5, activePath: nextPath, config: configs } } };
                }
            });
        },
        handleBalanceMismatchRestart() {
            UIRenderer.hideModal();
            AppState.setState(state => {
                const { activePath } = state.phases.phase5;
                const oldPhase5Config = state.phases.phase5.config[activePath] || {};
                
                const newPhase5Config = {
                    dateCol: oldPhase5Config.dateCol, amountCol: oldPhase5Config.amountCol,
                    balanceCol: oldPhase5Config.balanceCol, tradeTypeCol: oldPhase5Config.tradeTypeCol,
                    jukyoCol: oldPhase5Config.jukyoCol, feeCol: oldPhase5Config.feeCol,
                    taxCol: oldPhase5Config.taxCol, baseAmount: oldPhase5Config.baseAmount,
                    depositTypes: [], withdrawalTypes: [],
                    isComplete: false, status: 'NEEDS_REVIEW'
                };

                const phase4Config = state.phases.phase4.config[activePath] || {};
                phase4Config.isComplete = false;
                
                return { ...state, currentPhase: 'phase4', phases: { ...state.phases,
                        phase4: { ...state.phases.phase4, activePath: activePath, config: { ...state.phases.phase4.config, [activePath]: phase4Config }, isComplete: false },
                        phase5: { ...state.phases.phase5, config: { ...state.phases.phase5.config, [activePath]: newPhase5Config } },
                        download: { ...state.phases.download, isComplete: false }
                    }
                };
            });
        },
        handleDownloadAll() {
            const state = AppState.getState();
            const finalSheets = [];
            state.phases.phase5.output.forEach((set, index) => {
                const dataSetName = state.phases.phase2.output[index].name;
                finalSheets.push({ name: `${dataSetName}_3ë‹¨ê³„ê²°ê³¼`, data: state.phases.phase3.output[index].data });
                finalSheets.push({ name: `${dataSetName}_4ë‹¨ê³„ì œê±°`, data: state.phases.phase4.removed[index].data });
                finalSheets.push({ name: `${dataSetName}_5ë‹¨ê³„ìµœì¢…`, data: set.data });
            });
            DataTransformer.generateMultiSheetDownloadLink(finalSheets, `${state.fileName}_ìµœì¢…ë³€í™˜_ì „ì²´.xlsx`);
        },
        handleDownloadValidated() {
            const state = AppState.getState();
            const finalSheets = [];
            state.phases.phase5.output.forEach((set, index) => {
                const config = state.phases.phase5.config[index];
                if (config && config.status === 'VALIDATED') {
                    const dataSetName = state.phases.phase2.output[index].name;
                    finalSheets.push({ name: `${dataSetName}_3ë‹¨ê³„ê²°ê³¼`, data: state.phases.phase3.output[index].data });
                    finalSheets.push({ name: `${dataSetName}_4ë‹¨ê³„ì œê±°`, data: state.phases.phase4.removed[index].data });
                    finalSheets.push({ name: `${dataSetName}_5ë‹¨ê³„ìµœì¢…`, data: set.data });
                }
            });
            if (finalSheets.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ê²€ì¦ëœ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            DataTransformer.generateMultiSheetDownloadLink(finalSheets, `${state.fileName}_ìµœì¢…ë³€í™˜_ê²€ì¦ì™„ë£Œ.xlsx`);
        },
        handleDownloadSingle(pathIndex) {
            const state = AppState.getState();
            const finalSheets = [];
            const dataSetName = state.phases.phase2.output[pathIndex].name;
            finalSheets.push({ name: `${dataSetName}_3ë‹¨ê³„ê²°ê³¼`, data: state.phases.phase3.output[pathIndex].data });
            finalSheets.push({ name: `${dataSetName}_4ë‹¨ê³„ì œê±°`, data: state.phases.phase4.removed[pathIndex].data });
            finalSheets.push({ name: `${dataSetName}_5ë‹¨ê³„ìµœì¢…`, data: state.phases.phase5.output[pathIndex].data });
            DataTransformer.generateMultiSheetDownloadLink(finalSheets, `${state.fileName}_ìµœì¢…ë³€í™˜_${dataSetName}.xlsx`);
        },
        handleGoToFix(pathIndex) {
            AppState.setState(state => {
                const phase4Config = state.phases.phase4.config[pathIndex] || {};
                phase4Config.isComplete = false;

                const oldPhase5Config = state.phases.phase5.config[pathIndex] || {};
                const newPhase5Config = {
                    dateCol: oldPhase5Config.dateCol, amountCol: oldPhase5Config.amountCol,
                    balanceCol: oldPhase5Config.balanceCol, tradeTypeCol: oldPhase5Config.tradeTypeCol,
                    jukyoCol: oldPhase5Config.jukyoCol, feeCol: oldPhase5Config.feeCol,
                    taxCol: oldPhase5Config.taxCol, baseAmount: oldPhase5Config.baseAmount,
                    depositTypes: [], withdrawalTypes: [],
                    isComplete: false, status: 'NEEDS_REVIEW'
                };

                return {
                    ...state,
                    currentPhase: 'phase4',
                    phases: {
                        ...state.phases,
                        phase4: { ...state.phases.phase4, activePath: pathIndex, isComplete: false, config: { ...state.phases.phase4.config, [pathIndex]: phase4Config } },
                        phase5: { ...state.phases.phase5, isComplete: false, config: { ...state.phases.phase5.config, [pathIndex]: newPhase5Config } },
                        download: { ...state.phases.download, isComplete: false }
                    }
                };
            });
        }
    };

    // --- 4. ë°ì´í„° ë³€í™˜ ë¡œì§ (Data Transformer) ---
    const DataTransformer = {
        autoSortByDate(data) {
            if (data.length < 2) return data;
            const header = data[0]; const body = data.slice(1);
            const dateKeywords = ['ì¼ì', 'ê±°ë˜ì¼', 'date'];
            let dateColIndex = header.findIndex(h => dateKeywords.some(k => String(h).toLowerCase().includes(k)));
            if (dateColIndex === -1) { console.log("ë‚ ì§œ ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ì •ë ¬ì„ ê±´ë„ˆëœë‹ˆë‹¤."); return data; }
            const parseDate = (value) => { if (!value) return null; if (typeof value === 'number') { return new Date(Math.round((value - 25569) * 86400 * 1000)); } const s = String(value).replace(/\./g, '-').trim(); const d = new Date(s); return isNaN(d) ? null : d; };
            let firstDate, lastDate;
            for(let i=0; i<body.length; i++) { if(body[i][dateColIndex]) { firstDate = parseDate(body[i][dateColIndex]); break; } }
            for(let i=body.length-1; i>=0; i--) { if(body[i][dateColIndex]) { lastDate = parseDate(body[i][dateColIndex]); break; } }
            let sortedBody = body;
            if (firstDate && lastDate && firstDate > lastDate) { console.log("ë‚ ì§œê°€ ì—­ìˆœìœ¼ë¡œ í™•ì¸ë˜ì–´ ì „ì²´ ë°ì´í„°ë¥¼ ë’¤ì§‘ìŠµë‹ˆë‹¤."); sortedBody = [...body].reverse(); }
            console.log("ë‚ ì§œ ìë™ ì •ë ¬ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); return [header, ...sortedBody];
        },
        transformPhase1(data, headerRows) { const numRowsPerGroup = headerRows.length; const repeatingHeadersData = headerRows.map(rowIndex => data[rowIndex] || []); const newHeaders = repeatingHeadersData.flat().map(cell => cell || ''); const outputData = [newHeaders]; const dataStartIndex = Math.max(...headerRows) + 1; for (let i = dataStartIndex; i < data.length; i += numRowsPerGroup) { const group = data.slice(i, i + numRowsPerGroup); if (group.every(row => !row || row.every(cell => cell === null || String(cell).trim() === ''))) continue; const newRow = group.flat(); const finalRow = newHeaders.map((_, j) => newRow[j] ?? null); outputData.push(finalRow); } return outputData; },
        transformPhase2(data, splitCol, groups) {
            if (splitCol === null) return [{ name: 'ë‹¨ì¼ê³„ì¢Œ', data: data }];
            const header = data[0]; const body = data.slice(1);
            const groupedData = groups.map(group => ({ name: group.name, data: [header, ...body.filter(row => group.values.includes(String(row[splitCol])))] }));
            const allGroupedValues = groups.flatMap(g => g.values);
            const ungroupedRows = body.filter(row => !allGroupedValues.includes(String(row[splitCol])));
            if(ungroupedRows.length > 0) { groupedData.push({ name: 'ê¸°íƒ€', data: [header, ...ungroupedRows] }); }
            return groupedData.filter(g => g.data.length > 1);
        },
        transformPhase3(data, config) {
            const header = data[0]; const body = data.slice(1);
            const newHeader = [...header, "ê²°ê³¼ ìƒì„±"];
            const newBody = body.map(row => {
                const getValue = (key, isNumeric = false) => {
                    const colIndex = config[key];
                    if (colIndex === undefined || row[colIndex] === null || row[colIndex] === undefined) return "";
                    const value = String(row[colIndex]).trim().replace(/\u00A0/g, "");
                    if (isNumeric && (value === "" || parseFloat(value.replace(/,/g, '')) === 0)) return "";
                    return value;
                };
                const jukyoParts = [ getValue('tradeTypeCol'), getValue('stockNameCol'), getValue('stockQtyCol', true) ? `${getValue('stockQtyCol', true)}ì£¼` : '', getValue('unitPriceCol', true) ? `@${getValue('unitPriceCol', true)}` : '', getValue('stockBalanceCol', true) ? `ì”ê³ ${getValue('stockBalanceCol', true)}ì£¼` : '', getValue('additionalCol1'), getValue('additionalCol2') ];
                return [...row, jukyoParts.filter(Boolean).join(' / ')];
            });
            return [newHeader, ...newBody];
        },
        transformPhase4(data, config) { const header = data[0]; const body = data.slice(1); if (!config || config.tradeTypeCol === undefined) return { kept: data, removed: [header] }; const valuesToRemove = config.valuesToRemove || []; const keptRows = body.filter(row => !valuesToRemove.includes(String(row[config.tradeTypeCol]))); const removedRows = body.filter(row => valuesToRemove.includes(String(row[config.tradeTypeCol]))); return { kept: [header, ...keptRows], removed: [header, ...removedRows] }; },
        classifyByBalance(data, config) {
            const { amountCol, balanceCol, tradeTypeCol } = config;
            if (amountCol === undefined || balanceCol === undefined || tradeTypeCol === undefined) {
                return { result: null, error: 'ìë™ ë¶„ë¥˜ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ <b>ê±°ë˜ê¸ˆì•¡, ì˜ˆìˆ˜ê¸ˆì”ì•¡, ê±°ë˜ì¢…ë¥˜</b> ì—´ì„ ëª¨ë‘ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.' };
            }
            const { feeCol, taxCol } = config;
            const body = data.slice(1); const classifications = {};
            const getNumeric = (val) => { if(val === null || val === undefined || String(val).trim() === '') return null; const num = parseFloat(String(val).replace(/,/g, '')); return isNaN(num) ? null : num; };
            const anchors = [{ index: -1, balance: config.baseAmount || 0 }];
            body.forEach((row, index) => { const balance = getNumeric(row[balanceCol]); if (balance !== null && balance !== 0) { anchors.push({ index, balance }); } });
            let newRuleLearned = true;
            while(newRuleLearned) {
                newRuleLearned = false;
                for (let i = 0; i < anchors.length - 1; i++) {
                    const startAnchor = anchors[i]; const endAnchor = anchors[i + 1];
                    const segmentRows = body.slice(startAnchor.index + 1, endAnchor.index + 1);
                    const totalBalanceChange = endAnchor.balance - startAnchor.balance;
                    let knownCashFlow = 0; const unclassified = {};
                    segmentRows.forEach(row => {
                        const tradeType = row[tradeTypeCol]; if (!tradeType) return;
                        const amount = getNumeric(row[amountCol]) || 0;
                        const fee = feeCol !== undefined ? getNumeric(row[feeCol]) : 0;
                        const tax = taxCol !== undefined ? getNumeric(row[taxCol]) : 0;
                        if (classifications[tradeType] === 'deposit') { knownCashFlow += amount - fee - tax; }
                        else if (classifications[tradeType] === 'withdrawal') { knownCashFlow -= (amount + fee + tax); }
                        else { if (!unclassified[tradeType]) unclassified[tradeType] = []; unclassified[tradeType].push({ amount, fee, tax }); }
                    });
                    const unclassifiedTypes = Object.keys(unclassified);
                    if (unclassifiedTypes.length === 1) {
                        const theUnknownType = unclassifiedTypes[0];
                        const requiredNetEffect = totalBalanceChange - knownCashFlow;
                        const depositHypothesis = unclassified[theUnknownType].reduce((sum, t) => sum + (t.amount - t.fee - t.tax), 0);
                        const withdrawalHypothesis = -unclassified[theUnknownType].reduce((sum, t) => sum + (t.amount + t.fee + t.tax), 0);
                        if (Math.abs(requiredNetEffect - depositHypothesis) < 1) { classifications[theUnknownType] = 'deposit'; newRuleLearned = true; }
                        else if (Math.abs(requiredNetEffect - withdrawalHypothesis) < 1) { classifications[theUnknownType] = 'withdrawal'; newRuleLearned = true; }
                    }
                }
            }
            const depositTypes = Object.keys(classifications).filter(k => classifications[k] === 'deposit');
            const withdrawalTypes = Object.keys(classifications).filter(k => classifications[k] === 'withdrawal');
            if(depositTypes.length === 0 && withdrawalTypes.length === 0) {
                UIRenderer.showModal('ì•Œë¦¼', 'ì”ì•¡ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì…ì¶œê¸ˆì„ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„° í™•ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ ë¶„ë¥˜í•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            } else {
                UIRenderer.showModal('ì•Œë¦¼', `${depositTypes.length}ê°œì˜ ì…ê¸ˆ ì¢…ë¥˜ì™€ ${withdrawalTypes.length}ê°œì˜ ì¶œê¸ˆ ì¢…ë¥˜ê°€ ìë™ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            }
            return { result: { depositTypes, withdrawalTypes }, error: null };
        },
        verifyPhase5(data, config) {
            const body = data.slice(1); if (body.length === 0) return { isCorrect: true };
            const finalTransformedData = this.transformPhase5(data, config); if (finalTransformedData.length <= 1) return { isCorrect: true };
            const lastTransformedRow = finalTransformedData[finalTransformedData.length - 1]; const finalCalculatedBalance = lastTransformedRow[3];
            const lastOriginalRow = body[body.length - 1];
            const getOriginalValue = (key) => (config[key] === undefined || lastOriginalRow[config[key]] === null) ? "" : lastOriginalRow[config[key]];
            const getOriginalNumeric = (key) => parseFloat(String(getOriginalValue(key)).replace(/,/g, '')) || 0;
            const finalOriginalBalance = getOriginalNumeric('balanceCol');
            if (finalOriginalBalance !== 0 && Math.abs(finalCalculatedBalance - finalOriginalBalance) > 1) { return { isCorrect: false, calculated: finalCalculatedBalance, original: finalOriginalBalance }; }
            return { isCorrect: true };
        },
        transformPhase5(data, config) {
            const body = data.slice(1); const newSheet = [['ì¼ì', 'ì…ê¸ˆ', 'ì¶œê¸ˆ', 'ì”ì•¡', '(ì°¸ê³ ìš©)ì”ì•¡', 'ì ìš”']];
            let runningBalance = config.baseAmount || 0;
            body.forEach(row => {
                const getValue = (key) => (config[key] === undefined || row[config[key]] === null) ? "" : row[config[key]];
                const getNumeric = (key) => parseFloat(String(getValue(key)).replace(/,/g, '')) || 0;
                const tradeType = getValue('tradeTypeCol'); const date = getValue('dateCol'); const jukyo = getValue('jukyoCol'); const originalBalance = getValue('balanceCol');
                const amount = getNumeric('amountCol'); const fee = getNumeric('feeCol'); const tax = getNumeric('taxCol');
                let deposit = 0, withdrawal = 0;
                if (config.depositTypes?.includes(tradeType)) { deposit = amount; } else if (config.withdrawalTypes?.includes(tradeType)) { withdrawal = amount; }
                if (deposit > 0) { runningBalance += deposit; newSheet.push([date, deposit, 0, runningBalance, originalBalance, jukyo]); }
                else if (withdrawal > 0) { runningBalance -= withdrawal; newSheet.push([date, 0, withdrawal, runningBalance, originalBalance, jukyo]); }
                if (fee > 0) { runningBalance -= fee; newSheet.push([date, 0, fee, runningBalance, originalBalance, `(ìˆ˜ìˆ˜ë£Œ)${jukyo}`]); }
                if (tax > 0) { runningBalance -= tax; newSheet.push([date, 0, tax, runningBalance, originalBalance, `(ì œì„¸ê¸ˆ)${jukyo}`]); }
            });
            return newSheet;
        },
        generateMultiSheetDownloadLink(sheetDataArray, filename) {
            const workbook = XLSX.utils.book_new();
            sheetDataArray.forEach(sheetInfo => {
                if(sheetInfo.data.length <= 1 && sheetInfo.name.includes('_4ë‹¨ê³„ì œê±°')) return;
                const worksheet = XLSX.utils.aoa_to_sheet(sheetInfo.data);
                const safeSheetName = sheetInfo.name.replace(/[/\\?*:[\]]/g, '').substring(0, 31);
                XLSX.utils.book_append_sheet(workbook, worksheet, safeSheetName);
            });
            XLSX.writeFile(workbook, filename);
        }
    };

    // --- ì•± ì´ˆê¸°í™” ---
    document.addEventListener('DOMContentLoaded', () => {
        AppState.init();
        UIRenderer.init();
        UIRenderer.render();
    });
  </script>
</body>
</html>


