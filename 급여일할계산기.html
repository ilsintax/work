<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>급여 일할계산기 (최종판)</title>
    <h1 class="text-xs text-right">made by 세무법인일신 (가급적 사이트 배포하지 마시길 부탁드립니다)</h1>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 라이브러리를 html2pdf.bundle.js 대신 개별로 로드합니다 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        .tab-button.active {
            border-color: #4f46e5;
            background-color: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }
        .employee-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f9fafb;
        }
        
        /* --- PDF 미리보기 및 로딩 모달 스타일 --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-body {
            /* PDF로 변환될 내용이 들어갈 곳 */
        }
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800" id="calculator-body">

    <!-- PDF 미리보기 모달 -->
    <div id="preview-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-800">PDF 미리보기</h2>
                <div id="modal-actions">
                     <button onclick="generatePdfFromPreview()" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">확인 및 저장</button>
                     <button onclick="closePreviewModal()" class="ml-2 px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">취소</button>
                </div>
            </div>
            <div id="preview-body" class="modal-body">
                <!-- 미리보기 내용이 여기에 삽입됩니다. -->
            </div>
            <div id="loading-spinner" style="display: none;">
                <div class="text-center">
                    <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-600">PDF 파일 생성 중...</p>
                </div>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl font-bold text-gray-900">급여 일할계산기</h1>
            <p class="text-gray-600 mt-2">중도 입/퇴사 및 급여 변경 시 급여를 간편하게 계산하세요.</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 no-print">
            <nav class="flex -mb-px space-x-1" aria-label="Tabs">
                <button onclick="changeTab(event, 'newHire')" class="tab-button active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300 focus:outline-none">
                    🚀 중도입사자
                </button>
                <button onclick="changeTab(event, 'terminator')" class="tab-button whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300 focus:outline-none">
                    👋 중도퇴사자
                </button>
                <button onclick="changeTab(event, 'salaryChange')" class="tab-button whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300 focus:outline-none">
                    💰 중간급여변경자
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="tab-contents">
            <div id="newHire" class="tab-content active space-y-6">
                <div id="nh-employee-list" class="space-y-4 no-print"></div>
                <button onclick="addEmployee('nh')" class="no-print mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">+ 직원 추가</button>
                <div id="nh-print-area" class="bg-indigo-50 p-6 rounded-lg border border-indigo-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-indigo-800">계산 결과 (중도입사자)</h2>
                        <button onclick="showPreview('nh-print-area')" class="no-print px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">PDF 저장</button>
                    </div>
                    <div class="printable-section"><h3 class="text-lg font-semibold mb-2 text-gray-700">당월 지급액</h3><div class="overflow-x-auto"><table id="nh-result-table" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
                    <div class="printable-section mt-8"><h3 class="text-lg font-semibold mb-2 text-gray-700">익월 합산 지급액 (상세)</h3><div class="overflow-x-auto"><table id="nh-next-month-table" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
                </div>
            </div>
            <div id="terminator" class="tab-content space-y-6">
                <div id="t-employee-list" class="space-y-4 no-print"></div>
                <button onclick="addEmployee('t')" class="no-print mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">+ 직원 추가</button>
                <div id="t-print-area" class="bg-indigo-50 p-6 rounded-lg border border-indigo-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-indigo-800">계산 결과 (중도퇴사자)</h2>
                        <button onclick="showPreview('t-print-area')" class="no-print px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">PDF 저장</button>
                    </div>
                    <div class="overflow-x-auto"><table id="t-result-table" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
            <div id="salaryChange" class="tab-content space-y-6">
                <div id="sc-employee-list" class="space-y-4 no-print"></div>
                <button onclick="addEmployee('sc')" class="no-print mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">+ 직원 추가</button>
                <div id="sc-print-area" class="bg-indigo-50 p-6 rounded-lg border border-indigo-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-indigo-800">계산 결과 (중간급여변경자)</h2>
                        <button onclick="showPreview('sc-print-area')" class="no-print px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">PDF 저장</button>
                    </div>
                    <div class="overflow-x-auto"><table id="sc-result-table" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Card Template -->
    <template id="employee-card-template">
        <div class="employee-card">
            <div class="flex justify-end"><button onclick="deleteEmployee(this)" class="text-gray-400 hover:text-red-500 font-bold">&times;</button></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div><label class="block text-sm font-medium text-gray-700">이름</label><input type="text" placeholder="이름" class="employee-name mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                <div><label class="block text-sm font-medium text-gray-700">이벤트 날짜</label><input type="date" class="employee-event-date mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                <div><label class="block text-sm font-medium text-gray-700">급여 시작일자</label><input type="number" value="1" min="1" max="28" class="employee-start-day mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
            </div>
            <div class="salary-section-container"></div>
        </div>
    </template>
    
    <script>
        const getEl = (id) => document.getElementById(id);
        const formatCurrency = (num) => `${Math.floor(num).toLocaleString('ko-KR')}`;
        const formatDate = (date) => date.toLocaleDateString('ko-KR', { timeZone: 'UTC' });
        const DAY_IN_MS = 1000 * 60 * 60 * 24;

        let newItemCounter = 0;

        document.addEventListener('DOMContentLoaded', initialize);
        document.addEventListener('input', handleInput);
        
        function handleInput(e) {
            const tab = e.target.closest('.tab-content');
            if (!tab) return;
            const calculatorMap = {'newHire': calculateNewHire, 'terminator': calculateTerminator, 'salaryChange': calculateSalaryChange};
            const calculator = calculatorMap[tab.id];
            if (calculator) calculator();
        }

        function changeTab(event, tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            getEl(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        let employeeIdCounter = 0;
        function addEmployee(prefix) {
            const template = getEl('employee-card-template').content.cloneNode(true);
            const card = template.querySelector('.employee-card');
            employeeIdCounter++;
            card.dataset.id = `emp-${employeeIdCounter}`;
            const dateLabel = card.querySelector('.grid > div:nth-child(2) > label');
            const salaryContainer = card.querySelector('.salary-section-container');
            if (prefix === 'nh') dateLabel.textContent = '입사일';
            else if (prefix === 't') dateLabel.textContent = '퇴사일';
            else if (prefix === 'sc') dateLabel.textContent = '급여 변경일';
            if (prefix === 'sc') {
                salaryContainer.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div><h3 class="font-medium text-gray-800 mb-2">변경 전 월 지급액</h3><div class="old-salary-items space-y-3"></div><button onclick="addSalaryItem(this.previousElementSibling)" class="mt-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">+ 항목 추가</button></div><div><h3 class="font-medium text-gray-800 mb-2">변경 후 월 지급액</h3><div class="new-salary-items space-y-3"></div><button onclick="addSalaryItem(this.previousElementSibling)" class="mt-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">+ 항목 추가</button></div></div>`;
                initializeDefaultItems(card.querySelector('.old-salary-items'));
                initializeDefaultItems(card.querySelector('.new-salary-items'));
            } else {
                 salaryContainer.innerHTML = `<div><h3 class="font-medium text-gray-800 mb-2">월 지급액 (세전)</h3><div class="salary-items space-y-3"></div><button onclick="addSalaryItem(this.previousElementSibling)" class="mt-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">+ 항목 추가</button></div>`;
                initializeDefaultItems(card.querySelector('.salary-items'));
            }
            getEl(`${prefix}-employee-list`).appendChild(template);
            handleInput({ target: card });
        }
        
        function deleteEmployee(btn) {
            const card = btn.closest('.employee-card');
            const container = card.closest('.tab-content');
            card.remove();
            handleInput({ target: container });
        }

        function addSalaryItem(container, name = '', value = '') {
            const isNewUserItem = (name === '' && value === '');
            if (isNewUserItem) { newItemCounter++; name = `새 항목 ${newItemCounter}`; }
            const div = document.createElement('div');
            div.className = 'salary-item flex items-center space-x-2';
            div.innerHTML = `<input type="text" value="${name}" placeholder="항목명" class="item-name block w-2/5 rounded-md border-gray-300 shadow-sm text-sm" onfocus="this.select()"><input type="number" value="${value}" placeholder="금액" class="item-value block w-3/5 rounded-md border-gray-300 shadow-sm text-sm"><button onclick="deleteSalaryItem(this)" class="text-gray-400 hover:text-red-500">&times;</button>`;
            container.appendChild(div);
            if (isNewUserItem) { container.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));}
        }

        function deleteSalaryItem(btn) {
            const item = btn.closest('.salary-item');
            const container = item.closest('.tab-content');
            item.remove();
            handleInput({ target: container });
        }
        
        function initializeDefaultItems(container) {
            ['기본급', '식대', '차량유지비', '기타수당'].forEach(name => addSalaryItem(container, name, ''));
        }

        function getPayPeriodInfo(eventDateStr, startDay) {
            if (!eventDateStr || !startDay) return null;
            const eventDateParts = eventDateStr.split('-').map(Number);
            const eventDate = new Date(Date.UTC(eventDateParts[0], eventDateParts[1] - 1, eventDateParts[2]));
            const year = eventDate.getUTCFullYear();
            const month = eventDate.getUTCMonth();
            const day = eventDate.getUTCDate();
            let periodStartDate, periodEndDate;
            if (day < startDay) {
                periodEndDate = new Date(Date.UTC(year, month, startDay - 1));
                periodStartDate = new Date(Date.UTC(year, month - 1, startDay));
            } else {
                periodStartDate = new Date(Date.UTC(year, month, startDay));
                periodEndDate = new Date(Date.UTC(year, month + 1, startDay - 1));
            }
            const periodTotalDays = Math.round((periodEndDate.getTime() - periodStartDate.getTime()) / DAY_IN_MS) + 1;
            return { periodStartDate, periodEndDate, periodTotalDays };
        }
        
        function getSalaryData(card, selector) {
            const salaryMap = new Map();
            card.querySelectorAll(`${selector} .salary-item`).forEach(item => {
                const name = item.querySelector('.item-name').value.trim() || '미지정';
                const value = parseFloat(item.querySelector('.item-value').value) || 0;
                if (name) salaryMap.set(name, (salaryMap.get(name) || 0) + value);
            });
            return salaryMap;
        }

        function collectUniqueSalaryItems(employeeListSelector) {
            const orderedNames = [];
            const itemNames = new Set();
            document.querySelectorAll(`${employeeListSelector} .item-name`).forEach(input => {
                const name = input.value.trim();
                if (name && !itemNames.has(name)) { itemNames.add(name); orderedNames.push(name); }
            });
            return orderedNames;
        }

        function calculateNewHire() {
            const prefix = 'nh';
            const currentMonthTable = getEl(`${prefix}-result-table`);
            const nextMonthTable = getEl(`${prefix}-next-month-table`);
            const employeeListSelector = `#${prefix}-employee-list`;
            const salaryItems = collectUniqueSalaryItems(employeeListSelector);
            let currentMonthHeaderHTML = `<tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">산정기간</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">근무일수</th>`;
            salaryItems.forEach(item => currentMonthHeaderHTML += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">${item}</th>`);
            currentMonthHeaderHTML += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">총 지급액</th></tr>`;
            currentMonthTable.querySelector('thead').innerHTML = currentMonthHeaderHTML;
            let nextMonthHeaderHTML = `<tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th>`;
            salaryItems.forEach(item => nextMonthHeaderHTML += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">${item} (합산)</th>`);
            nextMonthHeaderHTML += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">총 합산 지급액</th></tr>`;
            nextMonthTable.querySelector('thead').innerHTML = nextMonthHeaderHTML;
            const currentMonthBody = currentMonthTable.querySelector('tbody');
            const nextMonthBody = nextMonthTable.querySelector('tbody');
            currentMonthBody.innerHTML = '';
            nextMonthBody.innerHTML = '';
            document.querySelectorAll(`${employeeListSelector} .employee-card`).forEach(card => {
                const startDay = parseInt(card.querySelector('.employee-start-day').value, 10);
                const name = card.querySelector('.employee-name').value || '직원';
                const eventDateVal = card.querySelector('.employee-event-date').value;
                const periodInfo = getPayPeriodInfo(eventDateVal, startDay);
                let currentMonthRow = currentMonthBody.insertRow();
                let nextMonthRow = nextMonthBody.insertRow();
                if (!periodInfo || !eventDateVal) {
                    const colspanCurrent = salaryItems.length + 4;
                    const colspanNext = salaryItems.length + 2;
                    currentMonthRow.innerHTML = `<td colspan="${colspanCurrent}" class="px-4 py-4 text-center text-sm text-gray-500">날짜를 입력해주세요.</td>`;
                    nextMonthRow.innerHTML = `<td colspan="${colspanNext}" class="px-4 py-4 text-center text-sm text-gray-500">날짜를 입력해주세요.</td>`;
                    return;
                }
                const { periodStartDate, periodEndDate, periodTotalDays } = periodInfo;
                const eventDateParts = eventDateVal.split('-').map(Number);
                const eventDate = new Date(Date.UTC(eventDateParts[0], eventDateParts[1] - 1, eventDateParts[2]));
                const effectiveHireDate = eventDate < periodStartDate ? periodStartDate : eventDate;
                const workDays = eventDate > periodEndDate ? 0 : Math.round((periodEndDate.getTime() - effectiveHireDate.getTime()) / DAY_IN_MS) + 1;
                const salaryData = getSalaryData(card, '.salary-items');
                let totalProratedSalary = 0;
                let currentMonthRowHTML = `<td class="px-4 py-4 text-sm font-medium text-gray-900">${name}</td><td class="px-4 py-4 text-sm text-gray-500">${formatDate(effectiveHireDate)} ~ ${formatDate(periodEndDate)}</td><td class="px-4 py-4 text-sm text-gray-500">${workDays} / ${periodTotalDays}일</td>`;
                salaryItems.forEach(item => {
                    const proratedItemValue = (salaryData.get(item) || 0) / periodTotalDays * workDays;
                    totalProratedSalary += Math.floor(proratedItemValue);
                    currentMonthRowHTML += `<td class="px-4 py-4 text-sm text-right">${formatCurrency(proratedItemValue)}</td>`;
                });
                currentMonthRowHTML += `<td class="px-4 py-4 text-sm text-gray-800 font-semibold text-right">${formatCurrency(totalProratedSalary)} 원</td>`;
                currentMonthRow.innerHTML = currentMonthRowHTML;
                let totalCombinedSalary = 0;
                let nextMonthRowHTML = `<td class="px-4 py-4 text-sm font-medium text-gray-900">${name}</td>`;
                salaryItems.forEach(item => {
                    const fullMonthValue = salaryData.get(item) || 0;
                    const combinedItemValue = (fullMonthValue / periodTotalDays * workDays) + fullMonthValue;
                    totalCombinedSalary += Math.floor(combinedItemValue);
                    nextMonthRowHTML += `<td class="px-4 py-4 text-sm text-right">${formatCurrency(combinedItemValue)}</td>`;
                });
                nextMonthRowHTML += `<td class="px-4 py-4 text-sm text-gray-800 font-semibold text-right">${formatCurrency(totalCombinedSalary)} 원</td>`;
                nextMonthRow.innerHTML = nextMonthRowHTML;
            });
        }
        
        function calculateTerminator() {
            const prefix = 't';
            const table = getEl(`${prefix}-result-table`);
            const employeeListSelector = `#${prefix}-employee-list`;
            const salaryItems = collectUniqueSalaryItems(employeeListSelector);
            let headerHTML = `<tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">산정기간</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">근무일수</th>`;
            salaryItems.forEach(item => headerHTML += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">${item}</th>`);
            headerHTML += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">총 지급액</th></tr>`;
            table.querySelector('thead').innerHTML = headerHTML;
            const body = table.querySelector('tbody');
            body.innerHTML = '';
            document.querySelectorAll(`${employeeListSelector} .employee-card`).forEach(card => {
                const startDay = parseInt(card.querySelector('.employee-start-day').value, 10);
                const name = card.querySelector('.employee-name').value || '직원';
                const eventDateVal = card.querySelector('.employee-event-date').value;
                const periodInfo = getPayPeriodInfo(eventDateVal, startDay);
                let row = body.insertRow();
                if (!periodInfo || !eventDateVal) {
                    row.innerHTML = `<td colspan="${salaryItems.length + 4}" class="px-4 py-4 text-center text-sm text-gray-500">날짜를 입력해주세요.</td>`;
                    return;
                }
                const { periodStartDate, periodEndDate, periodTotalDays } = periodInfo;
                const eventDate = new Date(Date.UTC(...eventDateVal.split('-').map((n, i) => i === 1 ? n - 1 : n)));
                const effectiveTermDate = eventDate > periodEndDate ? periodEndDate : eventDate;
                const workDays = eventDate < periodStartDate ? 0 : Math.round((effectiveTermDate.getTime() - periodStartDate.getTime()) / DAY_IN_MS) + 1;
                const salaryData = getSalaryData(card, '.salary-items');
                let totalProratedSalary = 0;
                let rowHTML = `<td class="px-4 py-4 text-sm font-medium text-gray-900">${name}</td><td class="px-4 py-4 text-sm text-gray-500">${formatDate(periodStartDate)} ~ ${formatDate(effectiveTermDate)}</td><td class="px-4 py-4 text-sm text-gray-500">${workDays} / ${periodTotalDays}일</td>`;
                salaryItems.forEach(item => {
                    const proratedItemValue = (salaryData.get(item) || 0) / periodTotalDays * workDays;
                    totalProratedSalary += Math.floor(proratedItemValue);
                    rowHTML += `<td class="px-4 py-4 text-sm text-right">${formatCurrency(proratedItemValue)}</td>`;
                });
                rowHTML += `<td class="px-4 py-4 text-sm text-gray-800 font-semibold text-right">${formatCurrency(totalProratedSalary)} 원</td>`;
                row.innerHTML = rowHTML;
            });
        }
        
        function calculateSalaryChange() {
             const prefix = 'sc';
            const table = getEl(`${prefix}-result-table`);
            const employeeListSelector = `#${prefix}-employee-list`;
            const salaryItems = collectUniqueSalaryItems(employeeListSelector);
            let headerHTML = `<tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이름</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">산정기간</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">변경 전/후 일수</th>`;
            salaryItems.forEach(item => headerHTML += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">${item}</th>`);
            headerHTML += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">총 지급액</th></tr>`;
            table.querySelector('thead').innerHTML = headerHTML;
            const body = table.querySelector('tbody');
            body.innerHTML = '';
            document.querySelectorAll(`${employeeListSelector} .employee-card`).forEach(card => {
                const startDay = parseInt(card.querySelector('.employee-start-day').value, 10);
                const name = card.querySelector('.employee-name').value || '직원';
                const eventDateVal = card.querySelector('.employee-event-date').value;
                const periodInfo = getPayPeriodInfo(eventDateVal, startDay);
                let row = body.insertRow();
                if (!periodInfo || !eventDateVal) {
                     row.innerHTML = `<td colspan="${salaryItems.length + 4}" class="px-4 py-4 text-center text-sm text-gray-500">날짜를 입력해주세요.</td>`;
                    return;
                }
                const { periodStartDate, periodEndDate, periodTotalDays } = periodInfo;
                const eventDate = new Date(Date.UTC(...eventDateVal.split('-').map((n, i) => i === 1 ? n - 1 : n)));
                const oldDays = eventDate <= periodStartDate ? 0 : Math.round((eventDate.getTime() - periodStartDate.getTime()) / DAY_IN_MS);
                const newDays = periodTotalDays - oldDays;
                const oldSalary = getSalaryData(card, '.old-salary-items');
                const newSalary = getSalaryData(card, '.new-salary-items');
                let totalCombinedSalary = 0;
                let rowHTML = `<td class="px-4 py-4 text-sm font-medium text-gray-900">${name}</td><td class="px-4 py-4 text-sm text-gray-500">${formatDate(periodStartDate)} ~ ${formatDate(periodEndDate)}</td><td class="px-4 py-4 text-sm text-gray-500">${oldDays} / ${newDays}일</td>`;
                salaryItems.forEach(item => {
                    const oldVal = oldSalary.get(item) || 0;
                    const newVal = newSalary.get(item) || 0;
                    const combinedItemValue = (oldVal / periodTotalDays * oldDays) + (newVal / periodTotalDays * newDays);
                    totalCombinedSalary += Math.floor(combinedItemValue);
                    rowHTML += `<td class="px-4 py-4 text-sm text-right">${formatCurrency(combinedItemValue)}</td>`;
                });
                rowHTML += `<td class="px-4 py-4 text-sm text-gray-800 font-semibold text-right">${formatCurrency(totalCombinedSalary)} 원</td>`;
                row.innerHTML = rowHTML;
            });
        }
        
        function initialize() {
            ['nh', 't', 'sc'].forEach(prefix => {
                getEl(`${prefix}-employee-list`).innerHTML = '';
                addEmployee(prefix);
            });
        }

        // --- PDF 생성 로직 (A4 최적화) ---

        function showPreview(areaId) {
            const originalElement = getEl(areaId);
            if (!originalElement) return;
            const contentToPreview = originalElement.cloneNode(true);
            contentToPreview.style.backgroundColor = 'white';
            contentToPreview.querySelectorAll('*').forEach(el => el.style.color = '#111827');
            contentToPreview.querySelectorAll('button').forEach(btn => btn.remove());
            contentToPreview.querySelectorAll('.overflow-x-auto').forEach(div => {
                div.classList.remove('overflow-x-auto');
                div.style.overflow = 'visible';
            });

            // 스케일링을 미리보기에만 적용
            const A4_LANDSCAPE_CONTENT_WIDTH_PX = 1050; 
            const contentWidth = contentToPreview.scrollWidth;
            if (contentWidth > A4_LANDSCAPE_CONTENT_WIDTH_PX) {
                const scale = A4_LANDSCAPE_CONTENT_WIDTH_PX / contentWidth;
                contentToPreview.style.zoom = scale;
            }

            const previewBody = getEl('preview-body');
            previewBody.innerHTML = '';
            previewBody.appendChild(contentToPreview);
            getEl('preview-modal').style.display = 'flex';
        }

        function closePreviewModal() {
            getEl('preview-modal').style.display = 'none';
            getEl('preview-body').innerHTML = '';
        }

        async function generatePdfFromPreview() {
            const modalActions = getEl('modal-actions');
            const loadingSpinner = getEl('loading-spinner');
            const previewBody = getEl('preview-body');
            
            modalActions.style.display = 'none';
            loadingSpinner.style.display = 'block';

            const originalId = previewBody.querySelector(':first-child').id;
            const originalElement = getEl(originalId);

            const contentToPrint = originalElement.cloneNode(true);
            contentToPrint.style.backgroundColor = 'white';
            contentToPrint.style.padding = '1rem'; 
            contentToPrint.querySelectorAll('*').forEach(el => el.style.color = '#111827');
            contentToPrint.querySelectorAll('button').forEach(btn => btn.remove());
            contentToPrint.querySelectorAll('.overflow-x-auto').forEach(div => {
                div.classList.remove('overflow-x-auto');
                div.style.overflow = 'visible';
            });
            
            document.body.appendChild(contentToPrint);

            const titleElement = contentToPrint.querySelector('h2');
            const title = titleElement ? titleElement.textContent.trim() : '급여계산결과';
            const filename = `${title}_${new Date().toISOString().slice(0, 10)}.pdf`;

            try {
                const canvas = await html2canvas(contentToPrint, {
                    scale: 2,
                    useCORS: true,
                    scrollX: 0,
                    scrollY: -window.scrollY
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 0.98);
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;

                const { jsPDF } = window.jspdf;
                // A4 가로 용지 생성 (단위: pt)
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'pt', 
                    format: 'a4'
                });
                
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                
                const imgProps= doc.getImageProperties(imgData);
                const pdfImageRatio = pdfWidth / pdfHeight;
                const imageRatio = imgProps.width / imgProps.height;

                let finalImgWidth, finalImgHeight;

                if (imageRatio > pdfImageRatio) {
                    // 이미지 너비가 용지 너비에 비해 더 넓은 경우 -> 너비를 기준으로 높이 계산
                    finalImgWidth = pdfWidth;
                    finalImgHeight = pdfWidth / imageRatio;
                } else {
                    // 이미지 높이가 용지 높이에 비해 더 높은 경우 -> 높이를 기준으로 너비 계산
                    finalImgHeight = pdfHeight;
                    finalImgWidth = pdfHeight * imageRatio;
                }
                
                // 이미지를 용지 중앙에 배치하기 위한 위치 계산
                const xPos = (pdfWidth - finalImgWidth) / 2;
                const yPos = (pdfHeight - finalImgHeight) / 2;

                doc.addImage(imgData, 'JPEG', xPos, yPos, finalImgWidth, finalImgHeight);
                doc.save(filename);

            } catch (error) {
                console.error("PDF 생성 중 오류 발생:", error);
                alert("PDF를 생성하는 중에 오류가 발생했습니다. 콘솔을 확인해주세요.");
            } finally {
                document.body.removeChild(contentToPrint);
                loadingSpinner.style.display = 'none';
                modalActions.style.display = 'block';
                closePreviewModal();
            }
        }
    </script>
</body>
</html>

