<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì§€ëŠ¥í˜• ê¸ˆìœµ ë°ì´í„° ë³€í™˜ê¸° v6.0 (ë‹¤ì¤‘ ì‘ì—… ì§€ì›)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .preview-table { border-collapse: collapse; width: 100%; font-size: .8rem; }
        .preview-table th, .preview-table td {
            border: 1px solid #e2e8f0; padding: .375rem .5rem; text-align: left;
            white-space: nowrap; min-width: 20px;
        }
        .preview-table th { background-color: #f8fafc; font-weight: 600; }
        .selectable:hover { background-color: #f0f9ff; cursor: pointer; }
        .highlighted { background-color: #bae6fd !important; }
        .highlight-p3-tradeTypeCol { background-color: #a7f3d0 !important; }
        .highlight-p3-stockNameCol { background-color: #fde68a !important; }
        .highlight-p3-stockQtyCol { background-color: #fecaca !important; }
        .highlight-p3-unitPriceCol { background-color: #d8b4fe !important; }
        .highlight-p3-stockBalanceCol { background-color: #bfdbfe !important; }
        .highlight-p3-additionalCol1, .highlight-p3-additionalCol2 { background-color: #d1d5db !important; }
        
        .drop-zone { min-height: 80px; border: 2px dashed #cbd5e1; background-color: #f8fafc; transition: all 0.2s; }
        .drop-zone.drag-over { background-color: #e0f2fe; border-color: #3b82f6; }
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .sidebar-btn { transition: all 0.2s; }
        .sidebar-btn.active { background-color: #eef2ff; color: #4338ca; font-weight: 600; border-right: 3px solid #4f46e5;}
        .sidebar-btn.completed::after { content: 'âœ”'; margin-left: auto; color: #16a34a; font-weight: bold; }
        .sidebar-btn:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f9fafb; }
        .path-nav-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .path-nav-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; font-weight: 600; }
        .path-nav-btn.completed { color: #16a34a; }
        .selection-box { cursor: pointer; transition: all 0.2s; }
        .selection-box.selecting { border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .modal { transition: opacity 0.25s ease; }
        .task-item { transition: all 0.2s; }
        .task-item.active { background-color: #eef2ff; border-left-color: #4f46e5; }
        #paste-area:empty::before {
            content: attr(placeholder);
            color: #64748b; /* text-slate-500 */
            cursor: text;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-slate-900">ì§€ëŠ¥í˜• ê¸ˆìœµ ë°ì´í„° ë³€í™˜ê¸° v6.0</h1>
            <p class="text-slate-600 mt-2">ì—¬ëŸ¬ ê°œì˜ ì—‘ì…€ íŒŒì¼/ì‹œíŠ¸ë¥¼ í•˜ë‚˜ì˜ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì²˜ë¦¬í•˜ì„¸ìš”.</p>
        </header>

        <!-- 1. ë°ì´í„° ì†ŒìŠ¤ ì¶”ê°€ -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold border-b pb-3 mb-4">1. ë³€í™˜í•  ë°ì´í„° ì¶”ê°€</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="space-y-3">
                        <label for="single-file-upload" class="w-full text-center block px-4 py-2 bg-gray-100 border border-slate-300 text-slate-700 rounded-md hover:bg-slate-50 cursor-pointer">ë‹¨ì¼íŒŒì¼ì„ íƒ(ì—¬ëŸ¬ ì‹œíŠ¸ í¬í•¨ ê°€ëŠ¥)</label>
                        <input id="single-file-upload" type="file" class="hidden" accept=".xlsx, .xls">
                        <label for="multi-file-upload" class="w-full text-center block px-4 py-2 bg-gray-100 border border-slate-300 text-slate-700 rounded-md hover:bg-slate-50 cursor-pointer">ì—¬ëŸ¬ íŒŒì¼ í•œë²ˆì— ì„ íƒ</label>
                        <input id="multi-file-upload" type="file" class="hidden" accept=".xlsx, .xls" multiple>
                        <div id="paste-area" class="p-4 min-h-[80px] border-2 border-dashed rounded-lg flex items-center justify-center text-slate-500 hover:border-indigo-400" contenteditable="true" placeholder="ì—‘ì…€ ë°ì´í„° ë³µì‚¬ í›„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° (Ctrl+V)"></div>
                    </div>
                </div>
                <div id="source-list-container" class="bg-slate-50 p-4 rounded-md border max-h-60 overflow-y-auto">
                    <h3 class="font-semibold text-lg mb-2 text-slate-700">ì‘ì—… ëª©ë¡</h3>
                    <ul id="source-list" class="space-y-2">
                        <p class="text-slate-500 text-center py-4">íŒŒì¼ì„ ì¶”ê°€í•˜ê±°ë‚˜ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 2. ë³€í™˜ ì‘ì—… -->
        <div id="wizard-container" class="bg-white p-6 rounded-lg shadow-md hidden">
             <h2 class="text-xl font-bold border-b pb-3 mb-4 flex items-center gap-2">
                <span>2. ì‹œíŠ¸ëª…(ì…ë ¥ ë° ìˆ˜ì • ê°€ëŠ¥):</span>
                <input type="text" id="active-task-name-input" class="text-indigo-600 font-bold p-1 border-b-2 border-transparent focus:border-indigo-500 outline-none bg-transparent flex-1 min-w-0">
            </h2>
            <div id="app" class="flex h-full min-h-[500px]">
                <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 p-4 space-y-2">
                    <!-- JS ë Œë”ë§ ì˜ì—­ -->
                </aside>
                <main class="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50 rounded-r-lg">
                    <div id="main-content" class="max-w-6xl mx-auto">
                        <!-- JS ë Œë”ë§ ì˜ì—­ -->
                    </div>
                </main>
            </div>
        </div>
        
        <!-- 3. ê²°ê³¼ ë‹¤ìš´ë¡œë“œ -->
        <div id="download-section" class="bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-bold border-b pb-3 mb-4">3. ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</h2>
            <p class="text-slate-600 mb-4">ì‘ì—…ì´ ì™„ë£Œëœ ë°ì´í„°ë“¤ì„ ë‹¨ê³„ë³„ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° ì‘ì—…ì€ ë³„ë„ì˜ ì‹œíŠ¸ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            <div class="flex flex-wrap gap-4">
                <button id="download-phase3-btn" class="px-5 py-2.5 bg-sky-500 text-white rounded-md hover:bg-sky-600 disabled:bg-sky-300">3ë‹¨ê³„: ì ìš” ìƒì„± ê²°ê³¼</button>
                <button id="download-phase4-btn" class="px-5 py-2.5 bg-rose-500 text-white rounded-md hover:bg-rose-600 disabled:bg-rose-300">4ë‹¨ê³„: ì œê±°ëœ í•­ëª©</button>
                <button id="download-phase5-btn" class="px-5 py-2.5 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 disabled:bg-emerald-300">5ë‹¨ê³„: ìµœì¢… ë³€í™˜ ê²°ê³¼</button>
            </div>
        </div>
    </div>


    <!-- ëª¨ë‹¬ -->
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-slate-800"></h2>
            <p id="modal-message" class="text-slate-600 mb-6"></p>
            <div id="modal-buttons" class="flex justify-end space-x-3">
                <!-- ë²„íŠ¼ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>

    <script>
    /******************************************************************************
     * ì§€ëŠ¥í˜• ê¸ˆìœµ ë°ì´í„° ë³€í™˜ê¸° v6.0 (ë‹¤ì¤‘ ì‘ì—… ì§€ì›)
     ******************************************************************************/
    
    // --- 1. ìƒíƒœ ê´€ë¦¬ (State Management) ---
    const AppState = {
        _state: {},
        _listeners: [],
        init() {
            this._state = {
                sources: [], // { id, name, rawData, status ('pending', 'active', 'completed'), currentPhase, phases: {...} }
                activeSourceId: null,
            };
        },
        getState() { return this._state; },
        setState(updater) {
            const oldState = JSON.parse(JSON.stringify(this._state));
            this._state = typeof updater === 'function' ? updater(oldState) : { ...oldState, ...updater };
            console.log("State Updated:", this._state);
            this.notify();
        },
        subscribe(listener) { this._listeners.push(listener); },
        notify() { this._listeners.forEach(listener => listener()); },
        getActiveSource() {
            if (!this._state.activeSourceId) return null;
            return this._state.sources.find(s => s.id === this._state.activeSourceId);
        }
    };

    // --- 2. UI ë Œë”ë§ (UI Rendering) ---
    const UIRenderer = {
        init() {
            // Cache DOM elements
            this.sourceListEl = document.getElementById('source-list');
            this.wizardContainerEl = document.getElementById('wizard-container');
            this.activeTaskNameInputEl = document.getElementById('active-task-name-input');
            this.sidebarEl = document.getElementById('sidebar');
            this.mainContentEl = document.getElementById('main-content');
            this.downloadSectionEl = document.getElementById('download-section');
            this.modalEl = document.getElementById('modal');
            this.modalTitleEl = document.getElementById('modal-title');
            this.modalMessageEl = document.getElementById('modal-message');
            this.modalButtonsEl = document.getElementById('modal-buttons');
            AppState.subscribe(() => this.render());

            // Attach listeners for static elements ONCE to prevent duplication
            document.getElementById('single-file-upload').addEventListener('change', AppController.handleFileUpload);
            document.getElementById('multi-file-upload').addEventListener('change', AppController.handleFileUpload);
            document.getElementById('paste-area').addEventListener('paste', AppController.handlePaste);
            document.getElementById('download-phase3-btn').addEventListener('click', () => AppController.handleDownload('phase3'));
            document.getElementById('download-phase4-btn').addEventListener('click', () => AppController.handleDownload('phase4'));
            document.getElementById('download-phase5-btn').addEventListener('click', () => AppController.handleDownload('phase5'));
        },
        render() {
            this.renderSourceList();
            this.renderWizard();
            this.renderDownloadSection();
            this.attachTopLevelEventListeners();
        },
        renderSourceList() {
            const { sources } = AppState.getState();
            if (sources.length === 0) {
                this.sourceListEl.innerHTML = `<p class="text-slate-500 text-center py-4">íŒŒì¼ì„ ì¶”ê°€í•˜ê±°ë‚˜ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>`;
                return;
            }
            this.sourceListEl.innerHTML = sources.map(source => {
                let statusBadge = '';
                if (source.status === 'completed') {
                    statusBadge = `<span class="text-xs font-bold text-green-600">âœ” ì™„ë£Œ</span>`;
                } else if (source.status === 'active') {
                    statusBadge = `<span class="text-xs font-bold text-indigo-600">ì‘ì—…ì¤‘...</span>`;
                }
                return `
                    <li data-source-id="${source.id}" class="task-item flex items-center justify-between p-2 rounded-md border-l-4 ${source.status === 'active' ? 'active' : 'border-transparent'} hover:bg-slate-100 cursor-pointer">
                        <div class="flex-1 min-w-0">
                             <p class="truncate text-sm font-medium text-slate-800">${source.name}</p>
                             ${statusBadge}
                        </div>
                        <button data-delete-id="${source.id}" class="delete-source-btn ml-2 text-slate-400 hover:text-red-600 text-lg">&times;</button>
                    </li>
                `;
            }).join('');
        },
        renderWizard() {
            const activeSource = AppState.getActiveSource();
            if (!activeSource) {
                this.wizardContainerEl.classList.add('hidden');
                return;
            }
            this.wizardContainerEl.classList.remove('hidden');
            this.activeTaskNameInputEl.value = activeSource.name;
            
            this.sidebarEl.innerHTML = this.renderSidebar(activeSource);
            this.mainContentEl.innerHTML = this.renderPhaseView(activeSource);
            this.attachWizardEventListeners();
        },
        renderDownloadSection() {
            const { sources } = AppState.getState();
            const completedSources = sources.filter(s => s.status === 'completed');

            if (completedSources.length > 0) {
                this.downloadSectionEl.classList.remove('hidden');
            } else {
                this.downloadSectionEl.classList.add('hidden');
            }

            document.getElementById('download-phase3-btn').disabled = completedSources.length === 0;
            document.getElementById('download-phase4-btn').disabled = completedSources.length === 0;
            document.getElementById('download-phase5-btn').disabled = completedSources.length === 0;
        },
        renderSidebar(source) {
            const phases = [
                { id: 'phase1', name: '1. í–‰ ë³‘í•©' }, { id: 'phase2', name: '2. í†µí™”ë³„ ë¶„ë¦¬' }, 
                { id: 'phase3', name: '3. ì ìš” ìƒì„±' }, { id: 'phase4', name: '4. í•­ëª© ì œê±°' }, 
                { id: 'phase5', name: '5. ìµœì¢… ë³€í™˜' }, { id: 'download', name: 'ì‘ì—… ì™„ë£Œ' }
            ];
            let buttonsHTML = phases.map(phase => {
                const phaseState = source.phases[phase.id];
                const isEnabled = phase.id === 'phase1' || source.phases[this.getPrevPhase(phase.id)]?.isComplete;
                return `<button data-phase="${phase.id}" class="sidebar-btn w-full flex items-center text-left px-3 py-2 rounded-md text-slate-700 hover:bg-slate-100 ${source.currentPhase === phase.id ? 'active' : ''} ${phaseState?.isComplete ? 'completed' : ''}" ${!isEnabled ? 'disabled' : ''}>${phase.name}</button>`;
            }).join('');
            return `<div class="flex-1"><h2 class="text-lg font-bold text-slate-800 px-2 mb-4">ë³€í™˜ ë‹¨ê³„</h2><div class="space-y-1">${buttonsHTML}</div></div><div class="pt-4 border-t"><button id="complete-task-btn" class="w-full text-sm px-3 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200">í˜„ì¬ ì‘ì—… ì™„ë£Œ</button><button id="reset-btn" class="w-full text-sm px-3 py-2 mt-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200">í˜„ì¬ ì‘ì—… ì´ˆê¸°í™”</button></div>`;
        },
        renderPhaseView(source) {
            switch(source.currentPhase) {
                case 'phase1': return this.renderPhase1View(source);
                case 'phase2': return this.renderPhase2View(source);
                case 'phase3': return this.renderPhase3View(source);
                case 'phase4': return this.renderPhase4View(source);
                case 'phase5': return this.renderPhase5View(source);
                case 'download': return this.renderDownloadView();
                default: return `<div class="text-center py-10"><h1 class="text-2xl font-bold">ì˜¤ë¥˜</h1><p class="text-slate-600 mt-2">ì•Œ ìˆ˜ ì—†ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.</p></div>`;
            }
        },
        renderPhase1View(source) { const { rawData } = source; const { headerRows } = source.phases.phase1.config; let tableHTML = this.generateTableHTML(rawData.slice(0, 20), { selectable: 'row', selectedRows: headerRows }); return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">1ë‹¨ê³„: í–‰ ë³‘í•©</h1><p class="text-slate-600 mt-2">ë°˜ë³µë˜ëŠ” ì œëª© í–‰ì„ ëª¨ë‘ í´ë¦­í•˜ì„¸ìš”.</p></header><div class="flex items-center space-x-3"><button id="process-phase1-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-300" ${headerRows.length === 0 ? 'disabled' : ''}>ì‹¤í–‰ & ë‹¤ìŒ ë‹¨ê³„ë¡œ</button><button id="reset-phase1-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ì„ íƒ ì´ˆê¸°í™”</button></div><div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div></div>`; },
        renderPhase2View(source) {
            const data = source.phases.phase1.output; if (!data) return `<p>1ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            const { splitCol, groups } = source.phases.phase2.config;
            let tableHTML = this.generateTableHTML(data.slice(0, 10), { selectable: 'col', selectedCols: splitCol !== null ? [splitCol] : [] });
            let contentHTML = `<p class="text-slate-600 mt-2">ë°ì´í„°ë¥¼ í†µí™”(KRW, USD ë“±)ì— ë”°ë¼ ë¶„ë¦¬í•  ê¸°ì¤€ ì—´ì„ ì„ íƒí•˜ì„¸ìš”.<br>ëª¨ë“  ê±°ë˜ê°€ ë‹¨ì¼ í†µí™”ì¸ ê²½ìš°, ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div>`;
            if (splitCol !== null) {
                const uniqueValues = [...new Set(data.slice(1).map(row => row[splitCol]).filter(Boolean))];
                const groupedValues = groups.flatMap(g => g.values);
                const sourceItems = uniqueValues.filter(v => !groupedValues.includes(v));
                const groupsHTML = groups.map((group, index) => `<div class="p-4 rounded-lg bg-white border"><input type="text" value="${group.name}" data-group-index="${index}" class="group-name-input font-semibold mb-2 border-b-2 w-full p-1" placeholder="ê·¸ë£¹ ì´ë¦„ ì…ë ¥"><div id="drop-zone-${index}" class="drop-zone p-2 rounded flex flex-wrap gap-2" data-zone-id="${index}">${group.values.map(val => `<div class="draggable-item bg-blue-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div>`).join('');
                contentHTML += `<p class="text-slate-600 mt-4 font-semibold">ì„ íƒí•œ ì—´ì˜ ê³ ìœ ê°’ì„ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ì–´ì£¼ì„¸ìš”.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">ê³ ìœ ê°’ (ë“œë˜ê·¸)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="space-y-4">${groupsHTML}<button id="add-group-btn" class="w-full px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">+ ê·¸ë£¹ ì¶”ê°€</button></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">2ë‹¨ê³„: í†µí™”ë³„ ë¶„ë¦¬</h1></header>${contentHTML}<div class="flex items-center space-x-3 mt-4"><button id="process-phase2-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">ì‹¤í–‰ & ë‹¤ìŒ ë‹¨ê³„ë¡œ</button></div></div>`;
        },
        renderPhase3View(source) {
            const dataSets = source.phases.phase2.output; if (!dataSets || dataSets.length === 0) return `<p>2ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            const { activePath, selectingKey } = source.phases.phase3;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 2ë‹¨ê³„ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            const config = source.phases.phase3.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${source.phases.phase3.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            const prompts = [ { key: 'tradeTypeCol', text: 'ê±°ë˜ì¢…ë¥˜' }, { key: 'stockNameCol', text: 'ì¢…ëª©' }, { key: 'stockQtyCol', text: 'ê±°ë˜ì£¼ì‹ìˆ˜' }, { key: 'unitPriceCol', text: 'ë‹¨ê°€' }, { key: 'stockBalanceCol', text: 'ì£¼ì‹ì”ê³ ' }, { key: 'additionalCol1', text: 'ì¶”ê°€ì ìš” 1' }, { key: 'additionalCol2', text: 'ì¶”ê°€ì ìš” 2' } ];
            let selectionUI = prompts.map(p => { const isSelecting = selectingKey === p.key; const valueText = config[p.key] !== undefined && currentData[0][config[p.key]] ? `[${config[p.key] + 1}ì—´] ${currentData[0][config[p.key]]}` : 'ë¯¸ì„ íƒ'; return `<div data-key="${p.key}" class="selection-box p-2 border rounded-md ${isSelecting ? 'selecting' : ''}"><label class="font-medium text-sm pointer-events-none">${p.text}: </label><span class="font-bold text-indigo-600 pointer-events-none">${valueText}</span></div>`; }).join('');
            let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col', highlightMapping: { 'highlight-p3-tradeTypeCol': config.tradeTypeCol, 'highlight-p3-stockNameCol': config.stockNameCol, 'highlight-p3-stockQtyCol': config.stockQtyCol, 'highlight-p3-unitPriceCol': config.unitPriceCol, 'highlight-p3-stockBalanceCol': config.stockBalanceCol, 'highlight-p3-additionalCol1': config.additionalCol1, 'highlight-p3-additionalCol2': config.additionalCol2, } });
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">3ë‹¨ê³„: ì£¼ì‹ ì ìš” ìƒì„±</h1></header><div class="flex border-b">${pathNav}</div><p class="text-slate-600 mt-2">ì•„ë˜ í•­ëª©ì„ í´ë¦­í•œ ë’¤, í•´ë‹¹í•˜ëŠ” ì—´ì„ í…Œì´ë¸”ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.</p><div class="grid grid-cols-2 md:grid-cols-4 gap-2">${selectionUI}</div><div class="flex items-center space-x-3 mt-4"><button id="process-phase3-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">í˜„ì¬ í†µí™” ì ìš© & ë‹¤ìŒìœ¼ë¡œ</button><button id="reset-phase3-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ì„ íƒ ì´ˆê¸°í™”</button></div><div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div></div>`;
        },
        renderPhase4View(source) {
            const dataSets = source.phases.phase3.output; if (!dataSets || dataSets.length === 0) return `<p>3ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            const { activePath } = source.phases.phase4;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 3ë‹¨ê³„ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            const config = source.phases.phase4.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${source.phases.phase4.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            let contentHTML;
            if (config.tradeTypeCol === undefined) {
                let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col' });
                contentHTML = `<p class="text-slate-600 mt-2">ì œê±°í•  í•­ëª©ì˜ ê¸°ì¤€ì´ ë  'ê±°ë˜ì¢…ë¥˜' ì—´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div>`;
            } else {
                const uniqueValues = [...new Set(currentData.slice(1).map(row => row[config.tradeTypeCol]).filter(Boolean))];
                const itemsInZone = config.valuesToRemove || [];
                const sourceItems = uniqueValues.filter(v => !itemsInZone.includes(v));
                contentHTML = `<p class="text-slate-600 mt-2">ì…ì¶œê¸ˆê³¼ ê´€ë ¨ ì—†ëŠ” ê±°ë˜ ì¢…ë¥˜ë¥¼ ì•„ë˜ 'ì œê±°í•  í•­ëª©' ì˜ì—­ìœ¼ë¡œ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”.</p>
                <div class="text-sm text-red-500 mt-2 p-3 bg-slate-100 rounded-md">
                <p class="font-semibold">ì„¤ëª…:</p>
                <p>*ë¯¸ë˜ì—ì…‹ì˜ ê²½ìš° 'ì£¼ì‹ë§¤ìˆ˜(ë§¤ë„) ì…/ì¶œê¸ˆ'ì€ ì œê±°í•  í•­ëª©ìœ¼ë¡œ ë¶„ë¥˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                <p>*ë¯¸ë˜ì—ì…‹ì˜ ê²½ìš° 'í•´ì™¸ì£¼ì‹ë§¤ìˆ˜(ë§¤ë„) ì…/ì¶œê¸ˆ'ì€ ì œê±°í•  í•­ëª©ìœ¼ë¡œ ë¶„ë¥˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                <p>*ë¯¸ë˜ì—ì…‹ì˜ ê²½ìš° 'ì£¼ì‹ë§¤ìˆ˜(ë§¤ë„) ì…/ì¶œê³ 'ëŠ” ì œê±°í•  í•­ëª©ìœ¼ë¡œ ë¶„ë¥˜í•˜ì§€ ë§ì•„ì£¼ì„¸ìš”.</p>
                <p>*ë¯¸ë˜ì—ì…‹ì˜ ê²½ìš° 'í•´ì™¸ì£¼ì‹ë§¤ìˆ˜(ë§¤ë„) ì…/ì¶œê³ 'ëŠ” ì œê±°í•  í•­ëª©ìœ¼ë¡œ ë¶„ë¥˜í•˜ì§€ ë§ì•„ì£¼ì„¸ìš”.</p>
                </div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">ì „ì²´ ê±°ë˜ ì¢…ë¥˜ (ë“œë˜ê·¸)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-red-600">ì œê±°í•  í•­ëª© (ë“œë¡­)</h3><div id="drop-zone-0" class="drop-zone p-2 rounded flex flex-wrap gap-2">${itemsInZone.map(val => `<div class="draggable-item bg-red-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">4ë‹¨ê³„: ë¶ˆí•„ìš” í•­ëª© ì œê±°</h1></header><div class="flex border-b">${pathNav}</div>${contentHTML}<div class="flex items-center space-x-3 mt-4"><button id="process-phase4-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">í˜„ì¬ í†µí™” ì ìš© & ë‹¤ìŒìœ¼ë¡œ</button><button id="reset-phase4-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ì„ íƒ ì´ˆê¸°í™”</button></div></div>`;
        },
        renderPhase5View(source) {
            const dataSets = source.phases.phase4.output; if (!dataSets || dataSets.length === 0) return `<p>4ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            const { activePath, selectingKey } = source.phases.phase5;
            const currentData = dataSets[activePath]?.data; if (!currentData) return `<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 4ë‹¨ê³„ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            const config = source.phases.phase5.config[activePath] || {};
            const pathNav = dataSets.length > 1 ? dataSets.map((set, index) => `<button data-path-index="${index}" class="path-nav-btn px-4 py-2 text-sm ${index === activePath ? 'active' : ''} ${source.phases.phase5.config[index]?.isComplete ? 'completed' : ''}">${set.name}</button>`).join('') : '';
            const prompts = [ { key: 'dateCol', text: 'ì¼ì' }, { key: 'amountCol', text: 'ê±°ë˜ê¸ˆì•¡' }, { key: 'balanceCol', text: 'ì˜ˆìˆ˜ê¸ˆì”ì•¡' }, { key: 'tradeTypeCol', text: 'ê±°ë˜ì¢…ë¥˜' }, { key: 'jukyoCol', text: 'ì ìš”(3ë‹¨ê³„ ê²°ê³¼)' }, { key: 'feeCol', text: 'ìˆ˜ìˆ˜ë£Œ' }, { key: 'taxCol', text: 'ì œì„¸ê¸ˆ' } ];
            let selectionUI = prompts.map(p => { const isSelecting = selectingKey === p.key; const valueText = config[p.key] !== undefined && currentData.length > 0 && currentData[0][config[p.key]] ? `[${config[p.key] + 1}ì—´] ${currentData[0][config[p.key]]}` : 'ë¯¸ì„ íƒ'; return `<div data-key="${p.key}" class="selection-box p-2 border rounded-md ${isSelecting ? 'selecting' : ''}"><label class="font-medium text-sm pointer-events-none">${p.text}: </label><span class="font-bold text-indigo-600 pointer-events-none">${valueText}</span></div>`; }).join('');
            let tableHTML = this.generateTableHTML(currentData.slice(0, 10), { selectable: 'col' });
            let dragDropUI = '';
            if (config.tradeTypeCol !== undefined) {
                const uniqueValues = [...new Set(currentData.slice(1).map(row => row[config.tradeTypeCol]).filter(Boolean))];
                const deposits = config.depositTypes || [];
                const withdrawals = config.withdrawalTypes || [];
                const sourceItems = uniqueValues.filter(v => !deposits.includes(v) && !withdrawals.includes(v));
                dragDropUI = `<div class="flex items-center space-x-4"><p class="text-slate-600 font-semibold">ê±°ë˜ ì¢…ë¥˜ë¥¼ 'ì…ê¸ˆ'ê³¼ 'ì¶œê¸ˆ'ìœ¼ë¡œ ë¶„ë¥˜í•´ì£¼ì„¸ìš”.</p><button id="auto-classify-btn" class="px-3 py-1 bg-yellow-400 text-yellow-900 rounded-md hover:bg-yellow-500 text-sm font-bold">âœ¨ ì”ì•¡ ê¸°ì¤€ìœ¼ë¡œ ìë™ ë¶„ë¥˜</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2"><div class="p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">ê±°ë˜ ì¢…ë¥˜ (ë“œë˜ê·¸)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2">${sourceItems.map(val => `<div class="draggable-item bg-white px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-blue-600">ì…ê¸ˆ í•­ëª©</h3><div id="drop-zone-deposit" class="drop-zone p-2 rounded flex flex-wrap gap-2">${deposits.map(val => `<div class="draggable-item bg-blue-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="p-4 rounded-lg bg-white border"><h3 class="font-semibold mb-2 text-red-600">ì¶œê¸ˆ í•­ëª©</h3><div id="drop-zone-withdrawal" class="drop-zone p-2 rounded flex flex-wrap gap-2">${withdrawals.map(val => `<div class="draggable-item bg-red-100 px-3 py-1 rounded shadow-sm border" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div></div>`;
            }
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">5ë‹¨ê³„: ìµœì¢… ë³€í™˜</h1></header><div class="flex border-b">${pathNav}</div><p class="text-slate-600 mt-2">ìµœì¢… ë³€í™˜ì— í•„ìš”í•œ ì—´ë“¤ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.</p><div class="overflow-x-auto border rounded-lg bg-white shadow-sm my-4">${tableHTML}</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2">${selectionUI}</div><div><label class="font-medium text-sm">ê¸°ì´ˆê°€ì•¡: </label><input id="base-amount-input" type="number" value="${config.baseAmount || 0}" class="p-2 border rounded-md"></div><div class="mt-4 space-y-4">${dragDropUI}</div><div class="flex items-center space-x-3 mt-4"><button id="process-phase5-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">í˜„ì¬ í†µí™” ìµœì¢… ë³€í™˜ & ë‹¤ìŒìœ¼ë¡œ</button><button id="reset-phase5-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ì„ íƒ ì´ˆê¸°í™”</button></div></div>`;
        },
        renderDownloadView() {
             return `<div class="text-center py-10"><h1 class="text-4xl font-bold text-green-600">ğŸ‰ ì´ ì‘ì—… ë³€í™˜ ì™„ë£Œ!</h1><p class="text-slate-600 mt-4">ëª¨ë“  ë‹¨ê³„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì˜ 'í˜„ì¬ ì‘ì—… ì™„ë£Œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê±°ë‚˜, ë‹¤ë¥¸ ë‹¨ê³„ë¥¼ í´ë¦­í•˜ì—¬ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div>`;
        },
        generateTableHTML(data, options = {}) {
            let html = '<table class="preview-table">';
            data.forEach((row, rowIndex) => {
                const rowClass = options.selectable === 'row' ? `selectable ${options.selectedRows?.includes(rowIndex) ? 'highlighted' : ''}` : '';
                html += `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                (row || []).forEach((cell, colIndex) => {
                    let colClass = options.selectable === 'col' ? 'selectable' : '';
                    if (options.selectedCols?.includes(colIndex)) colClass += ' highlighted';
                    if (options.highlightMapping) {
                        for (const [className, col] of Object.entries(options.highlightMapping)) {
                            if (col === colIndex) colClass += ` ${className}`;
                        }
                    }
                    html += `<td data-col-index="${colIndex}" class="${colClass}">${cell ?? ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            return html;
        },
        getPrevPhase(phaseId) {
            const order = ['upload', 'phase1', 'phase2', 'phase3', 'phase4', 'phase5', 'download'];
            const index = order.indexOf(phaseId);
            return index > 0 ? order[index - 1] : 'upload';
        },
        showModal(title, message, buttons) {
            this.modalTitleEl.textContent = title;
            this.modalMessageEl.innerHTML = message;
            this.modalButtonsEl.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `px-4 py-2 rounded-md font-semibold ${btnInfo.className}`;
                button.onclick = btnInfo.onClick;
                this.modalButtonsEl.appendChild(button);
            });
            this.modalEl.classList.remove('hidden');
        },
        hideModal() {
            this.modalEl.classList.add('hidden');
        },
        attachTopLevelEventListeners() {
            // Listeners for DYNAMICALLY created elements that need to be re-attached after every render
            this.sourceListEl.querySelectorAll('.task-item').forEach(item => {
                 item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-source-btn')) {
                        AppController.setActiveSource(e.currentTarget.dataset.sourceId);
                    }
                });
            });

             this.sourceListEl.querySelectorAll('.delete-source-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    AppController.deleteSource(e.currentTarget.dataset.deleteId);
                });
            });
        },
        attachWizardEventListeners() {
            const activeSource = AppState.getActiveSource();
            if (!activeSource) return;

            const activeTaskNameInput = document.getElementById('active-task-name-input');
            if (activeTaskNameInput) {
                activeTaskNameInput.addEventListener('change', (e) => AppController.updateActiveSourceName(e.target.value));
            }

            document.querySelectorAll('.sidebar-btn').forEach(btn => btn.addEventListener('click', (e) => AppController.navigate(e.currentTarget.dataset.phase)));
            
            const resetBtn = document.getElementById('reset-btn');
            if(resetBtn) {
                resetBtn.addEventListener('click', () => {
                    this.showModal(
                        'ì‘ì—… ì´ˆê¸°í™”', 'ì •ë§ë¡œ í˜„ì¬ ì‘ì—…ì˜ ëª¨ë“  ì§„í–‰ ìƒí™©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                        [
                            { text: 'ì•„ë‹ˆì˜¤', className: 'bg-slate-200 hover:bg-slate-300 text-slate-800', onClick: () => this.hideModal() },
                            { text: 'ì˜ˆ (ì´ˆê¸°í™”)', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: () => { AppController.resetActiveSource(); this.hideModal(); } }
                        ]
                    );
                });
            }

            const completeTaskBtn = document.getElementById('complete-task-btn');
            if (completeTaskBtn) completeTaskBtn.addEventListener('click', AppController.completeActiveTask);

            switch(activeSource.currentPhase) {
                case 'phase1':
                    document.querySelectorAll('#main-content .selectable').forEach(row => row.addEventListener('click', e => AppController.handlePhase1RowSelect(parseInt(e.currentTarget.dataset.rowIndex, 10))));
                    document.getElementById('process-phase1-btn').addEventListener('click', AppController.processPhase1);
                    document.getElementById('reset-phase1-btn').addEventListener('click', AppController.resetPhase1);
                    break;
                case 'phase2':
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase2ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.getElementById('add-group-btn')?.addEventListener('click', AppController.handlePhase2AddGroup);
                    document.querySelectorAll('.group-name-input').forEach(input => input.addEventListener('change', e => AppController.handlePhase2GroupNameChange(parseInt(e.currentTarget.dataset.groupIndex, 10), e.currentTarget.value)));
                    document.getElementById('process-phase2-btn').addEventListener('click', AppController.processPhase2);
                    this.attachDragAndDropListeners('phase2');
                    break;
                case 'phase3':
                    document.querySelectorAll('#main-content .selection-box').forEach(box => box.addEventListener('click', e => AppController.handlePhase3KeySelect(e.currentTarget.dataset.key)));
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase3ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase3PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('process-phase3-btn').addEventListener('click', AppController.processPhase3);
                    document.getElementById('reset-phase3-btn').addEventListener('click', AppController.resetPhase3);
                    break;
                case 'phase4':
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase4ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase4PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('process-phase4-btn').addEventListener('click', AppController.processPhase4);
                    document.getElementById('reset-phase4-btn').addEventListener('click', AppController.resetPhase4);
                    this.attachDragAndDropListeners('phase4');
                    break;
                case 'phase5':
                    document.querySelectorAll('#main-content .selection-box').forEach(box => box.addEventListener('click', e => AppController.handlePhase5KeySelect(e.currentTarget.dataset.key)));
                    document.querySelectorAll('#main-content .selectable').forEach(col => col.addEventListener('click', e => AppController.handlePhase5ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.querySelectorAll('.path-nav-btn').forEach(btn => btn.addEventListener('click', e => AppController.handlePhase5PathChange(parseInt(e.currentTarget.dataset.pathIndex, 10))));
                    document.getElementById('base-amount-input').addEventListener('change', e => AppController.handlePhase5BaseAmountChange(e.target.value));
                    document.getElementById('auto-classify-btn')?.addEventListener('click', AppController.handlePhase5AutoClassify);
                    document.getElementById('process-phase5-btn').addEventListener('click', () => AppController.processPhase5(false));
                    document.getElementById('reset-phase5-btn').addEventListener('click', AppController.resetPhase5);
                    this.attachDragAndDropListeners('phase5');
                    break;
            }
        },
        attachDragAndDropListeners(phase) {
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.target.dataset.value));
            });
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', e => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault(); zone.classList.remove('drag-over');
                    const value = e.dataTransfer.getData('text/plain');
                    const toZoneId = zone.id;
                    if (phase === 'phase2') AppController.handlePhase2Drop(value, toZoneId);
                    if (phase === 'phase4') AppController.handlePhase4Drop(value, toZoneId);
                    if (phase === 'phase5') AppController.handlePhase5Drop(value, toZoneId);
                });
            });
        }
    };

    // --- 3. ì»¨íŠ¸ë¡¤ëŸ¬ (Controller / Actions) ---
    const AppController = {
        // --- Source Management ---
        handleFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        if (workbook.SheetNames.length > 1) {
                            workbook.SheetNames.forEach(sheetName => {
                                const worksheet = workbook.Sheets[sheetName];
                                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });
                                AppController.addSource(`${file.name} / ${sheetName}`, rawData);
                            });
                        } else {
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });
                            AppController.addSource(file.name, rawData);
                        }
                    } catch (err) {
                        UIRenderer.showModal('íŒŒì¼ ì˜¤ë¥˜', `íŒŒì¼ '${file.name}'ì„(ë¥¼) ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            event.target.value = ''; // Reset file input
        },
        handlePaste(event) {
            event.preventDefault();
            const text = (event.clipboardData || window.clipboardData).getData('text');
            const rawData = text.trim().split('\n').map(row => row.split('\t'));
            const sourceCount = AppState.getState().sources.filter(s => s.name.startsWith('ì¦ê¶Œê³„ì¢Œ')).length;
            AppController.addSource(`ì¦ê¶Œê³„ì¢Œ${sourceCount + 1}`, rawData);
            event.target.textContent = '';
        },
        addSource(name, rawData) {
            if (!rawData || rawData.length === 0 || rawData.flat().every(cell => cell === null)) {
                UIRenderer.showModal('ì•Œë¦¼', `'${name}'ì— ë°ì´í„°ê°€ ì—†ì–´ ì¶”ê°€í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                return;
            }
            const newSource = {
                id: `source_${Date.now()}_${Math.random()}`,
                name, rawData,
                status: 'pending',
                currentPhase: 'phase1',
                phases: {
                    phase1: { isComplete: false, config: { headerRows: [] }, output: null },
                    phase2: { isComplete: false, config: { splitCol: null, groups: [{name: 'ê·¸ë£¹ 1', values: []}] }, output: [] },
                    phase3: { isComplete: false, config: {}, output: [], activePath: 0, selectingKey: null },
                    phase4: { isComplete: false, config: {}, output: [], removed: [], activePath: 0 },
                    phase5: { isComplete: false, config: {}, output: [], activePath: 0, selectingKey: null },
                    download: { isComplete: false }
                }
            };
            AppState.setState(state => ({ ...state, sources: [...state.sources, newSource] }));
        },
        setActiveSource(sourceId) {
            AppState.setState(state => {
                const newSources = state.sources.map(s => ({
                    ...s,
                    status: s.id === sourceId ? 'active' : (s.status === 'active' ? 'pending' : s.status)
                }));
                return { ...state, activeSourceId: sourceId, sources: newSources };
            });
        },
        deleteSource(sourceId) {
             UIRenderer.showModal('ì‘ì—… ì‚­ì œ', `ì´ ì‘ì—…ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                [
                    { text: 'ì•„ë‹ˆì˜¤', className: 'bg-slate-200 hover:bg-slate-300 text-slate-800', onClick: () => UIRenderer.hideModal() },
                    { text: 'ì˜ˆ (ì‚­ì œ)', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: () => {
                        AppState.setState(state => {
                            const newSources = state.sources.filter(s => s.id !== sourceId);
                            const newActiveSourceId = state.activeSourceId === sourceId ? null : state.activeSourceId;
                            return { ...state, sources: newSources, activeSourceId: newActiveSourceId };
                        });
                        UIRenderer.hideModal();
                    }}
                ]
            );
        },
        updateActiveSourceName(newName) {
            AppController._updateActiveSource(s => {
                s.name = newName;
                return s;
            });
        },
        completeActiveTask() {
            const activeSource = AppState.getActiveSource();
            if (!activeSource.phases.phase5.isComplete) {
                UIRenderer.showModal('ì•Œë¦¼', `ëª¨ë“  ë³€í™˜ ë‹¨ê³„ë¥¼ ì™„ë£Œí•´ì•¼ ì‘ì—…ì„ ë§ˆì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                return;
            }
            AppState.setState(state => {
                const newSources = state.sources.map(s => {
                    if (s.id === state.activeSourceId) {
                        return { ...s, status: 'completed' };
                    }
                    return s;
                });
                return { ...state, activeSourceId: null, sources: newSources };
            });
        },
        resetActiveSource() {
             AppState.setState(state => {
                const newSources = state.sources.map(s => {
                    if (s.id === state.activeSourceId) {
                        // Return a new object with reset phase data
                        return {
                            ...s,
                            currentPhase: 'phase1',
                            phases: {
                                phase1: { isComplete: false, config: { headerRows: [] }, output: null },
                                phase2: { isComplete: false, config: { splitCol: null, groups: [{name: 'ê·¸ë£¹ 1', values: []}] }, output: [] },
                                phase3: { isComplete: false, config: {}, output: [], activePath: 0, selectingKey: null },
                                phase4: { isComplete: false, config: {}, output: [], removed: [], activePath: 0 },
                                phase5: { isComplete: false, config: {}, output: [], activePath: 0, selectingKey: null },
                                download: { isComplete: false }
                            }
                        };
                    }
                    return s;
                });
                return { ...state, sources: newSources };
            });
        },
        
        // --- Phase Logic (Delegates to source-specific state) ---
        _updateActiveSource(updater) {
            AppState.setState(state => {
                const newSources = state.sources.map(s => {
                    if (s.id === state.activeSourceId) {
                        return updater(s);
                    }
                    return s;
                });
                return { ...state, sources: newSources };
            });
        },
        
        navigate(phase) { AppController._updateActiveSource(s => ({...s, currentPhase: phase})); },
        handlePhase1RowSelect(rowIndex) { AppController._updateActiveSource(s => { const currentSelection = s.phases.phase1.config.headerRows; const newSelection = currentSelection.includes(rowIndex) ? currentSelection.filter(r => r !== rowIndex) : [...currentSelection, rowIndex].sort((a, b) => a - b); s.phases.phase1.config.headerRows = newSelection; return s; }); },
        resetPhase1() { AppController._updateActiveSource(s => { s.phases.phase1.config.headerRows = []; return s; }); },
        processPhase1() {
            const source = AppState.getActiveSource();
            const { rawData } = source;
            const { headerRows } = source.phases.phase1.config;
            if (headerRows.length === 0) return UIRenderer.showModal('ì•Œë¦¼', 'ìµœì†Œ 1ê°œ ì´ìƒì˜ í–‰ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            
            let result = DataTransformer.transformPhase1(rawData, headerRows);
            result = DataTransformer.autoSortByDate(result);
            
            AppController._updateActiveSource(s => {
                s.currentPhase = 'phase2';
                s.phases.phase1.isComplete = true;
                s.phases.phase1.output = result;
                s.phases.phase2.isComplete = false;
                s.phases.phase2.config = { splitCol: null, groups: [{name: 'ê·¸ë£¹ 1', values: []}] };
                return s;
            });
        },
        handlePhase2ColSelect(colIndex) { AppController._updateActiveSource(s => { s.phases.phase2.config.splitCol = colIndex; return s; }); },
        handlePhase2AddGroup() { AppController._updateActiveSource(s => { s.phases.phase2.config.groups.push({name: `ê·¸ë£¹ ${s.phases.phase2.config.groups.length + 1}`, values: []}); return s; }); },
        handlePhase2GroupNameChange(index, newName) { AppController._updateActiveSource(s => { s.phases.phase2.config.groups[index].name = newName; return s; }); },
        handlePhase2Drop(value, toZoneId) { AppController._updateActiveSource(s => { s.phases.phase2.config.groups.forEach(g => g.values = g.values.filter(v => v !== value)); const zoneIndex = parseInt(toZoneId.replace('drop-zone-', ''), 10); if (!isNaN(zoneIndex) && !s.phases.phase2.config.groups[zoneIndex].values.includes(value)) { s.phases.phase2.config.groups[zoneIndex].values.push(value); } return s; }); },
        processPhase2() {
            const source = AppState.getActiveSource();
            const data = source.phases.phase1.output;
            const { splitCol, groups } = source.phases.phase2.config;
            const result = DataTransformer.transformPhase2(data, splitCol, groups);
            if (splitCol !== null && result.length === 0) {
                return UIRenderer.showModal('ì•Œë¦¼', 'ì„ íƒëœ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶„ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ë£¹ì— í¬í•¨ëœ ê°’ì´ ì‹¤ì œ ë°ì´í„°ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            }
            AppController._updateActiveSource(s => {
                s.currentPhase = 'phase3';
                s.phases.phase2.isComplete = true;
                s.phases.phase2.output = result;
                s.phases.phase3.isComplete = false;
                s.phases.phase3.config = {};
                s.phases.phase3.activePath = 0;
                return s;
            });
        },
        handlePhase3PathChange(pathIndex) { AppController._updateActiveSource(s => { s.phases.phase3.activePath = pathIndex; s.phases.phase3.selectingKey = null; return s; }); },
        handlePhase3KeySelect(key) { AppController._updateActiveSource(s => { s.phases.phase3.selectingKey = key; return s; }); },
        handlePhase3ColSelect(colIndex) { AppController._updateActiveSource(s => { const { activePath, selectingKey } = s.phases.phase3; if (!selectingKey) return s; s.phases.phase3.config[activePath] = s.phases.phase3.config[activePath] || {}; s.phases.phase3.config[activePath][selectingKey] = colIndex; s.phases.phase3.selectingKey = null; return s; }); },
        resetPhase3() { AppController._updateActiveSource(s => { delete s.phases.phase3.config[s.phases.phase3.activePath]; return s; }); },
        processPhase3() {
            AppController._updateActiveSource(s => {
                const { activePath } = s.phases.phase3;
                const dataSets = s.phases.phase2.output;
                const currentConfig = s.phases.phase3.config[activePath];
                if (!currentConfig) {
                    UIRenderer.showModal('ì•Œë¦¼', 'í˜„ì¬ í†µí™”ì˜ ì—´ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    return s;
                }
                currentConfig.isComplete = true;
                const allPathsCompleted = dataSets.every((_, index) => s.phases.phase3.config[index]?.isComplete);
                if (allPathsCompleted) {
                    s.phases.phase3.output = dataSets.map((dataSet, index) => ({ ...dataSet, data: DataTransformer.transformPhase3(dataSet.data, s.phases.phase3.config[index]) }));
                    s.phases.phase3.isComplete = true;
                    s.currentPhase = 'phase4';
                    s.phases.phase4.isComplete = false;
                    s.phases.phase4.config = {};
                    s.phases.phase4.activePath = 0;
                } else {
                    s.phases.phase3.activePath = dataSets.findIndex((_, index) => !s.phases.phase3.config[index]?.isComplete);
                }
                return s;
            });
        },
        handlePhase4PathChange(pathIndex) { AppController._updateActiveSource(s => { s.phases.phase4.activePath = pathIndex; return s; }); },
        handlePhase4ColSelect(colIndex) { AppController._updateActiveSource(s => { s.phases.phase4.config[s.phases.phase4.activePath] = s.phases.phase4.config[s.phases.phase4.activePath] || {}; s.phases.phase4.config[s.phases.phase4.activePath].tradeTypeCol = colIndex; return s; }); },
        resetPhase4() { AppController._updateActiveSource(s => { delete s.phases.phase4.config[s.phases.phase4.activePath]; return s; }); },
        handlePhase4Drop(value, toZoneId) { AppController._updateActiveSource(s => { const config = s.phases.phase4.config[s.phases.phase4.activePath] || {}; config.valuesToRemove = config.valuesToRemove || []; if (toZoneId === 'drop-zone-0' && !config.valuesToRemove.includes(value)) { config.valuesToRemove.push(value); } else if (toZoneId === 'source-items') { config.valuesToRemove = config.valuesToRemove.filter(v => v !== value); } s.phases.phase4.config[s.phases.phase4.activePath] = config; return s; }); },
        processPhase4() {
            AppController._updateActiveSource(s => {
                const { activePath } = s.phases.phase4;
                const dataSets = s.phases.phase3.output;
                const currentConfig = s.phases.phase4.config[activePath];
                if (!currentConfig?.tradeTypeCol) {
                    UIRenderer.showModal('ì•Œë¦¼', 'ê¸°ì¤€ì—´ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
                    return s;
                }
                currentConfig.isComplete = true;
                const allPathsCompleted = dataSets.every((_, index) => s.phases.phase4.config[index]?.isComplete);
                if (allPathsCompleted) {
                    const outputs = [], removeds = [];
                    dataSets.forEach((dataSet, index) => {
                        const { kept, removed } = DataTransformer.transformPhase4(dataSet.data, s.phases.phase4.config[index]);
                        outputs.push({ ...dataSet, data: kept });
                        removeds.push({ ...dataSet, data: removed });
                    });
                    s.phases.phase4.output = outputs;
                    s.phases.phase4.removed = removeds;
                    s.phases.phase4.isComplete = true;
                    s.currentPhase = 'phase5';
                    s.phases.phase5.isComplete = false;
                    s.phases.phase5.activePath = 0;
                } else {
                    s.phases.phase4.activePath = dataSets.findIndex((_, index) => !s.phases.phase4.config[index]?.isComplete);
                }
                return s;
            });
        },
        handlePhase5PathChange(pathIndex) { AppController._updateActiveSource(s => { s.phases.phase5.activePath = pathIndex; s.phases.phase5.selectingKey = null; return s; }); },
        handlePhase5KeySelect(key) { AppController._updateActiveSource(s => { s.phases.phase5.selectingKey = key; return s; }); },
        handlePhase5ColSelect(colIndex) { AppController._updateActiveSource(s => { const { activePath, selectingKey } = s.phases.phase5; if (!selectingKey) return s; s.phases.phase5.config[activePath] = s.phases.phase5.config[activePath] || {}; s.phases.phase5.config[activePath][selectingKey] = colIndex; s.phases.phase5.selectingKey = null; return s; }); },
        handlePhase5BaseAmountChange(value) { AppController._updateActiveSource(s => { s.phases.phase5.config[s.phases.phase5.activePath] = s.phases.phase5.config[s.phases.phase5.activePath] || {}; s.phases.phase5.config[s.phases.phase5.activePath].baseAmount = parseFloat(value) || 0; return s; }); },
        handlePhase5Drop(value, toZoneId) { AppController._updateActiveSource(s => { const config = s.phases.phase5.config[s.phases.phase5.activePath] || {}; config.depositTypes = (config.depositTypes || []).filter(v => v !== value); config.withdrawalTypes = (config.withdrawalTypes || []).filter(v => v !== value); if (toZoneId === 'drop-zone-deposit') config.depositTypes.push(value); if (toZoneId === 'drop-zone-withdrawal') config.withdrawalTypes.push(value); s.phases.phase5.config[s.phases.phase5.activePath] = config; return s; }); },
        resetPhase5() { AppController._updateActiveSource(s => { delete s.phases.phase5.config[s.phases.phase5.activePath]; return s; }); },
        handlePhase5AutoClassify() {
            const source = AppState.getActiveSource();
            const { activePath } = source.phases.phase5;
            const data = source.phases.phase4.output[activePath].data;
            const config = source.phases.phase5.config[activePath] || {};
            const { result, error } = DataTransformer.classifyByBalance(data, config);
            if (error) { return UIRenderer.showModal('ì˜¤ë¥˜: í•„ìˆ˜ ì—´ ë¯¸ì„ íƒ', error, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]); }
            AppController._updateActiveSource(s => { s.phases.phase5.config[activePath] = { ...config, depositTypes: result.depositTypes, withdrawalTypes: result.withdrawalTypes }; return s; });
        },
        processPhase5(ignoreWarning = false) {
            const source = AppState.getActiveSource();
            const { activePath } = source.phases.phase5;
            const dataSet = source.phases.phase4.output[activePath];
            const currentConfig = source.phases.phase5.config[activePath];
            if (!currentConfig) { return UIRenderer.showModal('ì•Œë¦¼', 'í˜„ì¬ í†µí™”ì˜ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]); }
            if (!ignoreWarning) {
                const verification = DataTransformer.verifyPhase5(dataSet.data, currentConfig);
                if (!verification.isCorrect) {
                    return UIRenderer.showModal('ì”ì•¡ íë¦„ ë¶ˆì¼ì¹˜', `ê³„ì‚°ëœ ìµœì¢… ì”ì•¡(<b class='text-blue-600'>${verification.calculated.toLocaleString()}</b>)ì´ ì›ë³¸ì˜ ìµœì¢… ì”ì•¡(<b class='text-red-600'>${verification.original.toLocaleString()}</b>)ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ê±°ë˜ ì¢…ë¥˜ë¥¼ ì¬ë¶„ë¥˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                        [{ text: 'ì˜ˆ (4ë‹¨ê³„ë¡œ ì´ë™)', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: () => AppController.handleBalanceMismatchRestart() }, { text: 'ì•„ë‹ˆì˜¤ (ë¬´ì‹œí•˜ê³  ë³€í™˜)', className: 'bg-slate-200 hover:bg-slate-300 text-slate-800', onClick: () => { UIRenderer.hideModal(); AppController.processPhase5(true); } }]);
                }
            }
            AppController._updateActiveSource(s => {
                const config = s.phases.phase5.config[s.phases.phase5.activePath];
                config.isComplete = true;
                config.status = ignoreWarning ? 'WARNING' : 'VALIDATED';
                const dataSets = s.phases.phase4.output;
                const allPathsCompleted = dataSets.every((_, index) => s.phases.phase5.config[index]?.isComplete);
                if (allPathsCompleted) {
                    s.phases.phase5.output = dataSets.map((ds, index) => ({...ds, data: DataTransformer.transformPhase5(ds.data, s.phases.phase5.config[index])}));
                    s.phases.phase5.isComplete = true;
                    s.currentPhase = 'download';
                } else {
                    s.phases.phase5.activePath = dataSets.findIndex((_, index) => !s.phases.phase5.config[index]?.isComplete);
                }
                return s;
            });
        },
        handleBalanceMismatchRestart() {
            UIRenderer.hideModal();
            AppController._updateActiveSource(s => {
                const { activePath } = s.phases.phase5;
                const oldPhase5Config = s.phases.phase5.config[activePath] || {};
                const newPhase5Config = { dateCol: oldPhase5Config.dateCol, amountCol: oldPhase5Config.amountCol, balanceCol: oldPhase5Config.balanceCol, tradeTypeCol: oldPhase5Config.tradeTypeCol, jukyoCol: oldPhase5Config.jukyoCol, feeCol: oldPhase5Config.feeCol, taxCol: oldPhase5Config.taxCol, baseAmount: oldPhase5Config.baseAmount, depositTypes: [], withdrawalTypes: [], isComplete: false, status: 'NEEDS_REVIEW' };
                s.phases.phase5.config[activePath] = newPhase5Config;
                const phase4Config = s.phases.phase4.config[activePath] || {};
                phase4Config.isComplete = false;
                s.phases.phase4.config[activePath] = phase4Config;
                s.currentPhase = 'phase4';
                s.phases.phase4.activePath = activePath;
                s.phases.phase4.isComplete = false;
                s.phases.phase5.isComplete = false;
                s.phases.download.isComplete = false;
                return s;
            });
        },
        handleDownload(phase) {
            const { sources } = AppState.getState();
            const completedSources = sources.filter(s => s.status === 'completed');
            if (completedSources.length === 0) {
                 return UIRenderer.showModal('ì•Œë¦¼', `ë‹¤ìš´ë¡œë“œí•  ì™„ë£Œëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.`, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            }

            const sheets = [];
            let filename = "ê²°ê³¼.xlsx";

            completedSources.forEach(source => {
                if (phase === 'phase3' && source.phases.phase3.output) {
                    source.phases.phase3.output.forEach(dataSet => {
                        sheets.push({ name: `${source.name.substring(0, 15)}_${dataSet.name}`, data: dataSet.data });
                    });
                    filename = "3ë‹¨ê³„_ì ìš”ìƒì„±_ê²°ê³¼.xlsx";
                } else if (phase === 'phase4' && source.phases.phase4.removed) {
                    source.phases.phase4.removed.forEach(dataSet => {
                        if (dataSet.data.length > 1) { // í—¤ë”ë§Œ ìˆëŠ” ì‹œíŠ¸ëŠ” ì œì™¸
                           sheets.push({ name: `${source.name.substring(0, 15)}_${dataSet.name}`, data: dataSet.data });
                        }
                    });
                    filename = "4ë‹¨ê³„_ì œê±°í•­ëª©_ê²°ê³¼.xlsx";
                } else if (phase === 'phase5' && source.phases.phase5.output) {
                     source.phases.phase5.output.forEach(dataSet => {
                        sheets.push({ name: `${source.name.substring(0, 15)}_${dataSet.name}`, data: dataSet.data });
                    });
                    filename = "5ë‹¨ê³„_ìµœì¢…ë³€í™˜_ê²°ê³¼.xlsx";
                }
            });
            
            if (sheets.length > 0) {
                 DataTransformer.generateMultiSheetDownloadLink(sheets, filename);
            } else {
                 UIRenderer.showModal('ì•Œë¦¼', `ì„ íƒí•œ ë‹¨ê³„ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            }
        },
    };

    // --- 4. ë°ì´í„° ë³€í™˜ ë¡œì§ (Data Transformer) ---
    const DataTransformer = {
        _parseDate(value) {
            if (value === null || value === undefined || String(value).trim() === '') return null;
            
            // Handle Excel's numeric date format
            if (typeof value === 'number' && value > 10000) {
                // Adjust for timezone offset by creating date in UTC
                const utc_days  = Math.floor(value - 25569);
                const utc_value = utc_days * 86400;                                        
                const date_info = new Date(utc_value * 1000);
                return new Date(date_info.getUTCFullYear(), date_info.getUTCMonth(), date_info.getUTCDate());
            }
            
            // Convert to string and take only the date part (before any space)
            const dateStr = String(value).trim().split(' ')[0];
            
            // Try parsing YYYYMMDD
            if (/^\d{8}$/.test(dateStr)) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                const d2 = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                if (!isNaN(d2.getTime())) return d2;
            }

            // Try parsing various other formats (e.g., YYYY-MM-DD, YYYY.MM.DD)
            const d = new Date(dateStr.replace(/\./g, '-').replace(/\//g, '-'));
            if (!isNaN(d.getTime())) return d;
            
            return null;
        },

        _formatDate(dateObj) {
            if (!dateObj || isNaN(dateObj.getTime())) return "";
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        },

        autoSortByDate(data) { 
            if (data.length < 2) return data; 
            const header = data[0]; 
            const body = data.slice(1); 
            const dateKeywords = ['ì¼ì', 'ê±°ë˜ì¼', 'date']; 
            let dateColIndex = header.findIndex(h => dateKeywords.some(k => String(h).toLowerCase().includes(k))); 
            if (dateColIndex === -1) { 
                console.log("ë‚ ì§œ ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ì •ë ¬ì„ ê±´ë„ˆëœë‹ˆë‹¤."); 
                return data; 
            } 
            
            const parseDate = (value) => this._parseDate(value); 

            let firstDate, lastDate; 
            for(let i=0; i<body.length; i++) { if(body[i][dateColIndex]) { firstDate = parseDate(body[i][dateColIndex]); break; } } 
            for(let i=body.length-1; i>=0; i--) { if(body[i][dateColIndex]) { lastDate = parseDate(body[i][dateColIndex]); break; } } 
            
            let sortedBody = body; 
            if (firstDate && lastDate && firstDate > lastDate) { 
                console.log("ë‚ ì§œê°€ ì—­ìˆœìœ¼ë¡œ í™•ì¸ë˜ì–´ ì „ì²´ ë°ì´í„°ë¥¼ ë’¤ì§‘ìŠµë‹ˆë‹¤."); 
                sortedBody = [...body].reverse(); 
            } 
            
            console.log("ë‚ ì§œ ìë™ ì •ë ¬ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); 
            return [header, ...sortedBody]; 
        },
        transformPhase1(data, headerRows) { const numRowsPerGroup = headerRows.length; const repeatingHeadersData = headerRows.map(rowIndex => data[rowIndex] || []); const newHeaders = repeatingHeadersData.flat().map(cell => cell || ''); const outputData = [newHeaders]; const dataStartIndex = Math.max(...headerRows) + 1; for (let i = dataStartIndex; i < data.length; i += numRowsPerGroup) { const group = data.slice(i, i + numRowsPerGroup); if (group.every(row => !row || row.every(cell => cell === null || String(cell).trim() === ''))) continue; const newRow = group.flat(); const finalRow = newHeaders.map((_, j) => newRow[j] ?? null); outputData.push(finalRow); } return outputData; },
        transformPhase2(data, splitCol, groups) { if (splitCol === null) return [{ name: 'ë‹¨ì¼ê³„ì¢Œ', data: data }]; const header = data[0]; const body = data.slice(1); const groupedData = groups.map(group => ({ name: group.name, data: [header, ...body.filter(row => group.values.includes(String(row[splitCol])))] })); const allGroupedValues = groups.flatMap(g => g.values); const ungroupedRows = body.filter(row => !allGroupedValues.includes(String(row[splitCol]))); if(ungroupedRows.length > 0) { groupedData.push({ name: 'ê¸°íƒ€', data: [header, ...ungroupedRows] }); } return groupedData.filter(g => g.data.length > 1); },
        transformPhase3(data, config) { const header = data[0]; const body = data.slice(1); const newHeader = [...header, "ê²°ê³¼ ìƒì„±"]; const newBody = body.map(row => { const getValue = (key, isNumeric = false) => { const colIndex = config[key]; if (colIndex === undefined || row[colIndex] === null || row[colIndex] === undefined) return ""; const value = String(row[colIndex]).trim().replace(/\u00A0/g, ""); if (isNumeric && (value === "" || parseFloat(value.replace(/,/g, '')) === 0)) return ""; return value; }; const jukyoParts = [ getValue('tradeTypeCol'), getValue('stockNameCol'), getValue('stockQtyCol', true) ? `${getValue('stockQtyCol', true)}ì£¼` : '', getValue('unitPriceCol', true) ? `@${getValue('unitPriceCol', true)}` : '', getValue('stockBalanceCol', true) ? `ì”ê³ ${getValue('stockBalanceCol', true)}ì£¼` : '', getValue('additionalCol1'), getValue('additionalCol2') ]; return [...row, jukyoParts.filter(Boolean).join(' / ')]; }); return [newHeader, ...newBody]; },
        transformPhase4(data, config) { const header = data[0]; const body = data.slice(1); if (!config || config.tradeTypeCol === undefined) return { kept: data, removed: [header] }; const valuesToRemove = config.valuesToRemove || []; const keptRows = body.filter(row => !valuesToRemove.includes(String(row[config.tradeTypeCol]))); const removedRows = body.filter(row => valuesToRemove.includes(String(row[config.tradeTypeCol]))); return { kept: [header, ...keptRows], removed: [header, ...removedRows] }; },
        classifyByBalance(data, config) { const { amountCol, balanceCol, tradeTypeCol } = config; if (amountCol === undefined || balanceCol === undefined || tradeTypeCol === undefined) { return { result: null, error: 'ìë™ ë¶„ë¥˜ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ <b>ê±°ë˜ê¸ˆì•¡, ì˜ˆìˆ˜ê¸ˆì”ì•¡, ê±°ë˜ì¢…ë¥˜</b> ì—´ì„ ëª¨ë‘ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.' }; } const { feeCol, taxCol } = config; const body = data.slice(1); const classifications = {}; const getNumeric = (val) => { if(val === null || val === undefined || String(val).trim() === '') return null; const num = parseFloat(String(val).replace(/,/g, '')); return isNaN(num) ? null : num; }; const anchors = [{ index: -1, balance: config.baseAmount || 0 }]; body.forEach((row, index) => { const balance = getNumeric(row[balanceCol]); if (balance !== null && balance !== 0) { anchors.push({ index, balance }); } }); let newRuleLearned = true; while(newRuleLearned) { newRuleLearned = false; for (let i = 0; i < anchors.length - 1; i++) { const startAnchor = anchors[i]; const endAnchor = anchors[i + 1]; const segmentRows = body.slice(startAnchor.index + 1, endAnchor.index + 1); const totalBalanceChange = endAnchor.balance - startAnchor.balance; let knownCashFlow = 0; const unclassified = {}; segmentRows.forEach(row => { const tradeType = row[tradeTypeCol]; if (!tradeType) return; const amount = getNumeric(row[amountCol]) || 0; const fee = feeCol !== undefined ? getNumeric(row[feeCol]) : 0; const tax = taxCol !== undefined ? getNumeric(row[taxCol]) : 0; if (classifications[tradeType] === 'deposit') { knownCashFlow += amount - fee - tax; } else if (classifications[tradeType] === 'withdrawal') { knownCashFlow -= (amount + fee + tax); } else { if (!unclassified[tradeType]) unclassified[tradeType] = []; unclassified[tradeType].push({ amount, fee, tax }); } }); const unclassifiedTypes = Object.keys(unclassified); if (unclassifiedTypes.length === 1) { const theUnknownType = unclassifiedTypes[0]; const requiredNetEffect = totalBalanceChange - knownCashFlow; const depositHypothesis = unclassified[theUnknownType].reduce((sum, t) => sum + (t.amount - t.fee - t.tax), 0); const withdrawalHypothesis = -unclassified[theUnknownType].reduce((sum, t) => sum + (t.amount + t.fee + t.tax), 0); if (Math.abs(requiredNetEffect - depositHypothesis) < 1) { classifications[theUnknownType] = 'deposit'; newRuleLearned = true; } else if (Math.abs(requiredNetEffect - withdrawalHypothesis) < 1) { classifications[theUnknownType] = 'withdrawal'; newRuleLearned = true; } } } } const depositTypes = Object.keys(classifications).filter(k => classifications[k] === 'deposit'); const withdrawalTypes = Object.keys(classifications).filter(k => classifications[k] === 'withdrawal'); if(depositTypes.length === 0 && withdrawalTypes.length === 0) { UIRenderer.showModal('ì•Œë¦¼', 'ì”ì•¡ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì…ì¶œê¸ˆì„ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„° í™•ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ ë¶„ë¥˜í•´ì£¼ì„¸ìš”.', [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]); } else { UIRenderer.showModal('ì•Œë¦¼', `${depositTypes.length}ê°œì˜ ì…ê¸ˆ ì¢…ë¥˜ì™€ ${withdrawalTypes.length}ê°œì˜ ì¶œê¸ˆ ì¢…ë¥˜ê°€ ìë™ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]); } return { result: { depositTypes, withdrawalTypes }, error: null }; },
        verifyPhase5(data, config) { const body = data.slice(1); if (body.length === 0) return { isCorrect: true }; const finalTransformedData = this.transformPhase5(data, config); if (finalTransformedData.length <= 1) return { isCorrect: true }; const lastTransformedRow = finalTransformedData[finalTransformedData.length - 1]; const finalCalculatedBalance = lastTransformedRow[3]; const lastOriginalRow = body[body.length - 1]; const getOriginalValue = (key) => (config[key] === undefined || lastOriginalRow[config[key]] === null) ? "" : lastOriginalRow[config[key]]; const getOriginalNumeric = (key) => parseFloat(String(getOriginalValue(key)).replace(/,/g, '')) || 0; const finalOriginalBalance = getOriginalNumeric('balanceCol'); if (finalOriginalBalance !== 0 && Math.abs(finalCalculatedBalance - finalOriginalBalance) > 1) { return { isCorrect: false, calculated: finalCalculatedBalance, original: finalOriginalBalance }; } return { isCorrect: true }; },
        transformPhase5(data, config) {
            const body = data.slice(1); 
            const newSheet = [['ì¼ì', 'ì…ê¸ˆ', 'ì¶œê¸ˆ', 'ì”ì•¡', '(ì°¸ê³ ìš©)ì”ì•¡', 'ì ìš”']]; 
            let runningBalance = config.baseAmount || 0; 
            body.forEach(row => { 
                const getValue = (key) => (config[key] === undefined || row[config[key]] === null) ? "" : row[config[key]]; 
                const getNumeric = (key) => parseFloat(String(getValue(key)).replace(/,/g, '')) || 0; 
                
                const tradeType = getValue('tradeTypeCol'); 
                const rawDate = getValue('dateCol');
                const dateObj = this._parseDate(rawDate);
                const date = this._formatDate(dateObj);
                const jukyo = getValue('jukyoCol'); 
                const originalBalance = getValue('balanceCol'); 
                const amount = getNumeric('amountCol'); 
                const fee = getNumeric('feeCol'); 
                const tax = getNumeric('taxCol'); 
                let deposit = 0, withdrawal = 0; 
                if (config.depositTypes?.includes(tradeType)) { deposit = amount; } 
                else if (config.withdrawalTypes?.includes(tradeType)) { withdrawal = amount; } 
                
                if (deposit > 0) { runningBalance += deposit; newSheet.push([date, deposit, 0, runningBalance, originalBalance, jukyo]); } 
                else if (withdrawal > 0) { runningBalance -= withdrawal; newSheet.push([date, 0, withdrawal, runningBalance, originalBalance, jukyo]); } 
                
                if (fee > 0) { runningBalance -= fee; newSheet.push([date, 0, fee, runningBalance, originalBalance, `(ìˆ˜ìˆ˜ë£Œ)${jukyo}`]); } 
                if (tax > 0) { runningBalance -= tax; newSheet.push([date, 0, tax, runningBalance, originalBalance, `(ì œì„¸ê¸ˆ)${jukyo}`]); } 
            }); 
            return newSheet; 
        },
        generateMultiSheetDownloadLink(sheetDataArray, filename) {
            const workbook = XLSX.utils.book_new();
            sheetDataArray.forEach(sheetInfo => {
                if(sheetInfo.data && sheetInfo.data.length > 0) {
                    const worksheet = XLSX.utils.aoa_to_sheet(sheetInfo.data);
                    const safeSheetName = sheetInfo.name.replace(/[/\\?*:[\]]/g, '').substring(0, 31);
                    XLSX.utils.book_append_sheet(workbook, worksheet, safeSheetName);
                }
            });
            if (workbook.SheetNames.length > 0) {
                XLSX.writeFile(workbook, filename);
            } else {
                 UIRenderer.showModal('ì•Œë¦¼', `ì—‘ì…€ íŒŒì¼ë¡œ ë§Œë“¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]);
            }
        }
    };

    // --- ì•± ì´ˆê¸°í™” ---
    document.addEventListener('DOMContentLoaded', () => {
        AppState.init();
        UIRenderer.init();
        UIRenderer.render();
    });
    </script>
</body>
</html>

