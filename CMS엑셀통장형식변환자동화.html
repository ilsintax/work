<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CMS ì—‘ì…€ í†µì¥í˜•ì‹ ë³€í™˜ ìë™í™”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .preview-table {
            border-collapse: collapse;
            min-width: 100%; /* ì»¨í…Œì´ë„ˆë¥¼ ì±„ìš°ë˜, ë‚´ìš©ì´ ë§ìœ¼ë©´ ë” ë„“ì–´ì§€ë„ë¡ ì„¤ì • */
            font-size: 0.8rem;
            table-layout: auto; /* ë‚´ìš©ì— ë”°ë¼ ì—´ ë„ˆë¹„ ìë™ ì¡°ì ˆ */
        }
        .preview-table th, .preview-table td {
            border: 1px solid #e2e8f0; padding: .4rem .6rem; text-align: left;
            white-space: nowrap; /* ë‚´ìš©ì„ í•œ ì¤„ë¡œ í‘œì‹œí•˜ì—¬ ê°€ë¡œ ìŠ¤í¬ë¡¤ ìœ ë„ */
        }
        .selectable-row:hover { background-color: #f0f9ff; cursor: pointer; }
        .selectable-col:hover { background-color: #f0f9ff; cursor: pointer; }
        .highlighted-row { background-color: #bae6fd !important; }
        .highlighted-col { background-color: #c7d2fe !important; }
        /* 4ë‹¨ê³„ ì—´ ì„ íƒ í•˜ì´ë¼ì´íŠ¸ */
        .highlight-map-withdrawalDate { background-color: #fecaca !important; }
        .highlight-map-settlementDate { background-color: #fed7aa !important; }
        .highlight-map-clientName { background-color: #fde68a !important; }
        .highlight-map-withdrawalAmount { background-color: #d9f99d !important; }
        .highlight-map-fee { background-color: #bfdbfe !important; }
        
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.2s; }
        .drop-zone.drag-over { background-color: #e0f2fe; border-color: #3b82f6; }
        .selection-box { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .selection-box.selecting { border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; background-color: #eef2ff; }
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- JS ë Œë”ë§ ì˜ì—­ -->
</div>

<!-- ëª¨ë‹¬ -->
<div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
        <h2 id="modal-title" class="text-xl font-bold mb-4 text-slate-800"></h2>
        <div id="modal-content" class="text-slate-600 mb-6"></div>
        <div id="modal-buttons" class="flex justify-end space-x-3"></div>
    </div>
</div>

<script>
    /******************************************************************************
     * CMS ì—‘ì…€ í†µì¥í˜•ì‹ ë³€í™˜ ìë™í™”
     ******************************************************************************/

    // --- 1. ìƒíƒœ ê´€ë¦¬ (State Management) ---
    const AppState = {
        _state: {},
        _listeners: [],
        init() {
            this._state = {
                currentPhase: 'upload', // upload, header_select, status_col_select, status_classify, column_map, fee_logic, final_preview, download
                fileName: null,
                rawData: [],
                headerRowIndex: null,
                dataWithHeader: [],
                statusColIndex: null,
                uniqueStatusValues: [],
                successfulStatuses: [],
                filteredData: [],
                columnMap: {
                    withdrawalDate: null, settlementDate: null, clientName: null, withdrawalAmount: null, fee: null
                },
                selectingKey: null, // columnMapì˜ key
                feeLogic: null, // 'deduct' or 'full'
                finalData: [],
            };
            this.notify(); // ì´ˆê¸°í™” í›„ UIë¥¼ ë‹¤ì‹œ ë Œë”ë§í•˜ë„ë¡ ì•Œë¦¼
        },
        getState() { return this._state; },
        setState(updater) {
            const oldState = JSON.parse(JSON.stringify(this._state));
            this._state = typeof updater === 'function' ? updater(oldState) : { ...oldState, ...updater };
            console.log("State Updated:", this._state);
            this.notify();
        },
        subscribe(listener) { this._listeners.push(listener); },
        notify() { this._listeners.forEach(listener => listener()); },
    };

    // --- 2. UI ë Œë”ë§ (UI Rendering) ---
    const UIRenderer = {
        init() {
            this.appEl = document.getElementById('app');
            this.modalEl = document.getElementById('modal');
            AppState.subscribe(() => this.render());
            this.render(); // ì´ˆê¸° ë Œë”ë§
        },
        render() {
            const state = AppState.getState();
            let html = '';
            switch (state.currentPhase) {
                case 'upload': html = this.renderUploadView(); break;
                case 'header_select': html = this.renderHeaderSelectView(state); break;
                case 'status_col_select': html = this.renderStatusColSelectView(state); break;
                case 'status_classify': html = this.renderStatusClassifyView(state); break;
                case 'column_map': html = this.renderColumnMapView(state); break;
                // fee_logicì€ ëª¨ë‹¬ë¡œ ì²˜ë¦¬
                case 'final_preview': html = this.renderFinalPreview(state); break;
                default: html = this.renderUploadView();
            }
            this.appEl.innerHTML = html;
            this.attachEventListeners();
        },
        renderUploadView() {
            return `
                <header class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-slate-900">CMS ì—‘ì…€ í†µì¥í˜•ì‹ ë³€í™˜ ìë™í™”</h1>
                    <p class="text-slate-600 mt-2">ë³µì¡í•œ CMS ì •ì‚° ë°ì´í„°ë¥¼ í†µì¥ í˜•ì‹ìœ¼ë¡œ ì†ì‰½ê²Œ ë³€í™˜í•˜ì„¸ìš”.</p>
                </header>

                <div class="mb-8 p-6 border-l-4 border-blue-500 bg-blue-50 rounded-r-lg">
                    <h2 class="text-xl font-bold text-blue-800 mb-3">ğŸ“¢ CMS í†µì¥ë‚´ì—­ ì²˜ë¦¬ ì¶”ì²œ ë°©ë²•</h2>
                    <ul class="list-disc list-inside space-y-2 text-slate-700">
                        <li>ì‘ì—… ì „ íšŒê³„ í”„ë¡œê·¸ë¨ì— <strong class="text-blue-600">'CMS ê°€ìƒ í†µì¥ ê³„ì¢Œ'ì˜ ê±°ë˜ì²˜ì½”ë“œ</strong>ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.</li>
                        <li>ë³€í™˜ í›„ ë‹¤ìš´ë¡œë“œí•œ ì—‘ì…€ì—ì„œ <strong class="text-green-600">'ì…ê¸ˆ'</strong>ì€ ì¼ë°˜ í†µì¥ì˜ <strong class="text-green-600">'ë§¤ì¶œ ì…ê¸ˆ'</strong>ìœ¼ë¡œ, <strong class="text-red-600">'ì¶œê¸ˆ'</strong>ì€ <strong class="text-red-600">'í†µì¥ ëŒ€ì²´'</strong>ë¡œ ì²˜ë¦¬í•˜ì‹œë©´ í¸ë¦¬í•©ë‹ˆë‹¤.</li>
                    </ul>
                    <div class="mt-4 p-4 border-t border-blue-200">
                        <h3 class="font-semibold text-amber-800">â€» ìˆ˜ìˆ˜ë£Œë¥¼ ì œí•˜ê³  ì…ê¸ˆë˜ëŠ” ê²½ìš° (Ex: 100,000ì› ì¶œê¸ˆ, 1,000ì› ìˆ˜ìˆ˜ë£Œ, ìµœì¢… 99,000ì› ì…ê¸ˆë˜ëŠ” ê²½ìš°)</h3>
                        <p class="text-sm text-slate-600 mt-1">
                            ë‹¤ìš´ë¡œë“œëœ ì—‘ì…€ì˜ <strong class="text-red-600">'ìˆ˜ìˆ˜ë£Œ ì¶œê¸ˆ'</strong> í•­ëª©ì€, ìˆ˜ìˆ˜ë£Œì— ëŒ€í•œ ì„¸ê¸ˆê³„ì‚°ì„œ ë°œê¸‰ ì‹œ <strong class="text-indigo-600">'ì™¸ìƒë§¤ì…ê¸ˆ ë°˜ì œ'</strong>ë¡œ, ë¯¸ë°œê¸‰ ì‹œ <strong class="text-indigo-600">'ìˆ˜ìˆ˜ë£Œ ë¹„ìš©'</strong>ìœ¼ë¡œ ì²˜ë¦¬í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>

                <div id="drop-zone" class="flex flex-col items-center justify-center h-64 border-2 border-dashed rounded-lg bg-white cursor-pointer hover:bg-slate-100 transition">
                    <svg class="w-12 h-12 mb-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <span class="text-slate-600 font-medium text-lg">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ XLSX/XLS íŒŒì¼ ì—…ë¡œë“œ</span>
                    <input id="file-input" type="file" accept=".xlsx,.xls" class="hidden"/>
                </div>`;
        },
        renderHeaderSelectView(state) {
            const tableHTML = this.generateTableHTML(state.rawData.slice(0, 30), {
                selectable: 'row',
                highlightedRow: state.headerRowIndex
            });
            return `
                <div class="space-y-6">
                    <header>
                        <h1 class="text-3xl font-bold text-slate-900">1ë‹¨ê³„: ì œëª© í–‰ ì§€ì •</h1>
                        <p class="text-slate-600 mt-2">ë°ì´í„°ì˜ ì œëª©(í—¤ë”)ì— í•´ë‹¹í•˜ëŠ” í–‰ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                    </header>
                    <div class="flex items-center space-x-3">
                        <button id="confirm-header-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-300" ${state.headerRowIndex === null ? 'disabled' : ''}>í™•ì¸</button>
                    </div>
                    <div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div>
                </div>`;
        },
        renderStatusColSelectView(state) {
            const tableHTML = this.generateTableHTML(state.dataWithHeader.slice(0, 30), {
                selectable: 'col',
                highlightedCol: state.statusColIndex
            });
            return `
                <div class="space-y-6">
                    <header>
                        <h1 class="text-3xl font-bold text-slate-900">2ë‹¨ê³„: ì¶œê¸ˆ ìƒíƒœ ì—´ ì§€ì •</h1>
                        <p class="text-slate-600 mt-2">'ì¶œê¸ˆ ì„±ê³µ', 'ì‹¤íŒ¨' ë“± ìƒíƒœê°€ í‘œì‹œëœ ì—´ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                    </header>
                    <div class="flex items-center space-x-3">
                        <button id="confirm-status-col-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-300" ${state.statusColIndex === null ? 'disabled' : ''}>í™•ì¸</button>
                    </div>
                    <div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div>
                </div>`;
        },
        renderStatusClassifyView(state) {
            const availableStatuses = state.uniqueStatusValues.filter(s => !state.successfulStatuses.includes(s));
            return `
                <div class="space-y-6">
                    <header>
                        <h1 class="text-3xl font-bold text-slate-900">3ë‹¨ê³„: ì¶œê¸ˆ ì„±ê³µ ë¶„ë¥˜</h1>
                        <p class="text-slate-600 mt-2">ì™¼ìª½ ëª©ë¡ì—ì„œ 'ì¶œê¸ˆ ì„±ê³µ'ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  í•­ëª©ì„ í´ë¦­í•˜ì—¬ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ì‹œí‚¤ì„¸ìš”.</p>
                    </header>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 border rounded-lg bg-slate-50">
                            <h3 class="font-semibold mb-3 text-center">ì „ì²´ ìƒíƒœ ëª©ë¡</h3>
                            <div class="flex flex-col space-y-2 h-64 overflow-y-auto">
                                ${availableStatuses.map(status => `<button class="status-item text-left p-2 bg-white border rounded-md hover:bg-blue-50" data-status="${status}">${status}</button>`).join('')}
                            </div>
                        </div>
                        <div class="p-4 border rounded-lg bg-green-50">
                            <h3 class="font-semibold mb-3 text-center text-green-800">âœ… ì¶œê¸ˆ ì„±ê³µ ë¶„ë¥˜</h3>
                            <div class="flex flex-col space-y-2 h-64 overflow-y-auto">
                                ${state.successfulStatuses.map(status => `<button class="status-item text-left p-2 bg-green-100 border border-green-200 rounded-md hover:bg-red-50" data-status="${status}">${status}</button>`).join('')}
                            </div>
                        </div>
                    </div>
                     <div class="flex items-center space-x-3">
                        <button id="confirm-classify-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-300" ${state.successfulStatuses.length === 0 ? 'disabled' : ''}>ë¶„ë¥˜ ì™„ë£Œ</button>
                    </div>
                </div>`;
        },
        renderColumnMapView(state) {
            const mapConfig = [
                { key: 'withdrawalDate', label: 'ì¶œê¸ˆì¼' }, { key: 'settlementDate', label: 'ì •ì‚°ì¼' },
                { key: 'clientName', label: 'ê±°ë˜ì²˜ëª…' }, { key: 'withdrawalAmount', label: 'ì¶œê¸ˆê¸ˆì•¡' },
                { key: 'fee', label: 'ìˆ˜ìˆ˜ë£Œ' }
            ];
            const header = state.filteredData[0] || [];
            const selectionBoxes = mapConfig.map(item => {
                const colIndex = state.columnMap[item.key];
                const valueText = colIndex !== null ? `[${colIndex + 1}ì—´] ${header[colIndex]}` : 'ë¯¸ì„ íƒ';
                return `
                    <div data-key="${item.key}" class="selection-box p-3 border-2 rounded-lg ${state.selectingKey === item.key ? 'selecting' : ''}">
                        <label class="font-medium text-sm pointer-events-none">${item.label}</label>
                        <span class="block font-bold text-indigo-600 pointer-events-none text-sm mt-1">${valueText}</span>
                    </div>`;
            }).join('');

            const allSelected = Object.values(state.columnMap).every(val => val !== null);

            return `
                <div class="space-y-6">
                    <header>
                        <h1 class="text-3xl font-bold text-slate-900">4ë‹¨ê³„: ë°ì´í„° ì—´ ì„ íƒ</h1>
                        <p class="text-slate-600 mt-2">ì•„ë˜ í•­ëª©ì„ í´ë¦­í•œ ë’¤, í…Œì´ë¸”ì—ì„œ í•´ë‹¹í•˜ëŠ” ë°ì´í„° ì—´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    </header>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">${selectionBoxes}</div>
                     <div class="flex items-center space-x-3">
                        <button id="confirm-map-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-300" ${!allSelected ? 'disabled' : ''}>í™•ì¸</button>
                    </div>
                    <div class="overflow-x-auto border rounded-lg bg-white shadow-sm">
                        ${this.generateTableHTML(state.filteredData.slice(0, 30), { 
                            selectable: 'col',
                            columnMap: state.columnMap
                        })}
                    </div>
                </div>`;
        },
        renderFinalPreview(state) {
            const tableHTML = this.generateTableHTML(state.finalData, { isFinal: true });
            return `
                 <div class="space-y-6">
                    <header>
                        <h1 class="text-3xl font-bold text-slate-900">ìµœì¢… ë³€í™˜ ê²°ê³¼</h1>
                        <p class="text-slate-600 mt-2">ë³€í™˜ëœ í†µì¥ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³ , ì—‘ì…€ íŒŒì¼ë¡œ ì €ì¥í•˜ì„¸ìš”.</p>
                    </header>
                     <div class="flex items-center space-x-3">
                        <button id="download-excel-btn" class="px-6 py-3 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 text-lg">ì—‘ì…€ ì €ì¥</button>
                        <button id="reset-btn" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°</button>
                    </div>
                    <div class="overflow-x-auto border rounded-lg bg-white shadow-sm">
                       ${tableHTML}
                    </div>
                </div>`;
        },
        generateTableHTML(data, options = {}) {
            if (!data || data.length === 0) return '<p class="p-4 text-center">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            let html = '<table class="preview-table">';
            
            data.forEach((row, rowIndex) => {
                if (options.isFinal && rowIndex === 0) {
                    html += '<thead><tr>';
                    row.forEach(cell => html += `<th>${cell ?? ''}</th>`);
                    html += '</tr></thead><tbody>';
                    return;
                }

                const rowClass = options.selectable === 'row' ? `selectable-row ${options.highlightedRow === rowIndex ? 'highlighted-row' : ''}` : '';
                html += `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                (row || []).forEach((cell, colIndex) => {
                    let cellContent = cell ?? '';
                    if (options.isFinal && colIndex === 0 && cell instanceof Date) {
                        const year = cell.getFullYear();
                        const month = String(cell.getMonth() + 1).padStart(2, '0');
                        const day = String(cell.getDate()).padStart(2, '0');
                        cellContent = `${year}-${month}-${day}`;
                    }

                    const colClassArr = [];
                    if (options.selectable === 'col') {
                        colClassArr.push('selectable-col');
                    }
                    if (options.highlightedCol === colIndex) {
                        colClassArr.push('highlighted-col');
                    }
                    if (options.columnMap) {
                        for (const key in options.columnMap) {
                            if (options.columnMap[key] === colIndex) {
                                colClassArr.push(`highlight-map-${key}`);
                            }
                        }
                    }
                    const colClass = colClassArr.join(' ');
                    html += `<td data-col-index="${colIndex}" class="${colClass}">${cellContent}</td>`;
                });
                html += '</tr>';
            });
            if(options.isFinal) html += '</tbody>';
            html += '</table>';
            return html;
        },
        showModal(title, content, buttons) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            const buttonsEl = document.getElementById('modal-buttons');
            buttonsEl.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `px-4 py-2 rounded-md font-semibold ${btnInfo.className}`;
                button.onclick = () => {
                    this.hideModal();
                    if(btnInfo.onClick) btnInfo.onClick();
                };
                buttonsEl.appendChild(button);
            });
            this.modalEl.classList.remove('hidden');
        },
        hideModal() {
            this.modalEl.classList.add('hidden');
        },
        attachEventListeners() {
            // ê° ë‹¨ê³„(Phase)ì— ë§ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë§Œ ì„ ë³„ì ìœ¼ë¡œ í• ë‹¹í•˜ì—¬ ì˜¤ë¥˜ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
            const state = AppState.getState();

            // ëª¨ë“  ë‹¨ê³„ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆëŠ” ë¦¬ìŠ¤ë„ˆ
            document.getElementById('reset-btn')?.addEventListener('click', () => AppState.init());

            switch (state.currentPhase) {
                case 'upload':
                    const dropZone = document.getElementById('drop-zone');
                    const fileInput = document.getElementById('file-input');
                    if (dropZone) {
                        dropZone.onclick = () => fileInput.click();
                        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
                        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
                        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); AppController.handleFile(e.dataTransfer.files[0]); };
                        fileInput.onchange = (e) => AppController.handleFile(e.target.files[0]);
                    }
                    break;
                case 'header_select':
                    document.querySelectorAll('.selectable-row').forEach(row =>
                        row.onclick = (e) => AppController.handleHeaderSelect(parseInt(e.currentTarget.dataset.rowIndex, 10))
                    );
                    document.getElementById('confirm-header-btn')?.addEventListener('click', () => AppController.confirmHeader());
                    break;
                case 'status_col_select':
                    document.querySelectorAll('.selectable-col').forEach(col =>
                        col.onclick = (e) => AppController.handleStatusColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))
                    );
                    document.getElementById('confirm-status-col-btn')?.addEventListener('click', () => AppController.confirmStatusCol());
                    break;
                case 'status_classify':
                    document.querySelectorAll('.status-item').forEach(item =>
                        item.onclick = (e) => AppController.toggleClassifyStatus(e.currentTarget.dataset.status)
                    );
                    document.getElementById('confirm-classify-btn')?.addEventListener('click', () => AppController.confirmClassify());
                    break;
                case 'column_map':
                    document.querySelectorAll('.selection-box').forEach(box =>
                        box.onclick = (e) => AppController.handleKeySelect(e.currentTarget.dataset.key)
                    );
                    document.querySelectorAll('#app .selectable-col').forEach(col =>
                        col.onclick = (e) => AppController.handleColMap(parseInt(e.currentTarget.dataset.colIndex, 10))
                    );
                    document.getElementById('confirm-map-btn')?.addEventListener('click', () => AppController.confirmMap());
                    break;
                case 'final_preview':
                    document.getElementById('download-excel-btn')?.addEventListener('click', () => AppController.downloadExcel());
                    break;
            }
        },
    };

    // --- 3. ì»¨íŠ¸ë¡¤ëŸ¬ (Controller / Actions) ---
    const AppController = {
        handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: null });
                    AppState.setState({ rawData, fileName: file.name, currentPhase: 'header_select' });
                } catch (error) {
                    UIRenderer.showModal('ì˜¤ë¥˜', "ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message, [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white'}]);
                }
            };
            reader.readAsArrayBuffer(file);
        },
        handleHeaderSelect(rowIndex) {
            AppState.setState({ headerRowIndex: rowIndex });
        },
        confirmHeader() {
            const { rawData, headerRowIndex } = AppState.getState();
            const dataWithHeader = rawData.slice(headerRowIndex);
            AppState.setState({ dataWithHeader, currentPhase: 'status_col_select' });
        },
        handleStatusColSelect(colIndex) {
            AppState.setState({ statusColIndex: colIndex });
        },
        confirmStatusCol() {
            const { dataWithHeader, statusColIndex } = AppState.getState();
            const values = dataWithHeader.slice(1).map(row => row[statusColIndex]).filter(val => val !== null && val !== undefined);
            const uniqueStatusValues = [...new Set(values)];
            AppState.setState({ uniqueStatusValues, currentPhase: 'status_classify' });
        },
        toggleClassifyStatus(status) {
            AppState.setState(state => {
                const { successfulStatuses } = state;
                const newStatuses = successfulStatuses.includes(status)
                    ? successfulStatuses.filter(s => s !== status)
                    : [...successfulStatuses, status];
                return { ...state, successfulStatuses: newStatuses };
            });
        },
        confirmClassify() {
            const { dataWithHeader, statusColIndex, successfulStatuses } = AppState.getState();
            const header = dataWithHeader[0];
            const body = dataWithHeader.slice(1);
            const filteredRows = body.filter(row => successfulStatuses.includes(row[statusColIndex]));
            AppState.setState({ filteredData: [header, ...filteredRows], currentPhase: 'column_map' });
        },
        handleKeySelect(key) {
            AppState.setState(state => ({ ...state, selectingKey: state.selectingKey === key ? null : key }));
        },
        handleColMap(colIndex) {
            const { selectingKey } = AppState.getState();
            if (!selectingKey) return;
            AppState.setState(state => {
                const newColumnMap = { ...state.columnMap, [selectingKey]: colIndex };
                return { ...state, columnMap: newColumnMap, selectingKey: null };
            });
        },
        confirmMap() {
            UIRenderer.showModal(
                '5ë‹¨ê³„: ìˆ˜ìˆ˜ë£Œ ì²˜ë¦¬ ë°©ì‹ ì„ íƒ',
                'CMS ì¶œê¸ˆì•¡ì´ ì…ê¸ˆë  ë•Œ ìˆ˜ìˆ˜ë£Œ ì²˜ë¦¬ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.',
                [
                    { text: 'ìˆ˜ìˆ˜ë£Œë¥¼ ì œì™¸í•˜ê³  ì…ê¸ˆ', className: 'bg-blue-600 text-white', onClick: () => this.processFinalData('deduct') },
                    { text: 'ì¶œê¸ˆëœ ê¸ˆì•¡ ê·¸ëŒ€ë¡œ ì…ê¸ˆ', className: 'bg-green-600 text-white', onClick: () => this.processFinalData('full') },
                ]
            );
        },
        processFinalData(feeLogic) {
            const state = AppState.getState();
            const finalData = DataTransformer.transformToStatement(state.filteredData, state.columnMap, feeLogic);
            AppState.setState({ finalData, feeLogic, currentPhase: 'final_preview' });
        },
        downloadExcel() {
            const { finalData, fileName } = AppState.getState();
            DataTransformer.downloadAsExcel(finalData, fileName);
        }
    };

    // --- 4. ë°ì´í„° ë³€í™˜ ë¡œì§ (Data Transformer) ---
    const DataTransformer = {
        parseDate(value) {
            if (!value) return null;
            if (typeof value === 'number') { // Handle Excel numeric date
                return new Date(Math.round((value - 25569) * 86400 * 1000));
            }
            const s = String(value).replace(/\./g, '-').trim();
            const d = new Date(s);
            return isNaN(d) ? null : d;
        },
        transformToStatement(data, map, feeLogic) {
            const body = data.slice(1);
            
            const settlementAggregator = new Map();
            const allEntries = [];

            body.forEach(row => {
                const withdrawalDate = this.parseDate(row[map.withdrawalDate]);
                const settlementDate = this.parseDate(row[map.settlementDate]);
                const clientName = row[map.clientName];
                const amount = parseFloat(String(row[map.withdrawalAmount] || '0').replace(/,/g, '')) || 0;
                const fee = parseFloat(String(row[map.fee] || '0').replace(/,/g, '')) || 0;

                if (feeLogic === 'deduct') {
                    // ìˆ˜ìˆ˜ë£Œ ì°¨ê° ë¡œì§: ì…ê¸ˆ 1ì¤„, ìˆ˜ìˆ˜ë£Œ ì¶œê¸ˆ 1ì¤„, ì´ 2ì¤„ ìƒì„±
                    if (withdrawalDate) {
                        // 1. ì „ì²´ ì¶œê¸ˆì•¡ì„ ì…ê¸ˆìœ¼ë¡œ ê¸°ë¡
                        allEntries.push({
                            date: withdrawalDate,
                            deposit: amount,
                            withdrawal: 0,
                            client: clientName,
                            memo: `${clientName}_CMSì¶œê¸ˆ`
                        });
                        // 2. ìˆ˜ìˆ˜ë£Œë¥¼ ë³„ë„ ì¶œê¸ˆìœ¼ë¡œ ê¸°ë¡
                        if (fee > 0) {
                            allEntries.push({
                                date: withdrawalDate,
                                deposit: 0,
                                withdrawal: fee,
                                client: clientName,
                                memo: `${clientName}_CMSì¶œê¸ˆìˆ˜ìˆ˜ë£Œ` // ìš”ì²­ì‚¬í•­ì— ë”°ë¼ ì ìš” ë³€ê²½
                            });
                        }
                    }
                    // ì •ì‚°ì¼ ì§‘ê³„ëŠ” (ì¶œê¸ˆì•¡ - ìˆ˜ìˆ˜ë£Œ) ê¸°ì¤€
                    if (settlementDate) {
                        const key = settlementDate.toISOString().split('T')[0];
                        const currentTotal = settlementAggregator.get(key) || 0;
                        settlementAggregator.set(key, currentTotal + (amount - fee));
                    }
                } else { // 'full' ë¡œì§ (ì¶œê¸ˆì•¡ ê·¸ëŒ€ë¡œ ì…ê¸ˆ)
                    if (withdrawalDate) {
                        allEntries.push({
                            date: withdrawalDate,
                            deposit: amount,
                            withdrawal: 0,
                            client: clientName,
                            memo: `${clientName}_CMSì¶œê¸ˆ`
                        });
                    }
                     // ì •ì‚°ì¼ ì§‘ê³„ëŠ” ì „ì²´ ì¶œê¸ˆì•¡ ê¸°ì¤€
                    if (settlementDate) {
                        const key = settlementDate.toISOString().split('T')[0];
                        const currentTotal = settlementAggregator.get(key) || 0;
                        settlementAggregator.set(key, currentTotal + amount);
                    }
                }
            });

            // ì§‘ê³„ëœ ì •ì‚° ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€ì²´ ì¶œê¸ˆ ë°ì´í„° ìƒì„±
            for (const [dateStr, totalAmount] of settlementAggregator.entries()) {
                allEntries.push({
                    date: new Date(dateStr),
                    deposit: 0,
                    withdrawal: totalAmount,
                    client: 'í†µì¥ëŒ€ì²´',
                    memo: 'CMSí†µì¥ëŒ€ì²´'
                });
            }

            // ë°ì´í„° í•©ì¹˜ê³  ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
            allEntries.sort((a, b) => {
                if (!a.date || !b.date) return 0;
                if (a.date.getTime() === b.date.getTime()) return 0;
                return a.date - b.date;
            });

            // ìµœì¢… í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ë° ì”ì•¡ ê³„ì‚°
            const finalTable = [['ë‚ ì§œ', 'ì…ê¸ˆ', 'ì¶œê¸ˆ', 'ì”ì•¡', 'ê±°ë˜ì²˜', 'ì ìš”']];
            let balance = 0;
            allEntries.forEach(entry => {
                balance = balance + entry.deposit - entry.withdrawal;
                finalTable.push([
                    entry.date,
                    entry.deposit,
                    entry.withdrawal,
                    balance,
                    entry.client,
                    entry.memo
                ]);
            });

            return finalTable;
        },
        downloadAsExcel(data, originalFileName) {
            const wb = XLSX.utils.book_new();
            const ws_data = data.map(row => [...row]); // ë°ì´í„° ë³µì‚¬
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [ {wch:12}, {wch:15}, {wch:15}, {wch:15}, {wch:20}, {wch:30} ];

            // ì…€ ì„œì‹ ì ìš©
            for (let R = 1; R < ws_data.length; ++R) {
                // ë‚ ì§œ í˜•ì‹
                const dateCell = ws[XLSX.utils.encode_cell({c:0, r:R})];
                if (dateCell && dateCell.v instanceof Date) {
                    dateCell.t = 'd';
                    dateCell.z = 'yyyy-mm-dd';
                }
                
                // ìˆ«ì í˜•ì‹ (ì…ê¸ˆ, ì¶œê¸ˆ, ì”ì•¡)
                for (let C of [1, 2, 3]) {
                    const numCell = ws[XLSX.utils.encode_cell({c:C, r:R})];
                    if (numCell && typeof numCell.v === 'number') {
                        numCell.t = 'n';
                        numCell.z = '#,##0';
                    }
                }
            }

            XLSX.utils.book_append_sheet(wb, ws, "í†µì¥í˜•ì‹_ë³€í™˜ê²°ê³¼");
            const finalFileName = originalFileName.replace(/\.(xlsx|xls)$/, '_í†µì¥ë³€í™˜.xlsx');
            XLSX.writeFile(wb, finalFileName);
        }
    };

    // --- ì•± ì´ˆê¸°í™” ---
    document.addEventListener('DOMContentLoaded', () => {
        AppState.init();
        UIRenderer.init();
    });
</script>
</body>
</html>

