<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì§€ëŠ¥í˜• ì˜¨ë¼ì¸ ë° ì˜¤í”„ë¼ì¸ ë§¤ì¶œ ì •ë¦¬ v2.5 (ìµœì¢…ë³¸ ìˆ˜ì •)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
    #app { display: flex; flex-direction: column; min-height: 100vh; }
    #top-nav { flex-shrink: 0; }
    main { flex-grow: 1; }
    
    .nav-btn { transition: all 0.2s; border-bottom: 3px solid transparent; }
    .nav-btn.active { border-bottom-color: #4f46e5; font-weight: 600; color: #4338ca; }
    .nav-btn.completed { color: #16a34a; }
    .nav-btn:disabled { color: #9ca3af; cursor: not-allowed; background-color: transparent !important; }

    .preview-table { border-collapse: collapse; width: 100%; font-size: .8rem; }
    .preview-table th, .preview-table td {
      border: 1px solid #e2e8f0; padding: .375rem .5rem; text-align: left;
      white-space: nowrap; min-width: 20px;
    }
    .preview-table th { background-color: #f8fafc; font-weight: 600; }
    .selectable-row:hover { background-color: #f0f9ff; cursor: pointer; }
    .highlighted-row { background-color: #bae6fd !important; }
    
    .highlight-p1-approvalDateCol { background-color: #a7f3d0 !important; }
    .highlight-p1-clientCol { background-color: #fde68a !important; }
    .highlight-p1-countCol { background-color: #fecaca !important; }
    .highlight-p1-amountCol { background-color: #d8b4fe !important; }

    .drop-zone { min-height: 80px; border: 2px dashed #cbd5e1; background-color: #f8fafc; transition: all 0.2s; }
    .drop-zone.drag-over { background-color: #e0f2fe; border-color: #3b82f6; }
    .draggable-item { cursor: grab; padding: 4px 8px; margin: 4px; border-radius: 4px; border: 1px solid #ccc; background-color: white; }
    .draggable-item:active { cursor: grabbing; }

    .selection-box { cursor: pointer; transition: all 0.2s; }
    .selection-box.selecting { border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
    
    .client-list-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .client-list-item:hover { background-color: #f3f4f6; }
    .client-list-item.active { background-color: #e0e7ff; font-weight: 600; color: #3730a3; }
    .client-list-item .status-icon {
        margin-left: auto;
        font-weight: bold;
    }
    .client-list-item.verified .status-icon::after { content: 'âœ”'; color: #16a34a; }
    .client-list-item.forced .status-icon::after { content: 'âœ”'; color: #ef4444; }

    /* --- Modal Styles --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
        position: relative;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    #loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div id="app">
    <nav id="top-nav" class="bg-white border-b border-slate-200 w-full sticky top-0 z-20"></nav>
    <main class="w-full p-4 md:p-8">
        <div id="sticky-header" class="hidden sticky top-16 bg-slate-50/80 backdrop-blur-sm z-10 py-2 mb-4"></div>
        <div id="main-content" class="max-w-7xl mx-auto">
            <!-- JS ë Œë”ë§ ì˜ì—­ -->
        </div>
    </main>
  </div>

  <!-- Main Modal -->
  <div id="modal" class="modal-overlay" style="display: none;">
    <div class="modal-content w-full max-w-lg">
      <h2 id="modal-title" class="text-xl font-bold mb-4 text-slate-800"></h2>
      <div id="modal-message" class="text-slate-600 mb-6"></div>
      <div id="modal-content-extra"></div>
      <div id="modal-buttons" class="flex justify-end space-x-3 mt-6"></div>
    </div>
  </div>
  
  <!-- PDF Preview Modal -->
  <div id="preview-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
          <div class="modal-header">
              <h2 class="text-xl font-bold text-gray-800">PDF ë¯¸ë¦¬ë³´ê¸°</h2>
              <div id="modal-actions">
                  <button onclick="generatePdfFromPreview()" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">í™•ì¸ ë° ì €ì¥</button>
                  <button onclick="closePreviewModal()" class="ml-2 px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">ì·¨ì†Œ</button>
              </div>
          </div>
          <div id="preview-body">
              <!-- ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤. -->
          </div>
          <div id="loading-spinner" style="display: none;">
              <div class="text-center">
                  <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <p class="text-gray-600">PDF íŒŒì¼ ìƒì„± ì¤‘...</p>
              </div>
          </div>
      </div>
  </div>


  <script>
    /******************************************************************************
     * ì§€ëŠ¥í˜• ì˜¨ë¼ì¸ ë° ì˜¤í”„ë¼ì¸ ë§¤ì¶œ ì •ë¦¬ v2.5 (ìµœì¢…ë³¸ ìˆ˜ì •)
     ******************************************************************************/
    
    // --- 0. DB ê´€ë¦¬ (IndexedDB) ---
    const DBManager = {
        db: null,
        init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SalesAppDB_v2_5', 1); // Use a new DB name for this version
                request.onerror = (event) => reject("IndexedDB error: " + event.target.errorCode);
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve();
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore('works', { keyPath: 'id' });
                };
            });
        },
        saveWork(work) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['works'], 'readwrite');
                const store = transaction.objectStore('works');
                const request = store.put(work);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject("Save error: " + event.target.error);
            });
        },
        getAllWorks() {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['works'], 'readonly');
                const store = transaction.objectStore('works');
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject("Get all error: " + event.target.error);
            });
        },
        deleteWork(id) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['works'], 'readwrite');
                const store = transaction.objectStore('works');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject("Delete error: " + event.target.error);
            });
        }
    };

    // --- 1. ìƒíƒœ ê´€ë¦¬ (State) ---
    const AppState = {
        _state: {},
        _listeners: [],
        getInitialState() {
            return {
                currentPhase: 'welcome',
                fileName: null,
                currentWorkId: null,
                phases: {
                    upload: { isComplete: false, rawData: [] },
                    phase1: { isComplete: false, isHeaderRowConfirmed: false, config: { headerRow: null, approvalDateCol: null, clientCol: null, countCol: null, amountCol: null }, output: null, selectingKey: null },
                    phase2: { isComplete: false, subPhase: 'setup', config: { workInfo: null, cleansing: { deleted: [], merged: [{name: 'í†µí•© ê·¸ë£¹ 1', values: []}], added: [] } }, uniqueClients: [], output: null },
                    phase3: { isComplete: false, isAmountConfirmed: false, config: { cashReceiptAmount: null }, output: null },
                    phase4: { isComplete: false, activeClient: null, clientData: {} },
                    phase5: { isComplete: false, subPhase: 'verification', config: { deductFrom: null, offlineCardSales: 0 }, verificationResult: null, finalResult: null, referenceData: null },
                }
            };
        },
        init() { this._state = this.getInitialState(); },
        getState() { return this._state; },
        setState(updater, options = { notify: true }) {
            const oldState = JSON.parse(JSON.stringify(this._state));
            const newState = typeof updater === 'function' ? updater(oldState) : updater;
            this._state = newState;
            console.log("State Updated:", this._state);
            if (options.notify) {
                this.notify();
            }
        },
        subscribe(listener) { this._listeners.push(listener); },
        notify() { this._listeners.forEach(listener => listener()); },
    };

    // --- 2. UI ë Œë”ë§ (Renderer) ---
    const UIRenderer = {
        init() {
            this.topNavEl = document.getElementById('top-nav');
            this.mainContentEl = document.getElementById('main-content');
            this.stickyHeaderEl = document.getElementById('sticky-header');
            this.modalEl = document.getElementById('modal');
            this.modalTitleEl = document.getElementById('modal-title');
            this.modalMessageEl = document.getElementById('modal-message');
            this.modalButtonsEl = document.getElementById('modal-buttons');
            this.modalContentExtraEl = document.getElementById('modal-content-extra');
            AppState.subscribe(() => this.render());
        },
        showModal(title, message, buttons, extraContent = '') {
            this.modalTitleEl.textContent = title;
            this.modalMessageEl.innerHTML = message;
            this.modalContentExtraEl.innerHTML = extraContent;
            this.modalButtonsEl.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `px-4 py-2 rounded-md font-semibold ${btnInfo.className}`;
                button.onclick = btnInfo.onClick;
                this.modalButtonsEl.appendChild(button);
            });
            this.modalEl.style.display = 'flex';
        },
        hideModal() {
            this.modalEl.style.display = 'none';
            this.modalContentExtraEl.innerHTML = '';
        },
        render() {
            const state = AppState.getState();
            this.topNavEl.innerHTML = this.renderTopNavigation(state);
            
            switch(state.currentPhase) {
                case 'welcome':
                    this.stickyHeaderEl.classList.add('hidden');
                    this.mainContentEl.innerHTML = this.renderWelcomeView();
                    AppController.populateWelcomeScreen();
                    break;
                case 'upload':
                    this.stickyHeaderEl.classList.add('hidden');
                    this.mainContentEl.innerHTML = this.renderUploadView();
                    break;
                default:
                    this.mainContentEl.innerHTML = this.renderPhaseView(state);
                    this.renderStickyHeader(state);
                    break;
            }
            this.attachEventListeners();
        },
        renderTopNavigation(state) {
            const phases = [
                { id: 'phase1', name: '1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°' }, { id: 'phase2', name: '2. ê±°ë˜ì²˜ ì •ì œ' }, 
                { id: 'phase3', name: '3. í˜„ê¸ˆì˜ìˆ˜ì¦ ì…ë ¥' }, { id: 'phase4', name: '4. ì—…ì²´ë‚´ì—­ ì…ë ¥' }, 
                { id: 'phase5', name: '5. ìµœì¢… ë¶„ì„' }, 
            ];
            
            const isWorking = state.currentPhase !== 'welcome' && state.currentPhase !== 'upload';

            const buttonsHTML = phases.map(phase => {
                const phaseState = state.phases[phase.id];
                const prevPhaseState = state.phases[this.getPrevPhase(phase.id)];
                
                const isEnabled = phase.id === 'phase1' ? state.phases.upload.isComplete : (prevPhaseState?.isComplete || phaseState?.isComplete);

                return `<button data-phase="${phase.id}" class="nav-btn px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-100 ${state.currentPhase === phase.id ? 'active' : ''} ${phaseState?.isComplete ? 'completed' : ''}" ${!isEnabled ? 'disabled' : ''}>${phase.name}</button>`;
            }).join('');
            
            return `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                  <span class="font-bold text-lg text-indigo-600">ë§¤ì¶œ ì •ë¦¬ ë„êµ¬ v2.5</span>
                </div>
                <div class="flex space-x-4">${isWorking ? buttonsHTML : ''}</div>
                <div>
                  <button id="reset-btn" class="text-sm px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200">ì´ˆê¸°í™”</button>
                </div>
            </div></div>`;
        },
        renderWelcomeView() {
            return `
            <header class="text-center mb-12">
                <h1 class="text-4xl font-bold text-slate-900">ì§€ëŠ¥í˜• ë§¤ì¶œ ì •ë¦¬ ë„êµ¬</h1>
                <p class="text-slate-600 mt-2">ë³µì¡í•œ ë§¤ì¶œ ì •ì‚°ì„ ëª‡ ë²ˆì˜ í´ë¦­ìœ¼ë¡œ ìë™í™”í•˜ì„¸ìš”.</p>
            </header>
<!-- ì‘ì—… ê°€ì´ë“œë¼ì¸ ì„¹ì…˜ ì‹œì‘ -->
<div class="mt-8 mb-4 p-6 bg-amber-50 border-l-4 border-amber-400 text-amber-900 rounded-r-lg shadow-sm">
    <h2 class="text-xl font-bold mb-4 text-amber-900">ğŸš€ ì‘ì—… ì ˆì°¨ ê°€ì´ë“œ</h2>

    <div class="space-y-4 text-sm">
        <div>
            <h3 class="font-semibold text-base mb-2">1. ì„ í–‰ ì‘ì—… ì ˆì°¨</h3>
            <ul class="list-decimal list-inside space-y-2 pl-2">
                <li><strong class="font-medium">POSë§¤ì¶œ ì—…ë¡œë“œ:</strong> ì—…ì²´ëª…ì˜ ì‹ ìš©ì¹´ë“œ(POS) ë§¤ì¶œ ë‚´ì—­ì„ ì„¸ë¬´í”„ë¡œê·¸ë¨ì—ì„œ ë¨¼ì € ì„ ì‘ì—…í•©ë‹ˆë‹¤.</li>
                <li><strong class="font-medium">í˜„ê¸ˆì˜ìˆ˜ì¦ ì—…ë¡œë“œ:</strong> êµ­ì„¸ì²­ ì§‘ê³„ ë‚´ì—­ê³¼ ë™ì¼í•˜ê²Œ í˜„ê¸ˆì˜ìˆ˜ì¦ì„ ì„¸ë¬´í”„ë¡œê·¸ë¨ì—ì„œ ë¨¼ì € ì„ ì‘ì—…í•©ë‹ˆë‹¤.</li>
                <li><strong class="font-medium">í˜„ê¸ˆì˜ìˆ˜ì¦ ì°¨ê° ì²˜ë¦¬:</strong> ì´í›„ í˜„ê¸ˆì˜ìˆ˜ì¦ ê¸ˆì•¡ì„ ì¹´ê³¼ / ê±´ë³„ì—ì„œ ë™ì¼ ê¸ˆì•¡ë§Œí¼ ì°¨ê°í•©ë‹ˆë‹¤.
                    <p class="text-xs text-amber-800 pl-4 mt-1">ë°©ë²•: ë™ì¼ ë‚ ì§œ ì „í‘œë¥¼ ë³µì‚¬ â†’ ê³¼ì„¸ìœ í˜•ì„ ë³€ê²½ â†’ ë§ˆì´ë„ˆìŠ¤ ê¸ˆì•¡ ì…ë ¥.</p>
                    <p class="text-xs text-red-600 pl-4 mt-1">âš ï¸ í™˜ê²½ì„¤ì •ì— ë”°ë¼ ê¸ˆì•¡ ë³€ë™ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                <li><strong class="font-medium">ì‹ ìš©ì¹´ë“œ ë§¤ì¶œìë£Œì¡°íšŒ ì—‘ì…€ ì—…ë¡œë“œ:</strong> ì´ ì‘ì—…ì€ êµ­ì„¸ì²­ ì‹ ìš©ì¹´ë“œ ë§¤ì¶œìë£Œì¡°íšŒ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ì•„ ì—…ë¡œë“œ í•¨ìœ¼ë¡œì¨ ì‹œì‘ë©ë‹ˆë‹¤.</li>
                </li>
            </ul>
        </div>

        <div>
            <h3 class="font-semibold text-base mb-2">2. ê¸°ë³¸ ë¡œì§ ì„¤ëª…</h3>
            <ul class="list-disc list-inside space-y-2 pl-2">
                <li>
                    <strong class="font-medium">ë§¤ì¶œ ì´ì•¡ í™•ì • ê¸°ì¤€:</strong>
                    <p class="pl-4">ì—…ì²´ ì‹ ìš©ì¹´ë“œ(POS ë§¤ì¶œ)ì„ ì œì™¸í•œ, ì—…ì²´ê°€ ì œê³µí•œ ë§¤ì¶œìë£Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì´ ë§¤ì¶œì•¡ì„ í™•ì •í•©ë‹ˆë‹¤. <br/> (ì´ìœ : ì¼ë¶€ PGì‚¬ì˜ ì§‘ê³„ì—ì„œëŠ” í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰ ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.)</p>
                </li>
                <li>
                    <strong class="font-medium">ì²˜ë¦¬ ë°©ë²• ì˜ˆì‹œ:</strong>
                    <p class="pl-4 mb-1">êµ­ì„¸ì²­ ì§‘ê³„: A PGì‚¬ 100 + í˜„ê¸ˆì˜ìˆ˜ì¦ 100 / ì—…ì²´ ì œê³µ: A PGì‚¬ 150 + ì˜¤í”„ë¼ì¸ í˜„ê¸ˆ 150</p>
                    <ul class="list-['â†’'] list-inside space-y-1 pl-6 text-xs">
                        <li>"í˜„ê¸ˆì˜ìˆ˜ì¦" ê°€ìƒ ê±°ë˜ì²˜ë¥¼ ì„¤ì •í•˜ê³ , í˜„ê³¼(+100)/ê±´ë³„(-100)ìœ¼ë¡œ ë¶„ê°œí•˜ì—¬ ìµœì¢… 0ì›ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
                        <li>ì´í›„ ì—…ì²´ ë§¤ì¶œ(A PGì‚¬ 150, ì˜¤í”„ë¼ì¸í˜„ê¸ˆ 150)ì„ ì¹´ê³¼ ë˜ëŠ” ê±´ë³„ë¡œ ë°˜ì˜í•©ë‹ˆë‹¤.</li>
                        <li><strong>ìµœì¢… ê²°ê³¼:</strong> ë¶€ê°€ì„¸ ì‹ ê³ ì„œìƒ ë§¤ì¶œì€ <code class="bg-amber-200 px-1 rounded">í˜„ê¸ˆì˜ìˆ˜ì¦ 100</code> + <code class="bg-amber-200 px-1 rounded">ê±´ë³„ ë§¤ì¶œ 200</code> (300 - 100) ì´ ë©ë‹ˆë‹¤.</li>
                    </ul>
                </li>
                 <li>
                    <strong class="font-medium">ì¥ì :</strong>
                     <p class="pl-4">í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰ ê±°ë˜ì²˜ë¥¼ ì¼ì¼ì´ ì¶”ì í•  í•„ìš”ê°€ ì—†ìœ¼ë©°, ì˜¨ë¼ì¸ PGì‚¬ì™€ ì˜¤í”„ë¼ì¸ ë§¤ì¶œ, ê³„ì¢Œì´ì²´ ë“±ì´ í˜¼ì¬ëœ ë³µì¡í•œ ìƒí™©ì—ì„œë„ ë‹¨ìˆœí•˜ê³  ì¼ê´€ëœ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                </li>
            </ul>
        </div>
    </div>
</div>
<!-- ì‘ì—… ê°€ì´ë“œë¼ì¸ ì„¹ì…˜ ë -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">ìƒˆë¡œìš´ ì‘ì—… ì‹œì‘í•˜ê¸°</h2>
                    <button id="start-new-work-btn" class="w-full h-full flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg bg-white cursor-pointer hover:bg-slate-100 transition">
                        <svg class="w-12 h-12 mb-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="text-slate-600 font-medium text-lg">ìƒˆë¡œìš´ ì—‘ì…€ íŒŒì¼ë¡œ ì‘ì—… ì‹œì‘</span>
                    </button>
                </div>
                <div class="flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">ì €ì¥ëœ ì‘ì—… ì´ì–´í•˜ê¸°</h2>
                    <div id="saved-works-list" class="bg-white p-4 rounded-lg border space-y-3 h-full overflow-y-auto">
                        <p class="text-slate-500 text-center py-8">ì €ì¥ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>`;
        },
        renderUploadView() {
            return `<header class="text-center mb-8"><h1 class="text-4xl font-bold text-slate-900">ìƒˆ ì‘ì—… ì‹œì‘</h1><p class="text-slate-600 mt-2">ì •ë¦¬í•  ì˜¨ë¼ì¸ ë§¤ì¶œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p></header><label for="file-input" class="flex flex-col items-center justify-center h-64 border-2 border-dashed rounded-lg bg-white cursor-pointer hover:bg-slate-100 transition"><svg class="w-12 h-12 mb-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><span class="text-slate-600 font-medium text-lg">í´ë¦­í•˜ì—¬ XLSX/XLS íŒŒì¼ ì—…ë¡œë“œ</span><input id="file-input" type="file" accept=".xlsx,.xls" class="hidden"/></label>`;
        },
        renderPhaseView(state) {
            switch(state.currentPhase) {
                case 'phase1': return this.renderPhase1View(state);
                case 'phase2': return this.renderPhase2View(state);
                case 'phase3': return this.renderPhase3View(state);
                case 'phase4': return this.renderPhase4View(state);
                case 'phase5': return this.renderPhase5View(state);
                default: return `<div class="text-center py-10"><h1 class="text-2xl font-bold">ì˜¤ë¥˜</h1><p class="text-slate-600 mt-2">ì•Œ ìˆ˜ ì—†ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.</p></div>`;
            }
        },
        renderPhase1View(state) {
            const { rawData } = state.phases.upload;
            const { isHeaderRowConfirmed } = state.phases.phase1;
            const { headerRow, selectingKey, approvalDateCol, clientCol, countCol, amountCol } = state.phases.phase1.config;
            const highlightMapping = {
                'highlight-p1-approvalDateCol': approvalDateCol, 'highlight-p1-clientCol': clientCol,
                'highlight-p1-countCol': countCol, 'highlight-p1-amountCol': amountCol
            };
            let tableHTML = this.generateTableHTML(rawData.slice(0, 20), { 
                selectedRows: headerRow !== null ? [headerRow] : [],
                highlightMapping: highlightMapping, isRowSelectionLocked: isHeaderRowConfirmed
            });
            let step1HTML = isHeaderRowConfirmed ? `
                <div class="flex justify-between items-center">
                    <p class="text-slate-600 font-semibold">Step 1: ì œëª© í–‰ì´ <span class="text-green-600 font-bold">í™•ì •</span>ë˜ì—ˆìŠµë‹ˆë‹¤. (ì„ íƒëœ í–‰: ${headerRow + 1}í–‰)</p>
                    <button id="change-header-row-btn" class="px-3 py-1 bg-slate-500 text-white rounded-md hover:bg-slate-600 text-sm">ì œëª© í–‰ ë³€ê²½</button>
                </div>` : `
                <p class="text-slate-600 font-semibold">Step 1: ì œëª© í–‰ì„ í´ë¦­í•˜ì„¸ìš”. (í•˜ë‚˜ë§Œ ì„ íƒ ê°€ëŠ¥)</p>
                <div class="mt-4">
                    <button id="confirm-header-row-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-green-300" ${headerRow === null ? 'disabled' : ''}>ì œëª© í–‰ í™•ì •</button>
                </div>`;
            const prompts = [
                { key: 'approvalDateCol', text: '1. ìŠ¹ì¸ë…„ì›”ì„ ì„ íƒí•˜ì„¸ìš”', value: approvalDateCol }, { key: 'clientCol', text: '2. ê±°ë˜ì²˜ì—´ì„ ì„ íƒí•˜ì„¸ìš”', value: clientCol },
                { key: 'countCol', text: '3. ê±´ìˆ˜ì—´ì„ ì„ íƒí•˜ì„¸ìš”', value: countCol }, { key: 'amountCol', text: '4. ë§¤ì¶œì•¡ì—´ì„ ì„ íƒí•˜ì„¸ìš”', value: amountCol },
            ];
            const selectionUI = prompts.map(p => {
                const isSelecting = selectingKey === p.key;
                const headerText = p.value !== null && rawData.length > headerRow && rawData[headerRow] ? rawData[headerRow][p.value] : 'ë¯¸ì„ íƒ';
                const valueText = p.value !== null ? `[${p.value + 1}ì—´] ${headerText}` : 'ë¯¸ì„ íƒ';
                return `<div data-key="${p.key}" class="selection-box p-3 border rounded-md ${isSelecting ? 'selecting' : ''}"><label class="font-medium text-sm pointer-events-none">${p.text}</label><span class="block font-bold text-indigo-600 pointer-events-none mt-1">${valueText}</span></div>`;
            }).join('');
            const allColsSelected = approvalDateCol !== null && clientCol !== null && countCol !== null && amountCol !== null;
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">1ë‹¨ê³„: ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì—´ ì„ íƒ</h1></header><div>${step1HTML}<div class="overflow-x-auto border rounded-lg bg-white shadow-sm mt-2">${tableHTML}</div></div><div class="${isHeaderRowConfirmed ? '' : 'opacity-50 pointer-events-none'}"><p class="text-slate-600 mt-4 font-semibold">Step 2: ì•„ë˜ í•­ëª©ì„ í´ë¦­í•œ ë’¤, í…Œì´ë¸”ì—ì„œ í•´ë‹¹í•˜ëŠ” ì—´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">${selectionUI}</div></div><div class="flex items-center space-x-3 pt-4 border-t ${isHeaderRowConfirmed ? '' : 'hidden'}"><button id="process-phase1-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-300" ${!allColsSelected ? 'disabled' : ''}>ì‘ì—… ì™„ë£Œ & ë‹¤ìŒ ë‹¨ê³„ë¡œ</button></div></div>`;
        },
        renderStickyHeader(state) {
            const { workInfo } = state.phases.phase2.config;
            if (workInfo) {
                this.stickyHeaderEl.classList.remove('hidden');
                this.stickyHeaderEl.innerHTML = `<div class="flex items-center justify-between space-x-6 text-sm bg-white p-2 rounded-lg shadow-sm border">
                    <div class="flex items-center space-x-6">
                        <span class="font-semibold">ì‘ì—… ì •ë³´:</span>
                        <span><strong>ê±°ë˜ì²˜ëª…:</strong> ${workInfo.clientName}</span>
                        <span><strong>ì‘ì—…ë…„ë„:</strong> ${workInfo.workYear}</span>
                        <span><strong>ì‘ì—…ê¸°ìˆ˜:</strong> ${workInfo.workPeriod}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="save-work-btn" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">ì‘ì—… ì €ì¥</button>
                        <button id="back-to-welcome-btn" class="text-xs px-2 py-1 bg-slate-500 text-white rounded hover:bg-slate-600">ëª©ë¡ìœ¼ë¡œ</button>
                    </div>
                </div>`;
            } else {
                this.stickyHeaderEl.classList.add('hidden');
            }
        },
        renderPhase2View(state) {
            const { subPhase } = state.phases.phase2;
            if (subPhase === 'setup') return this.renderPhase2SetupView(state);
            if (subPhase === 'cleansing') return this.renderPhase2CleansingView(state);
            if (subPhase === 'preview') return this.renderPhase2PreviewView(state);
        },
        renderPhase2SetupView(state) {
            const workInfo = state.phases.phase2.config.workInfo || {};
            const periods = ['1ê¸°ì˜ˆì • (1~3ì›”)', '1ê¸°í™•ì • (4~6ì›”)', '1ê¸°ì˜ˆì • ë° í™•ì • (1~6ì›”)', '2ê¸°ì˜ˆì • (7~9ì›”)', '2ê¸°í™•ì • (10~12ì›”)', '2ê¸°ì˜ˆì • ë° í™•ì • (7~12ì›”)'];
            const periodOptionsHTML = periods.map(p => `<option value="${p}" ${workInfo.workPeriod === p ? 'selected' : ''}>${p}</option>`).join('');
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">2ë‹¨ê³„: ì‘ì—… ì •ë³´ ì„¤ì •</h1><p class="text-slate-600 mt-2">ë§¤ì¶œì„ ì •ì‚°í•  ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p></header><div class="p-6 bg-white rounded-lg shadow-sm border space-y-4"><div><label for="work-client-name" class="block text-sm font-medium text-gray-700">ê±°ë˜ì²˜ëª…</label><input type="text" id="work-client-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="ì˜ˆ: (ì£¼)ì²œì¬ì ì‚¬ê³ " value="${workInfo.clientName || ''}"></div><div><label for="work-year" class="block text-sm font-medium text-gray-700">ì‘ì—…ë…„ë„</label><input type="number" id="work-year" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="ì˜ˆ: 2025" value="${workInfo.workYear || ''}"></div><div><label for="work-period" class="block text-sm font-medium text-gray-700">ì‘ì—…ê¸°ìˆ˜</label><select id="work-period" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">${periodOptionsHTML}</select></div></div><div class="flex items-center space-x-3 pt-4 border-t"><button id="process-phase2-setup-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">ì •ë³´ ì…ë ¥ ì™„ë£Œ & ì‘ì—… ì‹œì‘</button></div></div>`;
        },
        renderPhase2CleansingView(state) {
            const { uniqueClients } = state.phases.phase2;
            const { deleted, merged, added } = state.phases.phase2.config.cleansing;
            const currentClients = uniqueClients.filter(c => !deleted.includes(c) && !merged.flatMap(g => g.values).includes(c)).concat(added.map(a => a.name));
            const sourceItemsHTML = currentClients.map(val => `<div class="draggable-item" draggable="true" data-value="${val}">${val}</div>`).join('');
            const mergedGroupsHTML = merged.map((group, index) => `<div class="p-3 rounded-lg bg-white border"><input type="text" value="${group.name}" data-group-index="${index}" class="group-name-input font-semibold mb-2 border-b-2 w-full p-1" placeholder="í†µí•© í›„ ì´ë¦„"><div id="merge-zone-${index}" class="drop-zone p-2 rounded flex flex-wrap gap-2" data-zone-type="merge" data-zone-id="${index}">${group.values.map(val => `<div class="draggable-item bg-blue-100" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div>`).join('');
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">2ë‹¨ê³„: ê±°ë˜ì²˜ ì •ì œ</h1><p class="text-slate-600 mt-2">ê±°ë˜ì²˜ë¥¼ ì •ë¦¬í•˜ì„¸ìš”. ëª©ë¡ì˜ ê±°ë˜ì²˜ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì•„ë˜ ì˜ì—­ìœ¼ë¡œ ì´ë™ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></header><div class="p-4 bg-amber-50 border-l-4 border-amber-400 text-amber-800 text-sm space-y-1 rounded-r-lg"><h3 class="font-bold">ğŸ’¡ ì‘ì—… ê°€ì´ë“œ</h3><p>1. <strong>ì‹ ìš©ì¹´ë“œ</strong>ëŠ” ê±°ë˜ì²˜ ëª©ë¡ì—ì„œ <strong>ì‚­ì œí•  ê±°ë˜ì²˜</strong>ë¡œ ì˜®ê²¨ ì œì™¸í•´ì£¼ì„¸ìš”.</p><p>2. ë™ì¼ê±°ë˜ì²˜ëŠ” <strong>í†µí•©í•  ê±°ë˜ì²˜</strong>ë¡œ ì˜®ê¸°ì‹œê³  í†µí•©ê·¸ë£¹ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br> &nbsp;&nbsp;&nbsp;&nbsp;(ì˜ˆ: 'ì—”ì—ì´ì¹˜ì—”í˜ì´ì½”'ì™€ 'ì—”ì—ì´ì¹˜ì—”ì¼€ì´ì”¨í”¼'ëŠ” ë™ì¼ê±°ë˜ì²˜ì…ë‹ˆë‹¤)</p><p>3. êµ­ì„¸ì²­ì— í‘œì‹œë˜ì§€ ì•Šì€ ê±°ë˜ì²˜ëŠ” í•˜ë‹¨ <strong>ì¶”ê°€í•  ê±°ë˜ì²˜</strong>ì— ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.(ì˜¤í”„ë¼ì¸, ê³„ì¢Œì´ì²´ ë“± í¬í•¨)</p></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 p-4 rounded-lg bg-slate-100 border"><h3 class="font-semibold mb-2">ê±°ë˜ì²˜ ëª©ë¡ (ë“œë˜ê·¸)</h3><div id="source-items" class="drop-zone p-2 rounded flex flex-wrap gap-2" data-zone-type="source">${sourceItemsHTML}</div><div class="mt-4"><h3 class="font-semibold mb-2">ì¶”ê°€í•  ê±°ë˜ì²˜</h3><div class="flex gap-2"><input type="text" id="add-client-input" class="flex-grow border rounded-md px-2 py-1" placeholder="ìƒˆ ê±°ë˜ì²˜ ì´ë¦„"><button id="add-client-btn" class="px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">ì¶”ê°€</button></div></div></div><div class="lg:col-span-2 p-4 rounded-lg bg-white border grid grid-cols-1 md:grid-cols-2 gap-4"><div><h3 class="font-semibold mb-2 text-red-600">ì‚­ì œí•  ê±°ë˜ì²˜</h3><div id="delete-zone" class="drop-zone p-2 rounded" data-zone-type="delete">${deleted.map(val => `<div class="draggable-item bg-red-100" draggable="true" data-value="${val}">${val}</div>`).join('')}</div></div><div class="space-y-4"><h3 class="font-semibold mb-2 text-blue-600">í†µí•©í•  ê±°ë˜ì²˜</h3>${mergedGroupsHTML}<button id="add-merge-group-btn" class="w-full px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 text-sm">+ í†µí•© ê·¸ë£¹ ì¶”ê°€</button></div></div></div><div class="flex items-center space-x-3 pt-4 border-t"><button id="process-phase2-cleansing-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">ê±°ë˜ì²˜ ë¶„ë¥˜ ì™„ë£Œ</button></div></div>`;
        },
        renderPhase2PreviewView(state) {
            const { output } = state.phases.phase2;
            if (!output) return `<div>ì˜¤ë¥˜: ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
            const totalAmount = output.reduce((sum, row) => sum + (row[3] || 0), 0);
            const totalCount = output.reduce((sum, row) => sum + (row[2] || 0), 0);
            const tableData = output.map(row => {
                const count = typeof row[2] === 'number' ? row[2].toLocaleString() : row[2];
                const amount = typeof row[3] === 'number' ? row[3].toLocaleString() : row[3];
                return [row[0], row[1], count, amount];
            });
            const tableHTML = this.generateTableHTML([['ìŠ¹ì¸ë…„ì›”', 'ê±°ë˜ì²˜', 'ê±´ìˆ˜', 'ë§¤ì¶œì•¡'], ...tableData]);
            return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">2ë‹¨ê³„: ì •ì œ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h1><p class="text-slate-600 mt-2">ê±°ë˜ì²˜ ì •ì œ ì‘ì—…ì´ ë°˜ì˜ëœ ê²°ê³¼ì…ë‹ˆë‹¤.</p></header><div class="overflow-x-auto border rounded-lg bg-white shadow-sm">${tableHTML}</div><div class="mt-4 p-4 bg-slate-100 rounded-lg flex justify-end items-center space-x-8"><div><span class="font-semibold text-md">ì´ ê±´ìˆ˜ í•©ê³„:</span><span class="font-bold text-lg text-slate-700 ml-2">${totalCount.toLocaleString()}</span></div><div><span class="font-semibold text-md">ì´ ë§¤ì¶œì•¡ í•©ê³„:</span><span class="font-bold text-xl text-indigo-600 ml-2">${totalAmount.toLocaleString()} ì›</span></div></div><div class="flex items-center space-x-3 pt-4 border-t"><button id="process-phase2-complete-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">ì‘ì—… ì™„ë£Œ & 3ë‹¨ê³„ë¡œ ì´ë™</button><button id="retry-phase2-cleansing-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ë‹¤ì‹œí•˜ê¸°</button></div></div>`;
        },
        renderPhase3View(state) {
            const { isAmountConfirmed, config } = state.phases.phase3;
            const { workInfo } = state.phases.phase2.config;
            if (!workInfo) return `<p>2ë‹¨ê³„ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>`;
            if (!isAmountConfirmed) {
                const promptText = `<strong>${workInfo.clientName}</strong>ì˜ <strong>${workInfo.workYear}ë…„ ${workInfo.workPeriod}</strong>ì˜ í˜„ê¸ˆì˜ìˆ˜ì¦ ë§¤ì¶œì´ì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`;
                return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">3ë‹¨ê³„: í˜„ê¸ˆì˜ìˆ˜ì¦ ì…ë ¥</h1></header><div class="p-6 bg-white rounded-lg shadow-sm border space-y-4"><label for="cash-receipt-amount" class="block text-md font-medium text-gray-700">${promptText}</label><input type="text" inputmode="numeric" id="cash-receipt-amount" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="ê¸ˆì•¡ì„ ìˆ«ìë¡œë§Œ ì…ë ¥í•˜ì„¸ìš”" value="${(config.cashReceiptAmount || '').toLocaleString()}"></div><div class="flex items-center space-x-3 pt-4 border-t"><button id="confirm-phase3-amount-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">í™•ì¸</button></div></div>`;
            } else {
                const phase2Total = state.phases.phase2.output.reduce((sum, row) => sum + (row[3] || 0), 0);
                const totalAmount = phase2Total + config.cashReceiptAmount;
                const summaryText1 = `êµ­ì„¸ì²­ ì˜¤í”ˆë§ˆì¼“ ë° í˜„ê¸ˆì˜ìˆ˜ì¦ ë§¤ì¶œ í•©ê³„ì•¡ì€ <strong class="text-xl text-indigo-600">${totalAmount.toLocaleString()}</strong> ì…ë‹ˆë‹¤.`;
                const summaryText2 = `ë‹¤ìŒë‹¨ê³„ì—ì„œ ì…ë ¥í•  ê¸ˆì•¡ì˜ ì´ì•¡ì€ í•´ë‹¹ ê¸ˆì•¡ë³´ë‹¤ ë§ì•„ì•¼ í•©ë‹ˆë‹¤.`;
                return `<div class="space-y-6"><header><h1 class="text-3xl font-bold text-slate-900">3ë‹¨ê³„: í˜„ê¸ˆì˜ìˆ˜ì¦ ì…ë ¥ ì™„ë£Œ</h1></header><div class="p-6 bg-green-50 rounded-lg shadow-sm border border-green-200 space-y-4 text-center"><p class="text-lg text-slate-800">${summaryText1}</p><p class="text-sm text-yellow-700 bg-yellow-100 p-2 rounded-md">${summaryText2}</p></div><div class="flex items-center space-x-3 pt-4 border-t"><button id="process-phase3-complete-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">ì‘ì—… ì™„ë£Œ & ë‹¤ìŒ ë‹¨ê³„ë¡œ</button><button id="retry-phase3-btn" class="px-4 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">ê¸ˆì•¡ ë‹¤ì‹œ ì…ë ¥</button></div></div>`;
            }
        },
        renderPhase4View(state) {
            const { activeClient, clientData } = state.phases.phase4;
            const finalClients = Array.from(new Set(state.phases.phase2.output.map(row => row[1]))).sort();

            const clientListHTML = finalClients.map(client => {
                const clientInfo = clientData[client];
                const isVerified = clientInfo?.isVerified;
                const verificationClass = isVerified ? (clientInfo.verificationStatus === 'forced' ? 'forced' : 'verified') : '';
                return `<div class="client-list-item ${client === activeClient ? 'active' : ''} ${verificationClass}" data-client="${client}">
                            <span>${client}</span>
                            <span class="status-icon"></span>
                        </div>`;
            }).join('');
            
            let mainContentHTML = `<div class="text-center p-8 text-slate-500">â† ì™¼ìª½ ëª©ë¡ì—ì„œ ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì—¬ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.</div>`;
            if (activeClient) {
                mainContentHTML = this.renderPhase4MainContent(state);
            }

            const allClientsVerified = finalClients.length > 0 && finalClients.every(client => clientData[client]?.isVerified);
            const goToPhase5Button = allClientsVerified 
                ? `<div class="mt-6 text-center"><button id="go-to-phase5-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700">ëª¨ë“  ê±°ë˜ì²˜ ê²€ì¦ ì™„ë£Œ! ìµœì¢… ë¶„ì„ ë‹¨ê³„ë¡œ ì´ë™</button></div>`
                : '';

            return `
                <div class="space-y-6">
                    <header><h1 class="text-3xl font-bold text-slate-900">4ë‹¨ê³„: ì—…ì²´ë³„ ìƒì„¸ ë‚´ì—­ ì…ë ¥ ë° ê²€ì¦</h1></header>
<!-- 4ë‹¨ê³„ ì‘ì—… ê°€ì´ë“œë¼ì¸ ì„¹ì…˜ ì‹œì‘ -->
<div class="mb-6 p-4 bg-amber-50 border-l-4 border-amber-400 text-amber-900 rounded-r-lg shadow-sm text-sm">
    <h3 class="font-bold mb-2">ğŸ’¡ ë§¤ì¶œìœ í˜• ì…ë ¥ ê´€ë ¨ ì£¼ì˜ì‚¬í•­</h3>
    <ul class="list-disc list-inside space-y-1">
        <li><strong class="font-medium">ì¤‘ë³µ ìƒì„± ê°€ëŠ¥:</strong> 'í•­ëª© ì¶”ê°€' ë²„íŠ¼ì„ í†µí•´ ë™ì¼ ë§¤ì¶œìœ í˜•(ì˜ˆ: ì¹´ê³¼)ì„ ì—¬ëŸ¬ ë²ˆ ìƒì„±í•˜ì—¬ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li><strong class="font-medium">ê±°ë˜ì²˜ ì¤‘ë³µ ìƒì„± ê°€ëŠ¥:</strong> 'ë§¤ì¶œì²˜ ì¶”ê°€' ë²„íŠ¼ì„ í†µí•´ í•´ë‹¹ ê±°ë˜ì²˜ ëª©ë¡ì— ì†í•˜ëŠ” ì—¬ëŸ¬ ë§¤ì¶œì²˜ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li><strong class="font-medium">ì‹¤ì œ ì—…ë¡œë“œ ê¸°ì¤€ ì…ë ¥:</strong> ë°˜ë“œì‹œ ì‹¤ì œë¡œ ì—…ë¡œë“œí•  ë§¤ì¶œìœ í˜•ì„ ê¸°ì¤€ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</li>
        <li><strong class="font-medium">ì§‘ê³„ ë°©ì‹:</strong> ì¤‘ë³µ ì…ë ¥ëœ ë‚´ìš© ë° ë‹¤ì¤‘ ë§¤ì¶œì²˜ ì…ë ¥ ë‚´ìš©ì€ ìµœì¢… ì—‘ì…€ ìƒì„± ì‹œ ë§¤ì¶œìœ í˜•ë³„ë¡œ í•©ì‚°ë˜ì–´ ì§‘ê³„ë©ë‹ˆë‹¤.</li>
    </ul>
</div>
<!-- 4ë‹¨ê³„ ì‘ì—… ê°€ì´ë“œë¼ì¸ ì„¹ì…˜ ë -->
                    <div class="grid grid-cols-12 gap-6">
                        <div class="col-span-3">
                            <div class="p-4 bg-white rounded-lg shadow-sm border">
                                <h2 class="font-semibold mb-2">ê±°ë˜ì²˜ ëª©ë¡</h2>
                                <div class="space-y-1">${clientListHTML}</div>
                                ${goToPhase5Button}
                            </div>
                        </div>
                        <div class="col-span-9">${mainContentHTML}</div>
                    </div>
                </div>
            `;
        },
        renderPhase4MainContent(state) {
            const { activeClient } = state.phases.phase4;
            const clientNCSData = state.phases.phase2.output.filter(row => row[1] === activeClient);
            const clientVendorData = state.phases.phase4.clientData[activeClient]?.vendors || [];
            
            const ncsTableRows = clientNCSData.map(row => `<tr><td class="px-4 py-2">${row[0]}</td><td class="px-4 py-2 text-right">${(row[3] || 0).toLocaleString()}</td></tr>`).join('');
            const ncsTotal = clientNCSData.reduce((sum, row) => sum + (row[3] || 0), 0);
            const ncsTableHTML = `
                <div class="p-4 bg-white rounded-lg shadow-sm border">
                    <h3 class="font-semibold mb-2">êµ­ì„¸ì²­ ë°ì´í„°: ${activeClient}</h3>
                    <table class="w-full text-sm">
                        <thead><tr class="bg-slate-50"><th class="px-4 py-2 text-left">ì›”</th><th class="px-4 py-2 text-right">ê¸ˆì•¡</th></tr></thead>
                        <tbody>${ncsTableRows}</tbody>
                        <tfoot><tr class="font-bold bg-slate-100"><td class="px-4 py-2">í•©ê³„</td><td class="px-4 py-2 text-right">${ncsTotal.toLocaleString()}</td></tr></tfoot>
                    </table>
                </div>`;

            const months = [...new Set(clientNCSData.map(row => row[0]))].sort();
            
            const vendorInputHTML = clientVendorData.map((vendor, v_idx) => {
                const itemColumns = vendor.items.map((item, i_idx) => `
                    <th class="p-2 border-b" data-vendor-idx="${v_idx}" data-item-idx="${i_idx}">
                        <div class="flex flex-col items-center gap-1">
                            <select class="p-1 border rounded text-sm w-full phase4-input-type" data-path="vendors[${v_idx}].items[${i_idx}].type">
                                <option ${item.type === 'ì¹´ê³¼' ? 'selected' : ''}>ì¹´ê³¼</option>
                                <option ${item.type === 'í˜„ê³¼' ? 'selected' : ''}>í˜„ê³¼</option>
                                <option ${item.type === 'ê±´ë³„' ? 'selected' : ''}>ê±´ë³„</option>
                                <option ${item.type === 'ì¹´ê³¼(ì„ ë¶ˆ)' ? 'selected' : ''}>ì¹´ê³¼(ì„ ë¶ˆ)</option>
                            </select>
                            <button class="delete-item-btn" data-vendor-index="${v_idx}" data-item-index="${i_idx}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-400 hover:text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </th>`).join('');
                
                const monthRows = months.map((month, m_idx) => {
                    const monthInputs = vendor.items.map((item, i_idx) => {
                        const amount = item.monthlyAmounts[month] || 0;
                        return `<td>
                            <input type="text" inputmode="numeric" class="w-full p-1 border rounded text-right text-sm phase4-input" 
                                   placeholder="0" value="${(amount || '').toLocaleString()}" data-month-idx="${m_idx}" data-item-idx="${i_idx}" data-vendor-idx="${v_idx}">
                        </td>`;
                    }).join('');
                    return `<tr data-month-idx="${m_idx}" data-vendor-idx="${v_idx}"><td class="font-semibold px-2">${month.slice(5,7)}ì›”</td>${monthInputs}<td></td><td class="font-semibold text-right px-2 py-1 bg-slate-50 month-total">0</td></tr>`;
                }).join('');

                const footerRow = `<tfoot class="bg-slate-100"><tr data-vendor-idx="${v_idx}"><td class="font-bold px-2">í•©ê³„</td>${vendor.items.map((_, i_idx) => `<td class="font-bold text-right px-2 py-1 item-total" data-item-idx="${i_idx}">0</td>`).join('')}<td></td><td class="font-bold text-right px-2 py-1 grand-total">0</td></tr></tfoot>`;

                return `
                    <div class="p-4 bg-white rounded-lg shadow-sm border mt-4 vendor-container" data-vendor-idx="${v_idx}">
                        <div class="flex justify-between items-center mb-2">
                            <input type="text" placeholder="ë§¤ì¶œì²˜ ì´ë¦„ ì…ë ¥" value="${vendor.name || ''}" class="font-semibold border-b-2 w-full p-1 phase4-input-name" data-path="vendors[${v_idx}].name">
                            <button class="delete-vendor-btn p-1 ml-2" data-vendor-index="${v_idx}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 hover:text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr><th class="p-2 border-b">ì›”</th>${itemColumns}<th class="p-2 border-b align-bottom"><button class="add-item-btn p-1 bg-slate-200 text-xs rounded hover:bg-slate-300 w-full" data-vendor-index="${v_idx}">í•­ëª© ì¶”ê°€</button></th><th class="p-2 border-b font-semibold">ì›”ë³„ í•©ê³„</th></tr></thead>
                            <tbody>${monthRows}</tbody>
                            ${footerRow}
                        </table>
                        </div>
                    </div>`;
            }).join('');
            
            const verificationResult = DataTransformer.calculatePhase4Verification(clientNCSData, clientVendorData);
            const verificationRows = verificationResult.monthly.map(row => `
                <tr>
                    <td class="px-4 py-2">${row.month}</td>
                    <td class="px-4 py-2 text-right">${row.ncs.toLocaleString()}</td>
                    <td class="px-4 py-2 text-right">${row.vendor.toLocaleString()}</td>
                    <td class="px-4 py-2 text-right ${row.diff !== 0 ? 'text-red-500 font-bold' : ''}">${row.diff.toLocaleString()}</td>
                </tr>`).join('');

            const verificationPanelHTML = `
                 <div id="verification-panel" class="p-4 bg-white rounded-lg shadow-sm border mt-6">
                     <h3 class="font-semibold mb-2">ê²€ì¦</h3>
                     <table class="w-full text-sm">
                          <thead><tr class="bg-slate-50">
                             <th class="px-4 py-2 text-left">ì›”</th>
                             <th class="px-4 py-2 text-right">êµ­ì„¸ì²­</th>
                             <th class="px-4 py-2 text-right">ì…ë ¥í•©ê³„(í˜„ê³¼ì œì™¸)</th>
                             <th class="px-4 py-2 text-right">ì°¨ì•¡</th>
                         </tr></thead>
                         <tbody>${verificationRows}</tbody>
                         <tfoot><tr class="font-bold bg-slate-100">
                             <td class="px-4 py-2">í•©ê³„</td>
                             <td class="px-4 py-2 text-right">${verificationResult.total.ncs.toLocaleString()}</td>
                             <td class="px-4 py-2 text-right">${verificationResult.total.vendor.toLocaleString()}</td>
                             <td class="px-4 py-2 text-right ${verificationResult.total.diff !== 0 ? 'text-red-500 font-bold' : ''}">${verificationResult.total.diff.toLocaleString()}</td>
                         </tr></tfoot>
                     </table>
                     <button id="verify-client-btn" class="w-full mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ê²€ì¦í•˜ê¸°</button>
                 </div>
            `;
            
            return `
                <div class="space-y-4">
                    ${ncsTableHTML}
                    <div>
                        <h3 class="font-semibold mb-2">ì—…ì²´ ì „ì†¡ ë‚´ì—­ ì…ë ¥</h3>
                        ${vendorInputHTML}
                        <button id="add-vendor-btn" class="w-full mt-4 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">+ ë§¤ì¶œì²˜ ì¶”ê°€</button>
                    </div>
                    ${verificationPanelHTML}
                </div>
            `;
        },
        renderPhase5View(state) {
            const { subPhase, verificationResult, finalResult, referenceData } = state.phases.phase5;
            let content = '';

            if (subPhase === 'verification') {
                if (!verificationResult) return '<p>ê²€ì¦ ë°ì´í„°ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
                const { totalVendorSales, totalNCSSales } = verificationResult;
                content = `
                    <div class="p-6 bg-white rounded-lg shadow-sm border">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <h3 class="text-sm font-semibold text-slate-500">ì‹ ìš©ì¹´ë“œ ì œì™¸ ì—…ì²´ì „ì†¡ë‚´ì—­ ì…ë ¥ ì´ í•©ê³„</h3>
                                <p class="text-2xl font-bold text-indigo-600">${totalVendorSales.toLocaleString()} ì›</p>
                                <p class="text-xs text-slate-400 mt-1">ì¹´ê³¼ + í˜„ê³¼ + ê±´ë³„ + ì¹´ê³¼(ì„ ë¶ˆ) ê¸ˆì•¡ì˜ í•©ê³„</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-slate-500">êµ­ì„¸ì²­ ì‹ ìš©ì¹´ë“œ + í˜„ê¸ˆì˜ìˆ˜ì¦ ë§¤ì¶œë‚´ì—­</h3>
                                <p class="text-2xl font-bold text-teal-600">${totalNCSSales.toLocaleString()} ì›</p>
                                 <p class="text-xs text-slate-400 mt-1">êµ­ì„¸ì²­ ì¹´ë“œë§¤ì¶œ + 3ë‹¨ê³„ ì…ë ¥ í˜„ê¸ˆì˜ìˆ˜ì¦</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (subPhase === 'results') {
                if (!finalResult) return '<p>ìµœì¢… ê²°ê³¼ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
                const { companyTotal, composition, finalBreakdown } = finalResult;

                const renderTable = (title, data) => `
                    <div class="p-4 bg-white rounded-lg shadow-sm border">
                        <h3 class="font-bold text-lg mb-3">${title}</h3>
                        <table class="w-full text-sm">
                            <tbody>
                                <tr class="border-b"><td class="py-2 px-3">ì¹´ê³¼</td><td class="py-2 px-3 text-right font-mono">${(data.kaGwa || 0).toLocaleString()}</td></tr>
                                <tr class="border-b"><td class="py-2 px-3">ê±´ë³„</td><td class="py-2 px-3 text-right font-mono">${(data.geonByeol || 0).toLocaleString()}</td></tr>
                                <tr class="border-b"><td class="py-2 px-3">í˜„ê³¼</td><td class="py-2 px-3 text-right font-mono">${(data.hyunGwa || 0).toLocaleString()}</td></tr>
                                <tr class="border-b"><td class="py-2 px-3">ì¹´ê³¼(ì„ ë¶ˆ)</td><td class="py-2 px-3 text-right font-mono">${(data.kaGwaSeonbul || 0).toLocaleString()}</td></tr>
                            </tbody>
                            <tfoot class="font-bold bg-slate-50"><tr class="border-t-2"><td class="py-2 px-3">í•©ê³„</td><td class="py-2 px-3 text-right font-mono">${(data.total || 0).toLocaleString()}</td></tr></tfoot>
                        </table>
                    </div>
                `;
                
                let referenceHTML = '';
                if (referenceData) {
                    const diff1 = referenceData.userCreditCardSales - referenceData.ntsCreditCardSales;
                    const diff2 = referenceData.userCashReceiptSales - referenceData.ntsCashReceiptSales;
                    const diff3 = referenceData.userOtherSales - referenceData.ntsOnlineSales;
                    referenceHTML = `
                        <div class="md:col-span-3 mt-4 p-4 bg-slate-50 rounded-lg shadow-sm border">
                            <h3 class="font-bold text-lg mb-3">ì°¸ê³ </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-200">
                                        <tr>
                                            <th class="py-2 px-3 text-left">í•­ëª©</th>
                                            <th class="py-2 px-3 text-right">êµ­ì„¸ì²­ì§‘ê³„</th>
                                            <th class="py-2 px-3 text-right">ì‚¬ìš©ìì§‘ê³„</th>
                                            <th class="py-2 px-3 text-right">ì°¨ì•¡</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-b">
                                            <td class="py-2 px-3 text-slate-600">ì‹ ìš©ì¹´ë“œë§¤ì¶œëˆ„ê³„</td>
                                            <td class="py-2 px-3 text-right font-mono">${(referenceData.ntsCreditCardSales || 0).toLocaleString()}</td>
                                            <td class="py-2 px-3 text-right font-mono">${(referenceData.userCreditCardSales || 0).toLocaleString()}</td>
                                            <td class="py-2 px-3 text-right font-mono ${diff1 !== 0 ? 'text-red-500' : ''}">${(diff1 || 0).toLocaleString()}</td>
                                        </tr>
                                        <tr class="border-b">
                                            <td class="py-2 px-3 text-slate-600">í˜„ê¸ˆì˜ìˆ˜ì¦ë§¤ì¶œëˆ„ê³„</td>
                                            <td class="py-2 px-3 text-right font-mono">${(referenceData.ntsCashReceiptSales || 0).toLocaleString()}</td>
                                            <td class="py-2 px-3 text-right font-mono">${(referenceData.userCashReceiptSales || 0).toLocaleString()}</td>
                                            <td class="py-2 px-3 text-right font-mono ${diff2 !== 0 ? 'text-red-500' : ''}">${(diff2 || 0).toLocaleString()}</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 px-3 text-slate-600">ì‹ ìš©ì¹´ë“œ ì™¸ íŒë§¤ëŒ€í–‰ ë“± ë§¤ì¶œëˆ„ê³„</td>
                                            <td class="py-2 px-3 text-right font-mono">${(referenceData.ntsOnlineSales || 0).toLocaleString()}</td>
                                            <td class="py-2 px-3 text-right font-mono">${(referenceData.userOtherSales || 0).toLocaleString()}</td>
                                            <td class="py-2 px-3 text-right font-mono ${diff3 !== 0 ? 'text-red-500' : ''}">${(diff3 || 0).toLocaleString()}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }


                content = `
                     <div id="phase5-print-area">
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div class="md:col-span-1 p-4 bg-indigo-50 rounded-lg shadow-sm border border-indigo-200 flex flex-col items-center justify-center text-center">
                                 <h3 class="font-bold text-lg text-indigo-800">ìµœì¢… ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ë§¤ì¶œ í•©</h3>
                                 <p class="text-4xl font-extrabold text-indigo-600 mt-4">${companyTotal.toLocaleString()} ì›</p>
                             </div>
                             <div class="md:col-span-1">${renderTable('ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ë§¤ì¶œì˜ êµ¬ì„±', composition)}</div>
                             <div class="md:col-span-1">${renderTable('ìµœì¢… ì¹´ê³¼/í˜„ê³¼/ê±´ë³„/ì¹´ê³¼(ì„ ë¶ˆ) ë§¤ì¶œ', finalBreakdown)}</div>
                             ${referenceHTML}
                         </div>
                     </div>
                     <div class="mt-8 text-center space-x-4">
                         <button id="pdf-download-btn" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">PDF ì €ì¥</button>
                         <button id="excel-download-btn" class="px-6 py-3 bg-emerald-600 text-white font-bold rounded-lg shadow-md hover:bg-emerald-700">ì—…ë¡œë“œìš© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                     </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <header><h1 class="text-3xl font-bold text-slate-900">5ë‹¨ê³„: ìµœì¢… ë¶„ì„</h1></header>
                    ${content}
                </div>
            `;
        },
        generateTableHTML(data, options = {}) {
            let html = '<table class="preview-table">';
            data.forEach((row, rowIndex) => {
                const rowClass = options.isRowSelectionLocked ? '' : `selectable-row ${options.selectedRows?.includes(rowIndex) ? 'highlighted-row' : ''}`;
                html += `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                (row || []).forEach((cell, colIndex) => {
                    let colClass = '';
                    if (options.highlightMapping) {
                        for (const [className, col] of Object.entries(options.highlightMapping)) {
                            if (col === colIndex) colClass += ` ${className}`;
                        }
                    }
                    html += `<td data-col-index="${colIndex}" class="${colClass.trim()}">${cell ?? ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            return html;
        },
        getPrevPhase(phaseId) {
            const order = ['upload', 'phase1', 'phase2', 'phase3', 'phase4', 'phase5'];
            const index = order.indexOf(phaseId);
            return index > 0 ? order[index - 1] : 'upload';
        },
        attachEventListeners() {
            // Global listeners
            document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', (e) => AppController.navigate(e.currentTarget.dataset.phase)));
            document.getElementById('reset-btn')?.addEventListener('click', AppController.resetAll);
            document.getElementById('back-to-welcome-btn')?.addEventListener('click', AppController.goToWelcome);
            document.getElementById('save-work-btn')?.addEventListener('click', AppController.handleSaveWork);

            // Phase-specific listeners
            const state = AppState.getState();
            switch(state.currentPhase) {
                case 'welcome':
                    document.getElementById('start-new-work-btn')?.addEventListener('click', AppController.handleStartNewWork);
                    document.querySelectorAll('.load-work-btn').forEach(btn => btn.addEventListener('click', e => AppController.handleLoadWork(Number(e.currentTarget.dataset.id))));
                    document.querySelectorAll('.delete-work-btn').forEach(btn => btn.addEventListener('click', e => AppController.handleDeleteWork(Number(e.currentTarget.dataset.id))));
                    break;
                case 'upload':
                    document.getElementById('file-input')?.addEventListener('change', AppController.handleFile);
                    break;
                case 'phase1':
                    document.querySelectorAll('#main-content .selectable-row').forEach(row => row.addEventListener('click', e => AppController.handlePhase1RowSelect(parseInt(e.currentTarget.dataset.rowIndex, 10))));
                    document.querySelectorAll('#main-content .selection-box').forEach(box => box.addEventListener('click', e => AppController.handlePhase1KeySelect(e.currentTarget.dataset.key)));
                    document.querySelectorAll('#main-content .preview-table td').forEach(cell => cell.addEventListener('click', e => AppController.handlePhase1ColSelect(parseInt(e.currentTarget.dataset.colIndex, 10))));
                    document.getElementById('process-phase1-btn')?.addEventListener('click', () => AppController.processPhase1());
                    document.getElementById('confirm-header-row-btn')?.addEventListener('click', () => AppController.confirmHeaderRow());
                    document.getElementById('change-header-row-btn')?.addEventListener('click', () => AppController.changeHeaderRow());
                    break;
                case 'phase2':
                    document.getElementById('process-phase2-setup-btn')?.addEventListener('click', () => AppController.processPhase2Setup());
                    this.attachDragAndDropListeners();
                    document.getElementById('add-client-btn')?.addEventListener('click', () => AppController.handlePhase2AddClient());
                    document.getElementById('add-merge-group-btn')?.addEventListener('click', () => AppController.handlePhase2AddMergeGroup());
                    document.querySelectorAll('.group-name-input').forEach(input => input.addEventListener('change', e => AppController.handlePhase2MergeGroupNameChange(parseInt(e.currentTarget.dataset.groupIndex, 10), e.currentTarget.value)));
                    document.getElementById('process-phase2-cleansing-btn')?.addEventListener('click', () => AppController.processPhase2Cleansing());
                    document.getElementById('process-phase2-complete-btn')?.addEventListener('click', () => AppController.processPhase2Complete());
                    document.getElementById('retry-phase2-cleansing-btn')?.addEventListener('click', () => AppController.retryPhase2Cleansing());
                    break;
                case 'phase3':
                    document.getElementById('confirm-phase3-amount-btn')?.addEventListener('click', () => AppController.confirmPhase3Amount());
                    document.getElementById('process-phase3-complete-btn')?.addEventListener('click', () => AppController.processPhase3Complete());
                    document.getElementById('retry-phase3-btn')?.addEventListener('click', () => AppController.retryPhase3());
                    document.getElementById('cash-receipt-amount')?.addEventListener('input', AppController.formatNumberInput);
                    break;
                case 'phase4':
                    document.querySelectorAll('.client-list-item').forEach(item => item.addEventListener('click', (e) => AppController.handlePhase4ClientSelect(e.currentTarget.dataset.client)));
                    document.getElementById('add-vendor-btn')?.addEventListener('click', () => AppController.handlePhase4AddVendor());
                    document.querySelectorAll('.add-item-btn').forEach(btn => btn.addEventListener('click', (e) => AppController.handlePhase4AddItem(parseInt(e.currentTarget.dataset.vendorIndex, 10))));
                    document.querySelectorAll('.delete-item-btn').forEach(btn => btn.addEventListener('click', (e) => AppController.handlePhase4DeleteItem(parseInt(e.currentTarget.dataset.vendorIndex, 10), parseInt(e.currentTarget.dataset.itemIndex, 10))));
                    document.querySelectorAll('.delete-vendor-btn').forEach(btn => btn.addEventListener('click', (e) => AppController.handlePhase4DeleteVendor(parseInt(e.currentTarget.dataset.vendorIndex, 10))));
                    document.getElementById('go-to-phase5-btn')?.addEventListener('click', () => AppController.goToPhase5());
                    
                    document.querySelectorAll('input.phase4-input, select.phase4-input-type').forEach(input => {
                        input.addEventListener('input', AppController.updatePhase4Sums);
                        if(input.tagName === 'SELECT') input.addEventListener('change', AppController.updatePhase4Sums);
                    });
                    document.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
                        input.addEventListener('input', AppController.formatNumberInput);
                    });
                    if (document.querySelector('.vendor-container')) {
                        AppController.updatePhase4Sums();
                    }
                    
                    document.getElementById('verify-client-btn')?.addEventListener('click', () => AppController.handlePhase4Verify());
                    break;
                case 'phase5':
                     document.getElementById('pdf-download-btn')?.addEventListener('click', () => showPdfPreview('phase5-print-area'));
                     document.getElementById('excel-download-btn')?.addEventListener('click', AppController.handleExcelDownload);
                     break;
            }
        },
        attachDragAndDropListeners() {
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.value);
                    const sourceZone = e.target.closest('.drop-zone');
                    if (sourceZone) {
                        e.dataTransfer.setData('source-zone-type', sourceZone.dataset.zoneType || 'source');
                        e.dataTransfer.setData('source-zone-id', sourceZone.dataset.zoneId || '');
                    }
                });
            });
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', e => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault(); zone.classList.remove('drag-over');
                    const value = e.dataTransfer.getData('text/plain');
                    const sourceZoneType = e.dataTransfer.getData('source-zone-type');
                    const sourceZoneId = e.dataTransfer.getData('source-zone-id');
                    const targetZoneType = zone.dataset.zoneType;
                    const targetZoneId = zone.dataset.zoneId;
                    AppController.handlePhase2Drop(value, { type: sourceZoneType, id: sourceZoneId }, { type: targetZoneType, id: targetZoneId });
                });
            });
        }
    };

    // --- 3. ì»¨íŠ¸ë¡¤ëŸ¬ (Controller / Actions) ---
    const AppController = {
        async populateWelcomeScreen() {
            const works = await DBManager.getAllWorks();
            const listEl = document.getElementById('saved-works-list');
            if (!listEl) return;

            if (works.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500 text-center py-8">ì €ì¥ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            works.sort((a, b) => b.id - a.id);

            listEl.innerHTML = works.map(work => `
                <div class="p-3 border rounded-md flex items-center justify-between hover:bg-slate-50">
                    <div>
                        <p class="font-semibold text-sm text-indigo-700">${work.name}</p>
                        <p class="text-xs text-slate-500">ì €ì¥ì¼: ${new Date(work.savedAt).toLocaleString()}</p>
                    </div>
                    <div class="space-x-2">
                        <button class="load-work-btn px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600" data-id="${work.id}">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button class="delete-work-btn px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600" data-id="${work.id}">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
            UIRenderer.attachEventListeners();
        },
        handleStartNewWork() {
            AppState.init();
            AppState.setState(state => ({ ...state, currentPhase: 'upload' }));
        },
        async handleSaveWork() {
            const state = AppState.getState();
            const { workInfo } = state.phases.phase2.config;
            if (!workInfo) {
                alert('ì €ì¥í•˜ë ¤ë©´ 2ë‹¨ê³„ì—ì„œ ì‘ì—… ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const timestamp = new Date();
            const dateString = timestamp.getFullYear() +
                ('0' + (timestamp.getMonth() + 1)).slice(-2) +
                ('0' + timestamp.getDate()).slice(-2) +
                ('0' + timestamp.getHours()).slice(-2) +
                ('0' + timestamp.getMinutes()).slice(-2);

            const workName = `${workInfo.clientName}_${workInfo.workYear}_${workInfo.workPeriod}_${dateString}`;
            
            const workId = state.currentWorkId || Date.now();

            const workToSave = {
                id: workId,
                name: workName,
                savedAt: timestamp.toISOString(),
                state: state
            };
            
            try {
                await DBManager.saveWork(workToSave);
                AppState.setState(s => ({...s, currentWorkId: workId}));
                UIRenderer.showModal(
                    'ì €ì¥ ì™„ë£Œ',
                    `ì‘ì—…ì´ <strong class="text-indigo-600">${workName}</strong> ì´ë¦„ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                    [{ text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => UIRenderer.hideModal() }]
                );
            } catch (error) {
                console.error("Save failed:", error);
                UIRenderer.showModal(
                    'ì €ì¥ ì‹¤íŒ¨',
                    'ì‘ì—…ì„ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
                    [{ text: 'í™•ì¸', className: 'bg-red-600 text-white', onClick: () => UIRenderer.hideModal() }]
                );
            }
        },
        async handleLoadWork(id) {
            const works = await DBManager.getAllWorks();
            const workToLoad = works.find(w => w.id === id);
            if (workToLoad) {
                AppState.setState(workToLoad.state, { notify: false });
                AppState.notify();
            }
        },
        handleDeleteWork(id) {
            UIRenderer.showModal('ì‘ì—… ì‚­ì œ', 'ì •ë§ë¡œ ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', [
                { text: 'ì·¨ì†Œ', className: 'bg-slate-300 text-slate-800', onClick: () => UIRenderer.hideModal() },
                { text: 'ì‚­ì œ', className: 'bg-red-600 text-white', onClick: async () => {
                    await DBManager.deleteWork(id);
                    UIRenderer.hideModal();
                    AppController.populateWelcomeScreen();
                }}
            ]);
        },
        goToWelcome() {
            UIRenderer.showModal('ì‘ì—… ëª©ë¡ìœ¼ë¡œ ì´ë™', 'ì €ì¥í•˜ì§€ ì•Šì€ ì‘ì—…ì€ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì •ë§ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', [
                { text: 'ì·¨ì†Œ', className: 'bg-slate-300 text-slate-800', onClick: () => UIRenderer.hideModal() },
                { text: 'ì´ë™', className: 'bg-indigo-600 text-white', onClick: () => {
                    AppState.setState(s => ({...s, currentPhase: 'welcome'}));
                    UIRenderer.hideModal();
                }}
            ]);
        },
        navigate(targetPhase) {
             AppState.setState(s => ({ ...s, currentPhase: targetPhase }));
        },
        handleFile(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, { type: 'array' }); const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: null }); AppState.setState(state => ({ ...state, fileName: file.name, currentPhase: 'phase1', phases: { ...state.phases, upload: { isComplete: true, rawData: rawData } } })); } catch (error) { alert("ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message); } }; reader.readAsArrayBuffer(file); },
        resetAll() {
            UIRenderer.showModal('ëª¨ë“  ì‘ì—… ì´ˆê¸°í™”', 'í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì‘ì—…ì„ í¬í•¨í•˜ì—¬ ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì €ì¥ëœ ì‘ì—…ì€ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', [
                { text: 'ì·¨ì†Œ', className: 'bg-slate-300', onClick: () => UIRenderer.hideModal() },
                { text: 'í™•ì¸', className: 'bg-red-600 text-white', onClick: () => {
                    AppState.init(); 
                    UIRenderer.hideModal();
                    UIRenderer.render();
                }}
            ]);
        },
        handlePhase1RowSelect(rowIndex) {
            AppState.setState(state => {
                if (state.phases.phase1.isHeaderRowConfirmed) return state;
                const currentSelection = state.phases.phase1.config.headerRow;
                const newSelection = currentSelection === rowIndex ? null : rowIndex;
                return { ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, config: { ...state.phases.phase1.config, headerRow: newSelection } } } };
            });
        },
        confirmHeaderRow() { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, isHeaderRowConfirmed: true } } })); },
        changeHeaderRow() { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, isHeaderRowConfirmed: false } } })); },
        handlePhase1KeySelect(key) { 
            AppState.setState(state => {
                if (!state.phases.phase1.isHeaderRowConfirmed) return state;
                return { ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, selectingKey: key } } };
            });
        },
        handlePhase1ColSelect(colIndex) { 
            AppState.setState(state => {
                if (!state.phases.phase1.isHeaderRowConfirmed) return state;
                const { selectingKey } = state.phases.phase1; 
                if (!selectingKey) return state; 
                const newConfig = { ...state.phases.phase1.config, [selectingKey]: colIndex }; 
                return { ...state, phases: { ...state.phases, phase1: { ...state.phases.phase1, selectingKey: null, config: newConfig } } }; 
            });
        },
        processPhase1() {
            const state = AppState.getState();
            const { rawData } = state.phases.upload;
            const { headerRow, ...colConfig } = state.phases.phase1.config;
            if (headerRow === null) { alert('ì œëª© í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            const cleanedData = DataTransformer.transformPhase1(rawData, headerRow);
            const header = cleanedData[0];
            const body = cleanedData.slice(1);
            const validBody = body.filter(row => DataTransformer.parseYearMonth(row[colConfig.approvalDateCol]) !== null);
            const processedDataForPhase2 = [header, ...validBody];
            const uniqueClients = [...new Set(validBody.map(row => row[colConfig.clientCol]).filter(Boolean))];
            AppState.setState(state => ({
                ...state, currentPhase: 'phase2',
                phases: {
                    ...state.phases,
                    phase1: { ...state.phases.phase1, isComplete: true, output: processedDataForPhase2 },
                    phase2: { ...state.phases.phase2, uniqueClients: uniqueClients }
                }
            }));
        },
        processPhase2Setup() {
            const clientName = document.getElementById('work-client-name').value;
            const workYear = document.getElementById('work-year').value;
            const workPeriod = document.getElementById('work-period').value;
            if (!clientName || !workYear || !workPeriod) { alert('ëª¨ë“  ì‘ì—… ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            AppState.setState(state => ({ ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, subPhase: 'cleansing', config: { ...state.phases.phase2.config, workInfo: { clientName, workYear, workPeriod } } } } }));
        },
        handlePhase2AddClient() {
            const input = document.getElementById('add-client-input');
            const newClientName = input.value.trim();
            if (!newClientName) return;
            AppState.setState(state => {
                const { added } = state.phases.phase2.config.cleansing;
                if (added.some(c => c.name === newClientName) || state.phases.phase2.uniqueClients.includes(newClientName)) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ì¶”ê°€ëœ ê±°ë˜ì²˜ì…ë‹ˆë‹¤.'); return state;
                }
                const newAdded = [...added, { name: newClientName }];
                return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, cleansing: { ...state.phases.phase2.config.cleansing, added: newAdded } } } } };
            });
            input.value = '';
        },
        handlePhase2AddMergeGroup() {
            AppState.setState(state => {
                const { merged } = state.phases.phase2.config.cleansing;
                const newMerged = [...merged, { name: `í†µí•© ê·¸ë£¹ ${merged.length + 1}`, values: [] }];
                return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, cleansing: { ...state.phases.phase2.config.cleansing, merged: newMerged } } } } };
            });
        },
        handlePhase2MergeGroupNameChange(index, newName) {
            AppState.setState(state => {
                const newMerged = [...state.phases.phase2.config.cleansing.merged];
                newMerged[index].name = newName;
                return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, cleansing: { ...state.phases.phase2.config.cleansing, merged: newMerged } } } } };
            });
        },
        handlePhase2Drop(value, source, target) {
            AppState.setState(state => {
                const cleansing = JSON.parse(JSON.stringify(state.phases.phase2.config.cleansing));
                if (source.type === 'delete') cleansing.deleted = cleansing.deleted.filter(v => v !== value);
                else if (source.type === 'merge') cleansing.merged[source.id].values = cleansing.merged[source.id].values.filter(v => v !== value);
                if (target.type === 'delete') { if (!cleansing.deleted.includes(value)) cleansing.deleted.push(value); }
                else if (target.type === 'merge') { if (!cleansing.merged[target.id].values.includes(value)) cleansing.merged[target.id].values.push(value); }
                return { ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, config: { ...state.phases.phase2.config, cleansing } } } };
            });
        },
        processPhase2Cleansing() {
            const state = AppState.getState();
            const { phase1, phase2, phase4 } = state.phases;
            
            const reconciledClientData = DataTransformer.reconcilePhase4Data(phase4.clientData, phase2.config.cleansing, phase2.uniqueClients);

            const finalData = DataTransformer.transformPhase2(phase1.output, phase1.config, phase2.config);
            
            AppState.setState(s => ({ 
                ...s, 
                phases: { 
                    ...s.phases, 
                    phase2: { ...s.phases.phase2, subPhase: 'preview', output: finalData },
                    phase4: { ...s.phases.phase4, clientData: reconciledClientData }
                } 
            }));
        },
        retryPhase2Cleansing() { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase2: { ...state.phases.phase2, subPhase: 'cleansing' } } })); },
        processPhase2Complete() {
            AppState.setState(state => ({ ...state, currentPhase: 'phase3', phases: { ...state.phases, phase2: { ...state.phases.phase2, isComplete: true } } }));
        },
        confirmPhase3Amount() {
            const input = document.getElementById('cash-receipt-amount');
            const amount = parseFloat(input.value.replace(/,/g, '')) || 0;
            if (isNaN(amount) || amount < 0) { alert('ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const phase2Total = AppState.getState().phases.phase2.output.reduce((sum, row) => sum + (row[3] || 0), 0);
            const totalAmount = phase2Total + amount;
            AppState.setState(state => ({
                ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, isAmountConfirmed: true, config: { cashReceiptAmount: amount }, output: totalAmount } }
            }));
        },
        retryPhase3() { AppState.setState(state => ({ ...state, phases: { ...state.phases, phase3: { ...state.phases.phase3, isAmountConfirmed: false, config: { cashReceiptAmount: null }, output: null } } })); },
        processPhase3Complete() { AppState.setState(state => ({ ...state, currentPhase: 'phase4', phases: { ...state.phases, phase3: { ...state.phases.phase3, isComplete: true } } })); },
        handlePhase4ClientSelect(clientName) {
            this.handlePhase4ReflectChanges();
            AppState.setState(state => ({
                ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, activeClient: clientName } }
            }));
        },
        _getPhase4DOMData() {
            const state = AppState.getState();
            const { activeClient } = state.phases.phase4;
            if (!activeClient) return null;

            const clientState = state.phases.phase4.clientData[activeClient] || {};
            const clientData = { 
                vendors: [], 
                isVerified: clientState.isVerified || false,
                verificationStatus: clientState.verificationStatus || null
            };
            const vendorElements = document.querySelectorAll('.vendor-container');

            vendorElements.forEach((vendorEl, v_idx) => {
                const vendorName = vendorEl.querySelector(`.phase4-input-name[data-path="vendors[${v_idx}].name"]`).value;
                const vendor = { name: vendorName, items: [] };

                const itemElements = vendorEl.querySelectorAll('thead th[data-item-idx]');
                const monthRows = vendorEl.querySelectorAll('tbody tr[data-month-idx]');

                itemElements.forEach((th, i_idx) => {
                    const real_i_idx = parseInt(th.dataset.itemIdx, 10);
                    const selectElement = th.querySelector(`select`);
                    if (selectElement) {
                        const type = selectElement.value;
                        const item = { type: type, monthlyAmounts: {} };

                        monthRows.forEach(rowEl => {
                            const monthEl = rowEl.querySelector('td:first-child');
                            if(!monthEl) return;
                            const month = monthEl.textContent.trim().replace('ì›”', '');
                            const yearMonth = `${state.phases.phase2.config.workInfo.workYear}-${String(month).padStart(2, '0')}`;
                            const input = rowEl.querySelector(`input[data-item-idx="${real_i_idx}"]`);
                            if (input) {
                                item.monthlyAmounts[yearMonth] = parseFloat(input.value.replace(/,/g, '')) || 0;
                            }
                        });
                        vendor.items.push(item);
                    }
                });
                clientData.vendors.push(vendor);
            });
            return clientData;
        },
        updatePhase4Sums() {
            document.querySelectorAll('.vendor-container').forEach(vendorEl => {
                const itemElements = vendorEl.querySelectorAll('thead th[data-item-idx]');
                const monthRows = vendorEl.querySelectorAll('tbody tr[data-month-idx]');
                let grandTotal = 0;

                itemElements.forEach(th => {
                    const i_idx = th.dataset.itemIdx;
                    let itemTotal = 0;
                    vendorEl.querySelectorAll(`input[data-item-idx="${i_idx}"]`).forEach(input => {
                        itemTotal += parseFloat(input.value.replace(/,/g, '')) || 0;
                    });
                    const itemTotalEl = vendorEl.querySelector(`tfoot .item-total[data-item-idx="${i_idx}"]`);
                    if(itemTotalEl) itemTotalEl.textContent = itemTotal.toLocaleString();
                    grandTotal += itemTotal;
                });

                monthRows.forEach(rowEl => {
                    let monthTotal = 0;
                    rowEl.querySelectorAll('input.phase4-input').forEach(input => {
                        monthTotal += parseFloat(input.value.replace(/,/g, '')) || 0;
                    });
                    const monthTotalEl = rowEl.querySelector('.month-total');
                    if(monthTotalEl) monthTotalEl.textContent = monthTotal.toLocaleString();
                });
                
                const grandTotalEl = vendorEl.querySelector('tfoot .grand-total');
                if(grandTotalEl) grandTotalEl.textContent = grandTotal.toLocaleString();
            });
             const verificationPanel = document.getElementById('verification-panel');
            if(verificationPanel) {
                const currentDOMData = AppController._getPhase4DOMData();
                if(!currentDOMData) return;
                const state = AppState.getState();
                const { activeClient } = state.phases.phase4;
                const clientNCSData = state.phases.phase2.output.filter(row => row[1] === activeClient);
                const verificationResult = DataTransformer.calculatePhase4Verification(clientNCSData, currentDOMData.vendors);
                
                const tbody = verificationPanel.querySelector('tbody');
                const tfoot = verificationPanel.querySelector('tfoot');
                
                tbody.innerHTML = verificationResult.monthly.map(row => `
                    <tr>
                        <td class="px-4 py-2">${row.month}</td>
                        <td class="px-4 py-2 text-right">${row.ncs.toLocaleString()}</td>
                        <td class="px-4 py-2 text-right">${row.vendor.toLocaleString()}</td>
                        <td class="px-4 py-2 text-right ${row.diff !== 0 ? 'text-red-500 font-bold' : ''}">${row.diff.toLocaleString()}</td>
                    </tr>`).join('');
                
                tfoot.innerHTML = `<tr class="font-bold bg-slate-100">
                    <td class="px-4 py-2">í•©ê³„</td>
                    <td class="px-4 py-2 text-right">${verificationResult.total.ncs.toLocaleString()}</td>
                    <td class="px-4 py-2 text-right">${verificationResult.total.vendor.toLocaleString()}</td>
                    <td class="px-4 py-2 text-right ${verificationResult.total.diff !== 0 ? 'text-red-500 font-bold' : ''}">${verificationResult.total.diff.toLocaleString()}</td>
                </tr>`;
            }
        },
        handlePhase4AddVendor() {
            const currentDOMData = this._getPhase4DOMData();
            AppState.setState(state => {
                const { activeClient } = state.phases.phase4;
                if (!activeClient) return state;
                const clientData = currentDOMData || { vendors: [], isVerified: false, verificationStatus: null };
                const newVendorName = clientData.vendors.length === 0 ? activeClient : `${activeClient} ${clientData.vendors.length + 1}`;
                clientData.vendors.push({ name: newVendorName, items: [{ type: 'ì¹´ê³¼', monthlyAmounts: {} }] });
                return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, clientData: { ...state.phases.phase4.clientData, [activeClient]: clientData } } } };
            });
        },
        handlePhase4AddItem(vendorIndex) {
            const currentDOMData = this._getPhase4DOMData();
            AppState.setState(state => {
                const { activeClient } = state.phases.phase4;
                if (!activeClient) return state;
                const clientData = currentDOMData;
                clientData.vendors[vendorIndex].items.push({ type: 'ì¹´ê³¼', monthlyAmounts: {} });
                return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, clientData: { ...state.phases.phase4.clientData, [activeClient]: clientData } } } };
            });
        },
        handlePhase4DeleteItem(vendorIndex, itemIndex) {
            const currentDOMData = this._getPhase4DOMData();
            AppState.setState(state => {
                const { activeClient } = state.phases.phase4;
                if (!activeClient) return state;
                const clientData = currentDOMData;
                if (clientData && clientData.vendors[vendorIndex] && clientData.vendors[vendorIndex].items) {
                    clientData.vendors[vendorIndex].items.splice(itemIndex, 1);
                }
                return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, clientData: { ...state.phases.phase4.clientData, [activeClient]: clientData } } } };
            });
        },
        handlePhase4DeleteVendor(vendorIndex) {
            UIRenderer.showModal(
                'ë§¤ì¶œì²˜ ì‚­ì œ',
                'ì´ ë§¤ì¶œì²˜ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                [
                    { text: 'ì·¨ì†Œ', className: 'bg-slate-300 text-slate-800 hover:bg-slate-400', onClick: () => UIRenderer.hideModal() },
                    { 
                        text: 'ì‚­ì œ', 
                        className: 'bg-red-600 text-white hover:bg-red-700', 
                        onClick: () => {
                            const currentDOMData = this._getPhase4DOMData();
                            AppState.setState(state => {
                                const { activeClient } = state.phases.phase4;
                                if (!activeClient) return state;
                                const clientData = currentDOMData;
                                clientData.vendors.splice(vendorIndex, 1);
                                return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, clientData: { ...state.phases.phase4.clientData, [activeClient]: clientData } } } };
                            });
                            UIRenderer.hideModal();
                        } 
                    }
                ]
            );
        },
        formatNumberInput(event) {
            const input = event.target;
            const selectionStart = input.selectionStart;
            const originalLength = input.value.length;
            let value = input.value.replace(/,/g, '');
            if (isNaN(value) || value.trim() === '') {
                 input.value = '';
            } else {
                const numericValue = parseFloat(value);
                input.value = numericValue.toLocaleString('ko-KR');
            }
            const newLength = input.value.length;
            const newSelectionStart = selectionStart + (newLength - originalLength);
            if (newSelectionStart >= 0) {
                 input.selectionStart = newSelectionStart;
                 input.selectionEnd = newSelectionStart;
            }
        },
        handlePhase4ReflectChanges() {
             const currentDOMData = this._getPhase4DOMData();
             if(!currentDOMData) return;
             AppState.setState(state => {
                const { activeClient } = state.phases.phase4;
                return { ...state, phases: { ...state.phases, phase4: { ...state.phases.phase4, clientData: { ...state.phases.phase4.clientData, [activeClient]: currentDOMData } } } };
             });
        },
        handlePhase4Verify() {
            this.handlePhase4ReflectChanges();
            setTimeout(() => {
                const state = AppState.getState();
                const { activeClient } = state.phases.phase4;
                const clientNCSData = state.phases.phase2.output.filter(row => row[1] === activeClient);
                const clientVendorData = state.phases.phase4.clientData[activeClient]?.vendors || [];
                const result = DataTransformer.calculatePhase4Verification(clientNCSData, clientVendorData);
                
                if (result.isTotalMatch && result.isMonthlyMatch) {
                    UIRenderer.showModal('ê²€ì¦ ì™„ë£Œ', 'ì›”ë³„ ê¸ˆì•¡ê³¼ ì´ì•¡ì´ ëª¨ë‘ ì¼ì¹˜í•©ë‹ˆë‹¤.', [
                        { text: 'ìˆ˜ì •', className: 'bg-slate-300 text-slate-800 hover:bg-slate-400', onClick: () => UIRenderer.hideModal() },
                        { text: 'í™•ì •', className: 'bg-indigo-600 text-white hover:bg-indigo-700', onClick: () => { this.handlePhase4ConfirmVerification('perfect'); UIRenderer.hideModal(); } }
                    ]);
                } else {
                    let message = '';
                    if (result.isTotalMatch && !result.isMonthlyMatch) {
                        message = 'ì›”ë³„ ê¸ˆì•¡ì€ ë‹¤ë¥´ì§€ë§Œ ì´ì•¡ì€ ì¼ì¹˜í•©ë‹ˆë‹¤.';
                    } else {
                        const diff = result.total.diff;
                        const diffText = diff > 0 
                            ? `ì…ë ¥ëœ ê¸ˆì•¡ì´ êµ­ì„¸ì²­ ê¸ˆì•¡ë³´ë‹¤ ${diff.toLocaleString()}ì› ë§ìŠµë‹ˆë‹¤.` 
                            : `ì…ë ¥ëœ ê¸ˆì•¡ì´ êµ­ì„¸ì²­ ê¸ˆì•¡ë³´ë‹¤ ${Math.abs(diff).toLocaleString()}ì› ì ìŠµë‹ˆë‹¤.`;
                        message = `ê¸ˆì•¡ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ${diffText}`;
                    }
                    
                    UIRenderer.showModal('í™•ì¸ í•„ìš”', `${message}<br><br>ì´ëŒ€ë¡œ ì‘ì—…ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
                        { text: 'ìˆ˜ì •', className: 'bg-slate-300 text-slate-800 hover:bg-slate-400', onClick: () => UIRenderer.hideModal() },
                        { text: 'ë¬´ì‹œí•˜ê³  í™•ì •', className: 'bg-indigo-600 text-white hover:bg-indigo-700', onClick: () => { this.handlePhase4ConfirmVerification('forced'); UIRenderer.hideModal(); } }
                    ]);
                }
            }, 100);
        },
        handlePhase4ConfirmVerification(status) {
            AppState.setState(state => {
                const { activeClient } = state.phases.phase4;
                if (!activeClient) return state;
                
                const newClientData = JSON.parse(JSON.stringify(state.phases.phase4.clientData));
                const currentClient = newClientData[activeClient] || { vendors: [] };

                currentClient.isVerified = true;
                currentClient.verificationStatus = status;
                newClientData[activeClient] = currentClient;

                const newState = {
                    ...state,
                    phases: {
                        ...state.phases,
                        phase4: {
                            ...state.phases.phase4,
                            clientData: newClientData
                        }
                    }
                };
                newState.phases.phase4.isComplete = AppController.checkAllClientsVerified(newState);

                return newState;
            });
        },
        checkAllClientsVerified(state) {
            const finalClients = Array.from(new Set(state.phases.phase2.output.map(row => row[1])));
            return finalClients.length > 0 && finalClients.every(client => state.phases.phase4.clientData[client]?.isVerified);
        },
        goToPhase5() {
            const state = AppState.getState();
            const verificationResult = DataTransformer.calculatePhase5InitialVerification(state);
            AppState.setState(s => ({
                ...s,
                currentPhase: 'phase5',
                phases: {
                    ...s.phases,
                    phase4: {...s.phases.phase4, isComplete: true},
                    phase5: {
                        ...s.phases.phase5,
                        subPhase: 'verification',
                        verificationResult: verificationResult,
                        finalResult: null,
                        referenceData: null
                    }
                }
            }));
            
            const { diff } = verificationResult;
            let message;
            if (diff < 0) {
                message = `1) ì—…ì²´ì „ì†¡ë§¤ì¶œë‚´ì—­ì´ êµ­ì„¸ì²­ ë‚´ì—­ë³´ë‹¤ ${Math.abs(diff).toLocaleString()}ì› ì ìŠµë‹ˆë‹¤. ì—…ì²´ ì „ì†¡ ë§¤ì¶œì— ì˜¤ë¥˜ê°€ ìˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.`;
            } else if (diff === 0) {
                message = `2) ì—…ì²´ì „ì†¡ë§¤ì¶œë‚´ì—­ì´ êµ­ì„¸ì²­ ë‚´ì—­ê³¼ ê°™ìŠµë‹ˆë‹¤. êµ­ì„¸ì²­ ë§¤ì¶œ ì´ì™¸ì˜ ë‚´ì—­(ex)ì˜¤í”„ë¼ì¸ ë“±)ì´ ì—†ìœ¼ë©´ ì´ëŒ€ë¡œ í™•ì •í•˜ì‹œë©´ ë©ë‹ˆë‹¤.`;
            } else {
                message = `3) ì—…ì²´ì „ì†¡ë§¤ì¶œë‚´ì—­ì´ êµ­ì„¸ì²­ ë‚´ì—­ë³´ë‹¤ ${diff.toLocaleString()}ì› ë§ìŠµë‹ˆë‹¤. êµ­ì„¸ì²­ì— í‘œì‹œë˜ì§€ ì•Šì€ ë§¤ì¶œì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }

            UIRenderer.showModal('ìµœì¢… ê²€ì¦', `${message}<br><br>ì´ëŒ€ë¡œ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
                { text: 'ì•„ë‹ˆì˜¤ (4ë‹¨ê³„ ì¬ì‘ì—…)', className: 'bg-slate-300 text-slate-800', onClick: () => { AppController.navigate('phase4'); UIRenderer.hideModal(); } },
                { text: 'ì˜ˆ (í™•ì •)', className: 'bg-indigo-600 text-white', onClick: () => { AppController.handlePhase5InitialConfirm(); } }
            ]);
        },
        handlePhase5InitialConfirm() {
            const extraContent = `
                <div class="space-y-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰ê¸ˆì•¡ì„ ì–´ë””ì—ì„œ ì°¨ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="inline-flex items-center"><input type="radio" name="deduct-from" value="kaGwa" class="form-radio h-4 w-4 text-indigo-600"> <span class="ml-2">ì¹´ê³¼</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="deduct-from" value="geonByeol" class="form-radio h-4 w-4 text-indigo-600"> <span class="ml-2">ê±´ë³„</span></label>
                        </div>
                    </div>
                    <div>
                        <label for="offline-card-sales" class="block text-sm font-medium text-gray-700">ì˜¨ë¼ì¸ ë§¤ì¶œ ì´ì™¸ì— ì¹´ë“œë§¤ì¶œê¸ˆì•¡ì€ ì–¼ë§ˆì¸ê°€ìš”? (ì‹¤ì œ ì¥ë¶€ì— ë°˜ì˜í•œ ê¸ˆì•¡)</label>
                        <input type="text" id="offline-card-sales" inputmode="numeric" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="0">
                    </div>
                </div>
            `;
            UIRenderer.showModal('ì¶”ê°€ ì •ë³´ ì…ë ¥', 'ìµœì¢… ì§‘ê³„ë¥¼ ìœ„í•´ ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', [
                { text: 'ì·¨ì†Œ', className: 'bg-slate-300 text-slate-800', onClick: () => UIRenderer.hideModal() },
                { text: 'í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => AppController.handlePhase5Finalize() }
            ], extraContent);
            document.getElementById('offline-card-sales').addEventListener('input', this.formatNumberInput);
        },
        handlePhase5Finalize() {
            const deductFrom = document.querySelector('input[name="deduct-from"]:checked')?.value;
            const offlineSalesInput = document.getElementById('offline-card-sales');
            const offlineCardSales = parseFloat(offlineSalesInput.value.replace(/,/g, '')) || 0;

            if (!deductFrom) {
                alert('í˜„ê¸ˆì˜ìˆ˜ì¦ ì°¨ê° í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const state = AppState.getState();
            const config = { deductFrom, offlineCardSales };
            const finalResult = DataTransformer.calculatePhase5FinalResults(state, config);
            const referenceData = DataTransformer.calculatePhase5ReferenceData(state, finalResult, config);
            
            AppState.setState(s => ({ ...s, phases: { ...s.phases, phase5: { ...s.phases.phase5, subPhase: 'results', config, finalResult, referenceData } } }));
            UIRenderer.hideModal();
        },
        handleExcelDownload() {
            UIRenderer.showModal(
                'ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜µì…˜',
                'ì„¸ë¬´í”„ë¡œê·¸ë¨ì— ì…ë ¥ëœ ê±°ë˜ì²˜ëª…ì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><small>(ì´ ì‘ì—…ì€ í”„ë¡œê·¸ë¨ì˜ ì½”ë“œë¥¼ ëŠ˜ë¦¬ì§€ ì•Šê³ , ê¸°ì¡´ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì‘ì—…ì…ë‹ˆë‹¤.)</small>',
                [
                    { text: 'ì•„ë‹ˆì˜¤', className: 'bg-slate-300 text-slate-800', onClick: () => {
                        DataTransformer.generateExcel();
                        UIRenderer.hideModal();
                    }},
                    { text: 'ì˜ˆ', className: 'bg-indigo-600 text-white', onClick: () => AppController.promptForNewClientNames() }
                ]
            );
        },
        promptForNewClientNames() {
            const state = AppState.getState();
            const originalClients = [...new Set(state.phases.phase2.output.map(row => row[1]))].sort();
            
            let inputsHTML = '<div class="space-y-2 mt-4 max-h-64 overflow-y-auto">';
            originalClients.forEach(client => {
                inputsHTML += `
                    <div class="grid grid-cols-2 gap-2 items-center">
                        <label class="text-sm font-medium text-gray-700">${client}</label>
                        <input type="text" data-original-name="${client}" class="new-client-name-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="ë³€ê²½í•  ì´ë¦„ ì…ë ¥">
                    </div>
                `;
            });
            inputsHTML += '</div>';

            UIRenderer.showModal(
                'ê±°ë˜ì²˜ëª… ë³€ê²½',
                'ì„¸ë¬´í”„ë¡œê·¸ë¨ì— ì—…ë¡œë“œí•  ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                [
                    { text: 'ì·¨ì†Œ', className: 'bg-slate-300 text-slate-800', onClick: () => UIRenderer.hideModal() },
                    { text: 'ê±°ë˜ì²˜ëª… ë³€ê²½ í™•ì¸', className: 'bg-indigo-600 text-white', onClick: () => AppController.generateExcelWithNewNames() }
                ],
                inputsHTML
            );
        },
        generateExcelWithNewNames() {
            const nameMap = new Map();
            document.querySelectorAll('.new-client-name-input').forEach(input => {
                const originalName = input.dataset.originalName;
                const newName = input.value.trim();
                if (newName) {
                    nameMap.set(originalName, newName);
                }
            });
            DataTransformer.generateExcel(nameMap);
            UIRenderer.hideModal();
        }
    };

    // --- 4. ë°ì´í„° ë³€í™˜ ë¡œì§ (Data Transformer) ---
    const DataTransformer = {
        parseYearMonth(dateValue) {
            if (dateValue === null || dateValue === undefined) return null;
            if (typeof dateValue === 'number' && dateValue > 1) {
                try {
                    const date = XLSX.SSF.parse_date_code(dateValue);
                    if (date) return { year: date.y, month: date.m };
                } catch(e) {}
            }
            const dateStr = String(dateValue).trim();
            const match = dateStr.match(/^(\d{4})[-.\/\s]?(\d{1,2})/);
            if (match) {
                const year = parseInt(match[1], 10);
                const month = parseInt(match[2], 10);
                if (year > 1900 && year < 3000 && month >= 1 && month <= 12) return { year, month };
            }
            return null;
        },
        transformPhase1(data, headerRow) {
            if (headerRow === null) return data;
            const header = data[headerRow];
            const dataStartIndex = headerRow + 1;
            const body = data.slice(dataStartIndex);
            const filteredBody = body.filter(row => row && row.some(cell => cell !== null && String(cell).trim() !== ''));
            return [header, ...filteredBody];
        },
        transformPhase2(sourceData, phase1Config, phase2Config) {
            const { approvalDateCol, clientCol, countCol, amountCol } = phase1Config;
            const { workInfo, cleansing } = phase2Config;
            const periodMap = {
                '1ê¸°ì˜ˆì • (1~3ì›”)': { start: 1, end: 3 }, '1ê¸°í™•ì • (4~6ì›”)': { start: 4, end: 6 },
                '1ê¸°ì˜ˆì • ë° í™•ì • (1~6ì›”)': { start: 1, end: 6 }, '2ê¸°ì˜ˆì • (7~9ì›”)': { start: 7, end: 9 },
                '2ê¸°í™•ì • (10~12ì›”)': { start: 10, end: 12 }, '2ê¸°ì˜ˆì • ë° í™•ì • (7~12ì›”)': { start: 7, end: 12 }
            };
            const monthRange = periodMap[workInfo.workPeriod];
            const mergeMap = new Map();
            cleansing.merged.forEach(group => group.values.forEach(val => mergeMap.set(val, group.name)));
            const sourceClients = new Set(sourceData.slice(1).map(row => row[clientCol]).filter(Boolean));
            const finalClients = new Set();
            sourceClients.forEach(client => {
                if (cleansing.deleted.includes(client)) return;
                finalClients.add(mergeMap.get(client) || client);
            });
            cleansing.added.forEach(client => finalClients.add(client.name));
            const resultMap = new Map();
            const sortedFinalClients = Array.from(finalClients).sort();
            for (const client of sortedFinalClients) {
                for (let m = monthRange.start; m <= monthRange.end; m++) {
                    const yearMonth = `${workInfo.workYear}-${String(m).padStart(2, '0')}`;
                    resultMap.set(`${yearMonth}|${client}`, { yearMonth, client, count: 0, amount: 0 });
                }
            }
            sourceData.slice(1).forEach(row => {
                let clientName = row[clientCol];
                if (!clientName || cleansing.deleted.includes(clientName)) return;
                clientName = mergeMap.get(clientName) || clientName;
                const parsedDate = this.parseYearMonth(row[approvalDateCol]);
                if (!parsedDate) return;
                const { year, month } = parsedDate;
                if (year === parseInt(workInfo.workYear, 10) && month >= monthRange.start && month <= monthRange.end) {
                    const yearMonth = `${workInfo.workYear}-${String(month).padStart(2, '0')}`;
                    const key = `${yearMonth}|${clientName}`;
                    if (resultMap.has(key)) {
                        const entry = resultMap.get(key);
                        const countValue = parseFloat(String(row[countCol]).replace(/,/g, ''));
                        const amountValue = parseFloat(String(row[amountCol]).replace(/,/g, ''));
                        if (!isNaN(countValue)) entry.count += countValue;
                        if (!isNaN(amountValue)) entry.amount += amountValue;
                    }
                }
            });
            return Array.from(resultMap.values()).map(d => [d.yearMonth, d.client, d.count, d.amount]);
        },
        reconcilePhase4Data(oldClientData, cleansingConfig, originalUniqueClients) {
            const newClientData = {};
            const { deleted, merged, added } = cleansingConfig;

            // 1. Handle merged clients
            merged.forEach(group => {
                const mergedVendors = [];
                group.values.forEach(oldClientName => {
                    if (oldClientData[oldClientName] && oldClientData[oldClientName].vendors) {
                        mergedVendors.push(...oldClientData[oldClientName].vendors);
                    }
                });
                if (mergedVendors.length > 0) {
                    newClientData[group.name] = {
                        vendors: mergedVendors,
                        isVerified: false, // Force re-verification
                        verificationStatus: null
                    };
                }
            });

            // 2. Handle existing, non-deleted, non-merged clients
            Object.keys(oldClientData).forEach(clientName => {
                const isDeleted = deleted.includes(clientName);
                const isInMerge = merged.some(g => g.values.includes(clientName));
                if (!isDeleted && !isInMerge) {
                    newClientData[clientName] = oldClientData[clientName];
                }
            });
            
            // 3. Add newly added clients (they will be empty)
            added.forEach(client => {
                if (!newClientData[client.name]) {
                    newClientData[client.name] = { vendors: [], isVerified: false, verificationStatus: null };
                }
            });
            
            return newClientData;
        },
        calculatePhase4Verification(ncsData, vendorData) {
            const monthlyResults = {};
            const months = [...new Set(ncsData.map(row => row[0]))].sort();

            months.forEach(month => {
                monthlyResults[month] = { month, ncs: 0, vendor: 0, diff: 0 };
            });

            ncsData.forEach(row => {
                const month = row[0];
                const amount = row[3] || 0;
                if (monthlyResults[month]) {
                    monthlyResults[month].ncs += amount;
                }
            });

            (vendorData || []).forEach(vendor => {
                vendor.items.forEach(item => {
                    if (item.type !== 'í˜„ê³¼') {
                        Object.entries(item.monthlyAmounts).forEach(([month, amount]) => {
                            if (monthlyResults[month]) {
                                monthlyResults[month].vendor += amount || 0;
                            }
                        });
                    }
                });
            });

            let totalNCS = 0;
            let totalVendor = 0;
            Object.values(monthlyResults).forEach(res => {
                res.diff = res.vendor - res.ncs;
                totalNCS += res.ncs;
                totalVendor += res.vendor;
            });

            const totalDiff = totalVendor - totalNCS;
            const isTotalMatch = totalDiff === 0;
            const isMonthlyMatch = Object.values(monthlyResults).every(res => res.diff === 0);

            return {
                monthly: Object.values(monthlyResults),
                total: { ncs: totalNCS, vendor: totalVendor, diff: totalDiff },
                isTotalMatch,
                isMonthlyMatch
            };
        },
        calculatePhase5InitialVerification(state) {
            const { phase2, phase3, phase4 } = state.phases;
            
            let totalVendorSales = 0;
            Object.values(phase4.clientData).forEach(client => {
                (client.vendors || []).forEach(vendor => {
                    vendor.items.forEach(item => {
                        totalVendorSales += Object.values(item.monthlyAmounts).reduce((sum, amount) => sum + amount, 0);
                    });
                });
            });

            const ncsCardSales = phase2.output.reduce((sum, row) => sum + (row[3] || 0), 0);
            const cashReceiptSales = phase3.config.cashReceiptAmount || 0;
            const totalNCSSales = ncsCardSales + cashReceiptSales;

            return {
                totalVendorSales,
                totalNCSSales,
                diff: totalVendorSales - totalNCSSales
            };
        },
        calculatePhase5FinalResults(state, config) {
            const { phase3, phase4 } = state.phases;
            const { deductFrom, offlineCardSales } = config;

            const phase4Totals = { kaGwa: 0, geonByeol: 0, hyunGwa: 0, kaGwaSeonbul: 0 };
            Object.values(phase4.clientData).forEach(client => {
                 (client.vendors || []).forEach(vendor => {
                    vendor.items.forEach(item => {
                        const totalAmount = Object.values(item.monthlyAmounts).reduce((sum, amount) => sum + amount, 0);
                        if (item.type === 'ì¹´ê³¼') phase4Totals.kaGwa += totalAmount;
                        else if (item.type === 'ê±´ë³„') phase4Totals.geonByeol += totalAmount;
                        else if (item.type === 'í˜„ê³¼') phase4Totals.hyunGwa += totalAmount;
                        else if (item.type === 'ì¹´ê³¼(ì„ ë¶ˆ)') phase4Totals.kaGwaSeonbul += totalAmount;
                    });
                });
            });

            const companyTotal = phase4Totals.kaGwa + phase4Totals.geonByeol + phase4Totals.hyunGwa + phase4Totals.kaGwaSeonbul;
            
            const cashReceiptAmount = phase3.config.cashReceiptAmount || 0;
            const composition = { 
                kaGwa: 0, 
                geonByeol: 0, 
                hyunGwa: cashReceiptAmount, 
                kaGwaSeonbul: phase4Totals.kaGwaSeonbul,
                total: companyTotal
            };
            
            if (deductFrom === 'kaGwa') {
                composition.kaGwa = (phase4Totals.kaGwa + phase4Totals.hyunGwa) - cashReceiptAmount;
                composition.geonByeol = phase4Totals.geonByeol;
            } else { // deductFrom === 'geonByeol'
                composition.kaGwa = phase4Totals.kaGwa; 
                composition.geonByeol = (phase4Totals.geonByeol + phase4Totals.hyunGwa) - cashReceiptAmount;
            }

            const finalBreakdown = { ...composition };
            finalBreakdown.kaGwa += offlineCardSales;
            finalBreakdown.total = companyTotal + offlineCardSales;

            return { companyTotal, composition, finalBreakdown };
        },
        calculatePhase5ReferenceData(state, finalResult, config) {
            const { upload, phase1, phase2, phase3 } = state.phases;

            const ntsOnlineSales = (phase2.output || []).reduce((sum, row) => sum + (row[3] || 0), 0);
            const ntsCashReceiptSales = phase3.config.cashReceiptAmount || 0;
            
            const { headerRow, clientCol, amountCol, approvalDateCol } = phase1.config;
            let ntsCreditCardSales = 0;

            if (upload.rawData.length > 0 && headerRow !== null && clientCol !== null && amountCol !== null && approvalDateCol !== null) {
                const originalDataBody = upload.rawData.slice(headerRow + 1);
                originalDataBody.forEach(row => {
                    const clientName = row[clientCol];
                    if (row && typeof clientName === 'string' && clientName.includes('ì‹ ìš©ì¹´ë“œ') && !clientName.includes('í•©ê³„') && this.parseYearMonth(row[approvalDateCol])) {
                        const amount = parseFloat(String(row[amountCol]).replace(/,/g, '')) || 0;
                        ntsCreditCardSales += amount;
                    }
                });
            }
            
            // CHANGED: Corrected reference data calculation
            const userCreditCardSales = config.offlineCardSales || 0;
            const userCashReceiptSales = finalResult.composition.hyunGwa;
            const userOtherSales = finalResult.composition.kaGwa + finalResult.composition.geonByeol + finalResult.composition.kaGwaSeonbul;

            return { ntsOnlineSales, ntsCashReceiptSales, ntsCreditCardSales, userCreditCardSales, userCashReceiptSales, userOtherSales };
        },
        generateExcel(nameMap = new Map()) {
            const state = AppState.getState();
            const { phase4, phase5 } = state.phases;
            const { deductFrom } = phase5.config;

            // --- Sheet 1: ì…ë ¥ë‚´ìš©ìƒì„¸ ---
            const ws1_data = [['ê±°ë˜ì²˜ëª…', 'ì›”', 'ì¹´ê³¼', 'í˜„ê³¼', 'ê±´ë³„', 'ì¹´ê³¼(ì„ ë¶ˆ)', 'í•©ê³„']];
            const grandTotals = { kaGwa: 0, hyunGwa: 0, geonByeol: 0, kaGwaSeonbul: 0, total: 0 };

            Object.entries(phase4.clientData).forEach(([clientName, clientData]) => {
                if (!clientData.isVerified) return;
                const monthlyTotals = {};
                (clientData.vendors || []).forEach(vendor => {
                    vendor.items.forEach(item => {
                        Object.entries(item.monthlyAmounts).forEach(([month, amount]) => {
                            if (!monthlyTotals[month]) {
                                monthlyTotals[month] = { kaGwa: 0, hyunGwa: 0, geonByeol: 0, kaGwaSeonbul: 0 };
                            }
                            if(item.type === 'ì¹´ê³¼') monthlyTotals[month].kaGwa += amount;
                            else if(item.type === 'í˜„ê³¼') monthlyTotals[month].hyunGwa += amount;
                            else if(item.type === 'ê±´ë³„') monthlyTotals[month].geonByeol += amount;
                            else if(item.type === 'ì¹´ê³¼(ì„ ë¶ˆ)') monthlyTotals[month].kaGwaSeonbul += amount;
                        });
                    });
                });
                
                let clientTotal = 0;
                Object.entries(monthlyTotals).sort().forEach(([month, data]) => {
                    const monthTotal = data.kaGwa + data.hyunGwa + data.geonByeol + data.kaGwaSeonbul;
                    clientTotal += monthTotal;
                    ws1_data.push([clientName, month, data.kaGwa || 0, data.hyunGwa || 0, data.geonByeol || 0, data.kaGwaSeonbul || 0, monthTotal]);
                });
                const clientTotalRow = { kaGwa: 0, hyunGwa: 0, geonByeol: 0, kaGwaSeonbul: 0 };
                Object.values(monthlyTotals).forEach(data => {
                    clientTotalRow.kaGwa += data.kaGwa;
                    clientTotalRow.hyunGwa += data.hyunGwa;
                    clientTotalRow.geonByeol += data.geonByeol;
                    clientTotalRow.kaGwaSeonbul += data.kaGwaSeonbul;
                });
                ws1_data.push([`${clientName} í•©ê³„`, '', clientTotalRow.kaGwa, clientTotalRow.hyunGwa, clientTotalRow.geonByeol, clientTotalRow.kaGwaSeonbul, clientTotal]);
                
                grandTotals.kaGwa += clientTotalRow.kaGwa;
                grandTotals.hyunGwa += clientTotalRow.hyunGwa;
                grandTotals.geonByeol += clientTotalRow.geonByeol;
                grandTotals.kaGwaSeonbul += clientTotalRow.kaGwaSeonbul;
                grandTotals.total += clientTotal;
            });
            ws1_data.push([]); // Spacer row
            ws1_data.push(['ì´í•©ê³„', '', grandTotals.kaGwa, grandTotals.hyunGwa, grandTotals.geonByeol, grandTotals.kaGwaSeonbul, grandTotals.total]);

            const ws1 = XLSX.utils.aoa_to_sheet(ws1_data);
            
            // --- Sheet 2: ë§¤ì¶œì—…ë¡œë“œ ì–‘ì‹ ---
            const kaGwaData = [['ì¹´ê³¼ì˜ì—­'],['ê±°ë˜ì¼', 'ì—…ì²´ëª…', 'ë§¤ì¶œê¸ˆì•¡', 'ì ìš”']];
            const geonByeolData = [['ê±´ë³„ì˜ì—­'],['ê±°ë˜ì¼', 'ì—…ì²´ëª…', 'ë§¤ì¶œê¸ˆì•¡', 'ì ìš”']];
            const kaGwaSeonbulData = [['ì¹´ê³¼(ì„ ë¶ˆ)ì˜ì—­'],['ê±°ë˜ì¼', 'ì—…ì²´ëª…', 'ë§¤ì¶œê¸ˆì•¡', 'ì ìš”']];

            Object.entries(phase4.clientData).forEach(([originalClientName, clientData]) => {
                 if (!clientData.isVerified) return;

                const finalClientName = nameMap.get(originalClientName) || originalClientName;

                (clientData.vendors || []).forEach(vendor => {
                    const monthlyAggregates = {};
                     vendor.items.forEach(item => {
                        Object.entries(item.monthlyAmounts).forEach(([month, amount]) => {
                            if (!monthlyAggregates[month]) {
                                monthlyAggregates[month] = { kaGwa: 0, hyunGwa: 0, geonByeol: 0, kaGwaSeonbul: 0 };
                            }
                            if(item.type === 'ì¹´ê³¼') monthlyAggregates[month].kaGwa += amount;
                            else if(item.type === 'í˜„ê³¼') monthlyAggregates[month].hyunGwa += amount;
                            else if(item.type === 'ê±´ë³„') monthlyAggregates[month].geonByeol += amount;
                            else if(item.type === 'ì¹´ê³¼(ì„ ë¶ˆ)') monthlyAggregates[month].kaGwaSeonbul += amount;
                        });
                    });

                    Object.entries(monthlyAggregates).sort().forEach(([month, data]) => {
                        const transactionDate = `${month}-01`;
                        const description = `${vendor.name} ${month.slice(5,7)}ì›”`;
                        let kaGwaAmount = 0;
                        let geonByeolAmount = 0;

                        if (deductFrom === 'kaGwa') {
                            kaGwaAmount = data.kaGwa + data.hyunGwa;
                            geonByeolAmount = data.geonByeol;
                        } else { // deductFrom === 'geonByeol'
                            kaGwaAmount = data.kaGwa;
                            geonByeolAmount = data.geonByeol + data.hyunGwa;
                        }
                        
                        if (kaGwaAmount !== 0) kaGwaData.push([transactionDate, finalClientName, kaGwaAmount, description]);
                        if (geonByeolAmount !== 0) geonByeolData.push([transactionDate, finalClientName, geonByeolAmount, description]);
                        if (data.kaGwaSeonbul !== 0) kaGwaSeonbulData.push([transactionDate, finalClientName, data.kaGwaSeonbul, description]);
                    });
                });
            });

            const ws2 = XLSX.utils.aoa_to_sheet([]);
            XLSX.utils.sheet_add_aoa(ws2, kaGwaData, { origin: 'A1' });
            XLSX.utils.sheet_add_aoa(ws2, geonByeolData, { origin: 'F1' });
            XLSX.utils.sheet_add_aoa(ws2, kaGwaSeonbulData, { origin: 'K1' });

            // --- Workbook creation and styling ---
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws1, "ì…ë ¥ë‚´ìš©ìƒì„¸");
            XLSX.utils.book_append_sheet(wb, ws2, "ë§¤ì¶œì—…ë¡œë“œ ì–‘ì‹");
            
            const moneyFormat = '#,##0';
            const headerStyle = { font: { bold: true }, fill: { fgColor: { rgb: "FFFDE99A" } }, alignment: { horizontal: 'center', vertical: 'center'} };
            const totalStyle = { font: { bold: true }, fill: { fgColor: { rgb: "FFD3D3D3" } } };

            // Style Sheet 1
            const ws1Cols = [ {wch:30}, {wch:12}, {wch:15}, {wch:15}, {wch:15}, {wch:15}, {wch:18} ];
            ws1['!cols'] = ws1Cols;
            Object.keys(ws1).forEach(cellAddress => {
                if (cellAddress[0] === '!') return;
                const cell = ws1[cellAddress];
                const { c, r } = XLSX.utils.decode_cell(cellAddress);
                const cellStyle = JSON.parse(JSON.stringify(cell.s || {}));

                if (r === 0) { Object.assign(cellStyle, headerStyle); }
                if (c >= 2 && r > 0 && typeof cell.v === 'number') {
                    cell.t = 'n';
                    cellStyle.numFmt = moneyFormat;
                }
                if(ws1_data[r] && (ws1_data[r][0].includes('í•©ê³„'))) {
                    Object.assign(cellStyle, totalStyle);
                }
                if (Object.keys(cellStyle).length > 0) cell.s = cellStyle;
            });

            // Style Sheet 2
            const ws2Cols = [ {wch:12}, {wch:25}, {wch:15}, {wch:30}, {wch:5}, {wch:12}, {wch:25}, {wch:15}, {wch:30}, {wch:5}, {wch:12}, {wch:25}, {wch:15}, {wch:30} ];
            ws2['!cols'] = ws2Cols;
            Object.keys(ws2).forEach(cellAddress => {
                if (cellAddress[0] === '!') return;
                const cell = ws2[cellAddress];
                const { c, r } = XLSX.utils.decode_cell(cellAddress);
                const cellStyle = JSON.parse(JSON.stringify(cell.s || {}));

                if (r === 0 || r === 1) { Object.assign(cellStyle, headerStyle); }
                if ('CHM'.includes(XLSX.utils.encode_col(c)) && r > 1) { 
                     if(typeof cell.v === 'number') {
                        cell.t = 'n'; 
                        cellStyle.numFmt = moneyFormat; 
                    }
                }
                if (Object.keys(cellStyle).length > 0) cell.s = cellStyle;
            });

            const workInfo = AppState.getState().phases.phase2.config.workInfo;
            const filename = `ì—…ë¡œë“œìš©ì—‘ì…€_${workInfo.clientName}_${workInfo.workYear}_${workInfo.workPeriod}.xlsx`;
            XLSX.writeFile(wb, filename, { bookType: 'xlsx', type: 'binary', cellStyles: true });
        }
    };

    // --- PDF Generation Functions ---
    function showPdfPreview(areaId) {
        const originalElement = document.getElementById(areaId);
        if (!originalElement) return;

        const contentToPreview = originalElement.cloneNode(true);
        contentToPreview.style.backgroundColor = 'white';
        contentToPreview.querySelectorAll('*').forEach(el => el.style.color = '#111827');
        contentToPreview.querySelectorAll('button').forEach(btn => btn.remove());
        
        const previewBody = document.getElementById('preview-body');
        previewBody.innerHTML = '';
        previewBody.appendChild(contentToPreview);
        document.getElementById('preview-modal').style.display = 'flex';
    }

    function closePreviewModal() {
        document.getElementById('preview-modal').style.display = 'none';
        document.getElementById('preview-body').innerHTML = '';
    }

    async function generatePdfFromPreview() {
        const modalActions = document.getElementById('modal-actions');
        const loadingSpinner = document.getElementById('loading-spinner');
        const previewBody = document.getElementById('preview-body');
        const contentToPrint = previewBody.querySelector(':first-child');
        
        if (!contentToPrint) return;

        modalActions.style.display = 'none';
        loadingSpinner.style.display = 'block';

        const state = AppState.getState();
        const workInfo = state.phases.phase2.config.workInfo;
        const filename = `ë§¤ì¶œë¶„ì„_${workInfo.clientName}_${workInfo.workYear}_${workInfo.workPeriod}_${new Date().toISOString().slice(0, 10)}.pdf`;

        try {
            const canvas = await html2canvas(contentToPrint, {
                scale: 2,
                useCORS: true,
                scrollX: 0,
                scrollY: -window.scrollY
            });
            
            const imgData = canvas.toDataURL('image/jpeg', 0.98);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'pt',
                format: 'a4'
            });
            
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            const imgProps = doc.getImageProperties(imgData);
            const imgRatio = imgProps.width / imgProps.height;
            let finalImgWidth, finalImgHeight;

            if (imgRatio > (pdfWidth / pdfHeight)) {
                finalImgWidth = pdfWidth - 40; // Add some margin
                finalImgHeight = finalImgWidth / imgRatio;
            } else {
                finalImgHeight = pdfHeight - 40; // Add some margin
                finalImgWidth = finalImgHeight * imgRatio;
            }
            
            const xPos = (pdfWidth - finalImgWidth) / 2;
            const yPos = (pdfHeight - finalImgHeight) / 2;

            doc.addImage(imgData, 'JPEG', xPos, yPos, finalImgWidth, finalImgHeight);
            doc.save(filename);

        } catch (error) {
            console.error("PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("PDFë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        } finally {
            loadingSpinner.style.display = 'none';
            modalActions.style.display = 'block';
            closePreviewModal();
        }
    }


    // --- ì•± ì´ˆê¸°í™” ---
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            await DBManager.init();
            AppState.init();
            UIRenderer.init();
            UIRenderer.render();
        } catch (error) {
            console.error("ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
            document.body.innerHTML = '<div class="p-8 text-center text-red-600">ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ê°€ IndexedDBë¥¼ ì§€ì›í•˜ì§€ ì•Šê±°ë‚˜ ë¹„ê³µê°œ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
        }
    });
  </script>
</body>
</html>


