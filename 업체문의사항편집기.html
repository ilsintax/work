<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel 데이터 변환기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script
    src="https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"
    onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js'">
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .preview-table { border-collapse: collapse; width: 100%; font-size: .8rem; }
    .preview-table th, .preview-table td {
      border: 1px solid #e2e8f0; padding: .375rem .5rem; text-align: left;
      white-space: nowrap; min-width: 20px;
    }
    .preview-table th { background: #f8fafc; font-weight: 600; }
    .selectable:hover { background: #f0f9ff; cursor: pointer; }
    .highlighted { background: #bae6fd !important; }
    #prompt-area { display: none; margin-bottom: .5rem; padding: .75rem; background: #e0f2fe;
      border-left: 4px solid #3b82f6; color: #0369a1; border-radius: .375rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="container mx-auto p-4 max-w-4xl space-y-6">
    <header class="text-center mb-4">
      <h1 class="text-2xl font-bold">거래처 문의사항 엑셀 내용 변환</h1> <h1 class="text-xs">made by 세무법인일신</h1>
      <p class="text-slate-600">엑셀 파일 업로드 후 지정된 형식으로 변환합니다.</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block mb-1 font-medium">차변제목변경</label>
        <input id="debit-label" type="text"
               placeholder="예: 매출처 - 세금계산서발행(또는 환불/출금)"
               class="w-full p-2 border rounded"/>
      </div>
      <div class="space-y-1 text-sm text-slate-600">
        <p class="font-semibold">차변 설명 예시:</p>
        <ul class="list-disc list-inside">
          <li>매출처 – 세금계산서발행(또는 환불/출금)</li>
          <li>매입처 – 출금(또는 매출세금계산서 상계)</li>
          <li>나중에정리 – 통장 출금내역</li>
        </ul>
      </div>

      <div>
        <label class="block mb-1 font-medium">대변제목변경</label>
        <input id="credit-label" type="text"
               placeholder="예: 매출처 - 입금(또는 매입세금계산서 상계)"
               class="w-full p-2 border rounded"/>
      </div>
      <div class="space-y-1 text-sm text-slate-600">
        <p class="font-semibold">대변 설명 예시:</p>
        <ul class="list-disc list-inside">
          <li>매출처 – 입금(또는 매입세금계산서 상계)</li>
          <li>매입처 – 세금계산서수취(또는 환불/입금)</li>
          <li>나중에정리 – 통장 입금내역</li>
        </ul>
      </div>
    </div>

    <div id="option-container" class="mb-4">
      <label for="option-select" class="block mb-1 font-medium">업체에게 회신방법 예시 제공여부</label>
      <select id="option-select"
              class="w-full p-2 border rounded bg-white cursor-pointer">
        <option value="none">기재하지 않음</option>
        <option value="1">매출처</option>
        <option value="2">매입처</option>
        <option value="3">나중에정리</option>
      </select>
    </div>

    <div id="option-detail"
         class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 text-sm text-blue-800 hidden">
    </div>

    <div>
      <label for="file-input"
             class="flex items-center justify-center h-40 border-2 border-dashed rounded bg-white cursor-pointer hover:bg-slate-50 transition">
        <span class="text-slate-500">클릭하여 XLSX/XLS 파일 업로드</span>
        <input id="file-input" type="file" accept=".xlsx,.xls" class="hidden"/>
      </label>
      <p id="file-name" class="mt-2 text-sm text-slate-500"></p>
    </div>

    <div id="preview-section" class="hidden space-y-2">
      <div id="prompt-area"><span id="prompt-text"></span></div>
      <button id="edit-btn" class="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50" disabled>
        편집 시작
      </button>
      <div id="preview-container" class="overflow-x-auto border rounded bg-white"></div>
    </div>

    <div id="download-section" class="hidden text-center">
      <a id="download-btn" href="#" class="px-6 py-3 bg-green-600 text-white rounded">
        엑셀 다운로드
      </a>
    </div>
  </div>

  <script>
    function checkXLSX() {
      if (typeof XLSX === 'undefined') {
        alert('XLSX 라이브러리 로드 실패');
        return false;
      }
      return true;
    }

    const fileInput   = document.getElementById('file-input');
    const fileNameEl  = document.getElementById('file-name');
    const debitInput  = document.getElementById('debit-label');
    const creditInput = document.getElementById('credit-label');
    const previewSec  = document.getElementById('preview-section');
    const previewCont = document.getElementById('preview-container');
    const promptArea  = document.getElementById('prompt-area');
    const promptText  = document.getElementById('prompt-text');
    const editBtn     = document.getElementById('edit-btn');
    const downloadSec = document.getElementById('download-section');
    const downloadBtn = document.getElementById('download-btn');

    let workbook, selections = {}, step = 0, wizardActive = false, debitLabel, creditLabel;

    const prompts = [
      { key:'clientName', text:'1/7: 거래처명이 있는 셀을 선택하세요.', type:'cell' },
      { key:'headerRow',  text:'2/7: 제목 행을 선택하세요.',             type:'row'  },
      { key:'dateCol',    text:'3/7: \'일자\'가 있는 열을 선택하세요.',  type:'col'  },
      { key:'descCol',    text:'4/7: \'적요\'가 있는 열을 선택하세요.',  type:'col'  },
      { key:'debitCol',   text:'5/7: \'차변\'이 있는 열을 선택하세요.',  type:'col'  },
      { key:'creditCol',  text:'6/7: \'대변\'이 있는 열을 선택하세요.',  type:'col'  },
      { key:'balanceCol', text:'7/7: \'잔액\'이 있는 열을 선택하세요.',  type:'col'  }
    ];

    function getSheetData(ws, fillMerges = false) {
      if (!ws['!ref']) return [];
      const range = XLSX.utils.decode_range(ws['!ref']);
      const data = Array.from({ length: range.e.r + 1 }, () =>
        Array(range.e.c + 1).fill(null)
      );
      for (let addr in ws) {
        if (addr[0] === '!') continue;
        const { r, c } = XLSX.utils.decode_cell(addr);
        data[r][c] = ws[addr].w ?? ws[addr].v;
      }
      if (fillMerges && ws['!merges']) {
        ws['!merges'].forEach(m => {
          const v = data[m.s.r][m.s.c];
          for (let R = m.s.r; R <= m.e.r; R++)
            for (let C = m.s.c; C <= m.e.c; C++)
              data[R][C] = v;
        });
      }
      return data;
    }

    fileInput.addEventListener('change', e => {
      if (!checkXLSX()) return;
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
        renderPreview(workbook.Sheets[workbook.SheetNames[0]]);
        fileNameEl.textContent = `선택됨: ${file.name}`;
        previewSec.classList.remove('hidden');
        editBtn.disabled = false;
      };
      reader.readAsArrayBuffer(file);
    });

    function renderPreview(ws) {
      const data = getSheetData(ws);
      let html = '<table class="preview-table">';
      data.forEach(row => {
        html += '<tr>';
        row.forEach(c => html += `<td>${c ?? ''}</td>`);
        html += '</tr>';
      });
      html += '</table>';
      previewCont.innerHTML = html;
      previewCont.querySelectorAll('td').forEach(td =>
        td.addEventListener('click', handleCellClick)
      );
    }

    editBtn.addEventListener('click', () => {
      debitLabel  = debitInput.value.trim()  || debitInput.placeholder;
      creditLabel = creditInput.value.trim() || creditInput.placeholder;
      wizardActive = true;
      step         = 0;
      selections   = {};
      editBtn.disabled   = true;
      editBtn.textContent = '선택 중...';
      promptArea.style.display = 'block';
      promptText.textContent   = prompts[0].text;
      previewCont.querySelectorAll('td').forEach(td =>
        td.classList.add('selectable')
      );
    });

    function handleCellClick(evt) {
      if (!wizardActive) return;
      const td = evt.currentTarget;
      const r  = td.parentElement.rowIndex;
      const c  = td.cellIndex;
      const p  = prompts[step];
      if (p.type === 'cell') {
        selections[p.key] = { row: r, col: c };
        td.classList.add('highlighted');
      } else if (p.type === 'row') {
        selections[p.key] = { row: r };
        td.parentElement.querySelectorAll('td').forEach(x => x.classList.add('highlighted'));
      } else {
        selections[p.key] = { col: c };
        previewCont.querySelectorAll('tr').forEach(tr => {
          const cell = tr.children[c];
          if (cell) cell.classList.add('highlighted');
        });
      }
      step++;
      if (step < prompts.length) {
        promptText.textContent = prompts[step].text;
      } else {
        wizardActive = false;
        promptArea.style.display = 'none';
        processWorkbook();
      }
    }

    function parseDateString(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return null;
        let match = dateStr.match(/^(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})$/);
        if (match) {
            return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
        }
        match = dateStr.match(/^(\d{1,2})[-/.](\d{1,2})$/);
        if (match) {
            const currentYear = new Date().getFullYear();
            return new Date(currentYear, parseInt(match[1]) - 1, parseInt(match[2]));
        }
        const parsedDate = new Date(dateStr);
        if (!isNaN(parsedDate.getTime())) {
            return parsedDate;
        }
        return null;
    }


    function processWorkbook() {
      if (!checkXLSX()) return;
      const newWB = XLSX.utils.book_new();

      workbook.SheetNames.forEach(sheetName => {
        const orig = workbook.Sheets[sheetName];
        const data = getSheetData(orig, true);
        const client = data[selections.clientName.row][selections.clientName.col];
        const startR = selections.headerRow.row + 1;

        const out = [[client], [
          '일자', debitLabel, creditLabel,
          '외상대 잔액', '세금계산서 및 통장 적요',
          '담당자 문의사항', '업체 답변기재'
        ]];

        for (let i = startR; i < data.length; i++) {
          const row = data[i];
          if (!row) continue;
          const dv = row[selections.dateCol.col];
          const bv = row[selections.balanceCol.col];
          if (!((dv || '').toString().trim() || bv || '').toString().trim()) continue;
          if (typeof dv === 'string' && /[가-힣A-Za-z]/.test(dv)) break;

          const desc = row[selections.descCol.col];
          const dr   = parseFloat((row[selections.debitCol.col] || '').toString().replace(/,/g, '')) || 0;
          const cr   = parseFloat((row[selections.creditCol.col] || '').toString().replace(/,/g, '')) || 0;

          let fd = dv;
          const oc = orig[XLSX.utils.encode_cell({ r: i, c: selections.dateCol.col })];
          
          if (oc && oc.t === 'n') {
            const jd = XLSX.SSF.parse_date_code(oc.v);
            if (jd) fd = new Date(jd.y, jd.m - 1, jd.d);
          } else if (typeof dv === 'string') {
            const parsed = parseDateString(dv);
            if (parsed) {
              fd = parsed;
            }
          }

          out.push([fd, dr, cr, null, desc, '', '']);
        }

        const ws2 = XLSX.utils.aoa_to_sheet(out);

        const headerStyle = {
          font: { bold: true },
          fill: { patternType: 'solid', fgColor: { rgb: 'FFE5E7EB' } },
          alignment: { horizontal: 'center' }
        };
        const rightAlign = { alignment: { horizontal: 'right' } };
        const numFmt = { numFmt: '#,##0' };
        const dateFmt = { numFmt: 'yyyy-mm-dd' };
        const monthColors = [
          { fill: { patternType: 'solid', fgColor: { rgb: 'FFE3F2FD' } } },
          { fill: { patternType: 'solid', fgColor: { rgb: 'FFE8F5E8' } } },
          { fill: { patternType: 'solid', fgColor: { rgb: 'FFFFF3E0' } } }
        ];

        let lastMonth = -1, colorIndex = 0;

        for (let r = 0; r < out.length; r++) {
          const excelRow = r + 1;
          if (excelRow === 2) {
            for (let c = 0; c < 7; c++) {
              const addr = XLSX.utils.encode_cell({ r, c });
              if (!ws2[addr]) ws2[addr] = { v: out[r][c] };
              ws2[addr].s = headerStyle;
            }
            continue;
          }

          if (excelRow >= 3) {
            let currentStyle = {};
            const dateVal = out[r][0];
            
            if (dateVal instanceof Date) {
              const month = dateVal.getMonth();
              if (lastMonth !== -1 && month !== lastMonth) {
                colorIndex = (colorIndex + 1) % monthColors.length;
              }
              lastMonth = month;
              currentStyle = monthColors[colorIndex];
            } else {
                currentStyle = monthColors[colorIndex];
            }

            for (let c = 0; c < 7; c++) {
              const addr = XLSX.utils.encode_cell({ r, c });
              if (!ws2[addr]) ws2[addr] = {};
              const cell = ws2[addr];
              const s = {};
              if (currentStyle.fill) s.fill = currentStyle.fill;
              if (c === 0 && cell.v) {
                s.numFmt = dateFmt.numFmt;
              } else if (c >= 1 && c <= 3) {
                s.alignment = rightAlign.alignment;
                s.numFmt = numFmt.numFmt;
              }
              cell.s = s;
            }
            const balanceAddr = `D${excelRow}`;
            ws2[balanceAddr].f = excelRow === 3 ? `B3-C3` : `D${excelRow - 1}+B${excelRow}-C${excelRow}`;
          }
        }

        ws2['!cols'] = [
          { wch: 12 }, { wch: 30 }, { wch: 30 },
          { wch: 30 }, { wch: 40 }, { wch: 30 }, { wch: 30 }
        ];

        const selVal = document.getElementById('option-select').value;
        if (selVal !== "none") {
          const headerFont = { name:'Inter', bold:true, sz:12, color:{ rgb:'FF1E40AF' } };
          const textFont   = { name:'Inter', bold:false, sz:11, color:{ rgb:'FF1E40AF' } };
          const fillStyle  = { patternType:'solid', fgColor:{ rgb:'FFEFF6FF' } };
          const wrapStyle  = { alignment:{ wrapText:true, vertical:'top', horizontal:'left' } };
          
          let maxHRow = 0;

          function setCellInH(r, value, font) {
            maxHRow = Math.max(maxHRow, r);
            const addr = XLSX.utils.encode_cell({ r, c: 7 });
            ws2[addr] = { v:value, t:'s', s:{ font, fill:fillStyle, ...wrapStyle } };
          }

          if (selVal === "1") {
            setCellInH(1, '* 아래의 사항을 참고하셔서 입력 부탁드립니다.', headerFont);
            setCellInH(2, '외상대 잔액설명', headerFont);
            setCellInH(3, '- 잔액기준 플러스 금액: 세금계산서 발행보다 받은금액이 적은경우(은행 거래 내역 기준)', textFont);
            setCellInH(4, '- 잔액기준 마이너스 금액: 세금계산서 발행보다 받은금액이 많은경우(세금계산서 미발행)', textFont);
            setCellInH(5, '', textFont);
            setCellInH(6, '기재참고사항', headerFont);
            setCellInH(7, '- 외상대 기입금 : 예) 1.15일 신한 015통장 입금', textFont);
            setCellInH(8, '- 외상대와 상계 : 예) A거래처 외상매입금과 상계', textFont);
            setCellInH(9, '- 월말잔액 : 예) 월말잔액 맞음', textFont);
            setCellInH(10, '- 세금계산서 추후발행(잔액 마이너스) : 예) 12월 이후 발급예정', textFont);
            setCellInH(11, '- 잔액상계 : 예) 대표 가수금처리', textFont);
            setCellInH(12, '- 확인중: 확인 후 회신', textFont);
          } else if (selVal === "2") {
            setCellInH(1, '* 아래의 사항을 참고하셔서 입력 부탁드립니다.', headerFont);
            setCellInH(2, '외상대 잔액설명', headerFont);
            setCellInH(3, '- 잔액 기준 플러스 금액: 통장에서 송금한 금액보다 세금계산서 수취가 많은 경우(외상대 미지급-통장기준)', textFont);
            setCellInH(4, '- 잔액 기준 마이너스 금액: 통장에서 송금한 금액이 세금계산서 수취보다 많은 경우(증빙 미수취)', textFont);
            setCellInH(5, '', textFont);
            setCellInH(6, '기재참고사항', headerFont);
            setCellInH(7, '- 외상대 기인출: 예) 1.15일 신한 015통장 인출, 현금지급', textFont);
            setCellInH(8, '- 외상대와 상계: 예) A거래처 외상매출금과 상계', textFont);
            setCellInH(9, '- 월말잔액: 예) 월말잔액 맞음', textFont);
            setCellInH(10, '- 세금계산서 추후수취: 예) 12월 이후 수취예정, 증빙첨부', textFont);
            setCellInH(11, '- 잔액상계: 예) 대표 가지급금처리, 무증빙비용(가산세)', textFont);
            setCellInH(12, '- 증빙첨부: 메일로 증빙을 첨부하여 회신', textFont);
            setCellInH(13, '- 확인중: 확인 후 회신', textFont);
          } else if (selVal === "3") {
            setCellInH(1, '* 아래의 사항을 참고하셔서 입력 부탁드립니다.', headerFont);
            setCellInH(2, '기재참고사항', headerFont);
            setCellInH(3, '- 세금계산서 기수취: 예) 1.15일 ABC상회 매입세금계산서 수취', textFont);
            setCellInH(4, '- 세금계산서 기발행: 예) 1.15일 ABC상회 매출세금계산서 발급', textFont);
            setCellInH(5, '- 세금계산서 추후수취: 예) 7월에 ABC상회 수취예정', textFont);
            setCellInH(6, '- 세금계산서 추후발행: 예) 7월에 ABC상회 발급예정', textFont);
            setCellInH(7, '- 증빙첨부: 증빙 첨부 회신', textFont);
            setCellInH(8, '- 인건비: 예) 일용직/근로자/기타소득/신고예정', textFont);
            setCellInH(9, '- 잔액상계: 예) 대표 가지급금처리, 비용처리 요망', textFont);
            setCellInH(10, '- 확인중: 확인 후 회신', textFont);
          }
          
          ws2['!cols'][7] = { wch: 110 };
          const range = XLSX.utils.decode_range(ws2['!ref']);
          range.e.c = Math.max(range.e.c, 7);
          range.e.r = Math.max(range.e.r, maxHRow);
          ws2['!ref'] = XLSX.utils.encode_range(range);
        }

        XLSX.utils.book_append_sheet(newWB, ws2, sheetName);
      });

      const buf  = XLSX.write(newWB, { bookType:'xlsx', type:'array', cellStyles:true });
      const blob = new Blob([buf], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      if (downloadBtn.href.startsWith('blob:')) URL.revokeObjectURL(downloadBtn.href);
      downloadBtn.href     = URL.createObjectURL(blob);
      downloadBtn.download = 'ilsintax.xlsx';
      downloadSec.classList.remove('hidden');
      previewSec.classList.add('hidden');
      editBtn.textContent = '편집 시작';
      editBtn.disabled    = false;
    }

    const optionDetails = {
      none: '기재하지 않습니다.',
      1: `
외상대 잔액설명
- 잔액기준 플러스 금액: 세금계산서 발행보다 받은금액이 적은경우(은행 거래 내역 기준)
- 잔액기준 마이너스 금액: 세금계산서 발행보다 받은금액이 많은경우(세금계산서 미발행)

기재참고사항
- 외상대 기입금 : 예) 1.15일 신한 015통장 입금
- 외상대와 상계 : 예) A거래처 외상매입금과 상계
- 월말잔액 : 예) 월말잔액 맞음
- 세금계산서 추후발행(잔액 마이너스) : 예) 12월 이후 발급예정
- 잔액상계 : 예) 대표 가수금처리
- 확인중: 확인 후 회신
`.trim(),
      2: `
외상대 잔액설명
- 잔액 기준 플러스 금액: 통장에서 송금한 금액보다 세금계산서 수취가 많은 경우(외상대 미지급-통장기준)
- 잔액 기준 마이너스 금액: 통장에서 송금한 금액이 세금계산서 수취보다 많은 경우(증빙 미수취)

기재참고사항
- 외상대 기인출: 예) 1.15일 신한 015통장 인출, 현금지급
- 외상대와 상계: 예) A거래처 외상매출금과 상계
- 월말잔액: 예) 월말잔액 맞음
- 세금계산서 추후수취: 예) 12월 이후 수취예정, 증빙첨부
- 잔액상계: 예) 대표 가지급금처리, 무증빙비용(가산세)
- 증빙첨부: 메일로 증빙을 첨부하여 회신
- 확인중: 확인 후 회신
`.trim(),
      3: `
기재참고사항
- 세금계산서 기수취: 예) 1.15일 ABC상회 매입세금계산서 수취
- 세금계산서 기발행: 예) 1.15일 ABC상회 매출세금계산서 발급
- 세금계산서 추후수취: 예) 7월에 ABC상회 수취예정
- 세금계산서 추후발행: 예) 7월에 ABC상회 발급예정
- 증빙첨부: 증빙 첨부 회신
- 인건비: 예) 일용직/근로자/기타소득/신고예정
- 잔액상계: 예) 대표 가지급금처리, 비용처리 요망
- 확인중: 확인 후 회신
`.trim()
    };
    const selectEl = document.getElementById('option-select');
    const detailEl = document.getElementById('option-detail');
    selectEl.addEventListener('change', () => {
      const text = optionDetails[selectEl.value] || '';
      detailEl.innerHTML = text.replace(/\n/g, '<br>');
      detailEl.classList.toggle('hidden', !text);
    });

    window.addEventListener('load', () => setTimeout(checkXLSX, 1000));
  </script>
</body>
</html>
